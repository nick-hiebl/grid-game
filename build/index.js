"use strict";(()=>{var mt=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),B=1280,pt=720,U=B,N=pt,k=3;var w=(o,t,e)=>Math.min(e,Math.max(o,t)),G=o=>o>0?1:o===0?0:-1;var a=class{constructor(t,e){this.x=t,this.y=e}add(t){return this.x+=t.x,this.y+=t.y,this}multiply(t){return this.x*=t,this.y*=t,this}copy(){return new a(this.x,this.y)}get magnitude(){return Math.hypot(this.x,this.y)}static add(t,e){return new a(t.x+e.x,t.y+e.y)}static diff(t,e){return new a(t.x-e.x,t.y-e.y)}static scale(t,e){return new a(t.x*e,t.y*e)}static sqrDist(t,e){let i=t.x-e.x,r=t.y-e.y;return i*i+r*r}static manhattanDist(t,e){return Math.max(Math.abs(t.x-e.x),Math.abs(t.y-e.y))}static dist(t,e){return Math.hypot(t.x-e.x,t.y-e.y)}static lerp(t,e,i){return new a(t.x*(1-i)+e.x*i,t.y*(1-i)+e.y*i)}};var u=class{constructor(t,e){this.position=t,this.radius=e}intersectsCircle(t){let e=this.radius+t.radius;return a.sqrDist(this.position,t.position)<e*e}intersectsVector(t){return a.sqrDist(this.position,t)<this.radius*this.radius}intersectsRectangle(t){let e=w(this.position.x,t.x1,t.x2),i=w(this.position.y,t.y1,t.y2);return this.intersectsVector(new a(e,i))}isKissingBelow(t){return this.position.y+this.radius===t.y1&&t.x1<=this.position.x&&this.position.x<=t.x2}draw(t){t.fillEllipse(this.position.x,this.position.y,this.radius,this.radius)}},h=class{constructor(t,e,i,r){this.x1=t,this.y1=e,this.x2=i,this.y2=r}intersectsPoint(t){return this.x1<=t.x&&t.x<=this.x2&&this.y1<=t.y&&t.y<=this.y2}get width(){return this.x2-this.x1}get height(){return this.y2-this.y1}get midpoint(){return new a((this.x1+this.x2)/2,(this.y1+this.y2)/2)}xInRange(t){return this.x1<=t&&t<this.x2}yInRange(t){return this.y1<=t&&t<this.y2}intersectsRectangle(t){return t.x1<=this.x2&&this.x1<=t.x2&&t.y1<=this.y2&&this.y1<=t.y2}uncollideCircle(t){let e=w(t.position.x,this.x1,this.x2),i=w(t.position.y,this.y1,this.y2),r=new a(e,i),n=a.diff(t.position,r),s=n.magnitude||1;if(s>=t.radius){let l=a.diff(t.position,this.midpoint),c=this.width/2-Math.abs(l.x),d=this.height/2-Math.abs(l.y);return c<d?new a((c+t.radius)*G(l.x),0):new a(0,(d+t.radius)*G(l.y))}return a.scale(n,(t.radius-s)/s)}draw(t){t.fillRect(this.x1,this.y1,this.width,this.height)}stroke(t,e=0){t.strokeRectInset(this.x1,this.y1,this.width,this.height,e)}inset(t){return new h(this.x1+t,this.y1+t,this.x2-t,this.y2-t)}static widthForm(t,e,i,r){return new h(t,e,t+i,e+r)}static centerForm(t,e,i,r){return new h(t-i,e-r,t+i,e+r)}static aroundPoint(t,e,i){return new h(t.x-e,t.y-i,t.x+e,t.y+i)}static merged(t){let[e,i,r,n]=t.reduce(([s,l,c,d],m)=>[Math.min(m.x1,s),Math.min(m.y1,l),Math.max(m.x2,c),Math.max(m.y2,d)],[1/0,1/0,-1/0,-1/0]);return new h(e,i,r,n)}};var $=new Image;$.src="./img/tileset.png";var _=new Image;_.src="./img/entity-set.png";var H={isSolid:o=>o===1,isGrounding:o=>o===2||H.isSolid(o)};var K=class{constructor(t){this.id=t}onStart(t){}update(t,e,i){}draw(t){}};var Ce=!1,A=class extends K{constructor(e,i,r,n=[]){super(e);this.position=i,this.triggerArea=r,this.prerequisites=n,this.prereqsActive=n.length===0,this.prereqEntities=[],this.isEnabled=!1,this.isAreaActive=!1,this.connectionPoint=this.position,this.outputPoint=this.position}onStart(e){this.findPrerequisites(e)}findPrerequisites(e){return this.prereqEntities.length===this.prerequisites.length?this.prereqEntities:(this.prereqEntities=e.interactibles.filter(i=>this.prerequisites.includes(i.id)),this.prereqEntities)}update(e,i,r){var n;this.prereqsActive=this.prereqEntities.every(s=>s.isEnabled),this.isAreaActive=!!(this.prereqsActive&&((n=this.triggerArea)==null?void 0:n.intersectsPoint(e.position)))}draw(e){var r;let i=e.dynamicWorldCanvas;Ce&&(i.setColorRGB(255,255,255),i.setLineWidth(.1),i.setLineDash([.2,.2]),(r=this.triggerArea)==null||r.stroke(i)),e.behindGroundCanvas.setLineWidth(.2);for(let n of this.prereqEntities){e.behindGroundCanvas.setColor(n.isEnabled?"white":"black");let s=a.manhattanDist(n.outputPoint,this.connectionPoint),l=a.lerp(n.outputPoint,this.connectionPoint,.5),c=a.add(l,new a(0,s*.3));e.behindGroundCanvas.drawQuadratic(n.outputPoint.x,n.outputPoint.y,this.connectionPoint.x,this.connectionPoint.y,c.x,c.y)}}onInteract(){}};var ye=.8,ft=class extends A{constructor(e,i,r,n=4){super(e,i,void 0,r);this.connectionPoint=a.add(i,new a(0,-1.8)),this.headCollider=h.centerForm(this.position.x,this.position.y-1.8,.6,.4),this.doorCollider=h.widthForm(this.position.x-.5,this.position.y-2,1,n),this.fullHeight=n}onStart(e){super.onStart(e),e.addWithoutDuplicate({type:1,rect:this.headCollider}),e.addWithoutDuplicate({type:1,rect:this.doorCollider})}update(e,i,r){super.update(e,i,r);let n=this.fullHeight*i/ye*(this.prereqsActive?-1:1);this.doorCollider.y2=w(this.doorCollider.y2+n,this.doorCollider.y1,this.doorCollider.y1+this.fullHeight)}draw(e){super.draw(e);let i=e.dynamicWorldCanvas,r=this.doorCollider.height;r>0&&(i.setColor("black"),i.fillRect(this.position.x-.5,this.position.y-2,1,r),i.drawImage(_,120,Math.max(40-10*r,20)-10,40,Math.min(10*r,20),this.position.x-2,this.position.y-2+Math.max(r-2,0),4,Math.min(r,2))),i.drawImage(_,this.prereqsActive?140:128,0,12,6,this.position.x-6/10,this.position.y-2,12/10,6/10)}};var se=.4,oe=.25,E=7/9*N,q="#00ff62c8",gt="#0096ffc8",wt=[[new u(new a(0,0),.33)],[new u(new a(0,0),.33)],[new u(new a(0,.4),.33),new u(new a(0,-.4),.33)],[new u(new a(-.42,.4),.33),new u(new a(.42,.4),.33),new u(new a(0,-.4),.33)],[new u(new a(.4,.4),.33),new u(new a(.4,-.4),.33),new u(new a(-.4,.4),.33),new u(new a(-.4,-.4),.33)],[new u(new a(0,.3),.28),new u(new a(.64,.3),.28),new u(new a(-.64,.3),.28),new u(new a(-.32,-.3),.28),new u(new a(.32,-.3),.28)],[new u(new a(0,.6),.28),new u(new a(.64,.6),.28),new u(new a(-.64,.6),.28),new u(new a(-.32,0),.28),new u(new a(.32,0),.28),new u(new a(0,-.6),.28)],[new u(new a(0,0),.28),new u(new a(.64,0),.28),new u(new a(-.64,0),.28),new u(new a(-.32,-.6),.28),new u(new a(.32,-.6),.28),new u(new a(-.32,.6),.28),new u(new a(.32,.6),.28)],[new u(new a(0,.6),.28),new u(new a(.64,.6),.28),new u(new a(-.64,.6),.28),new u(new a(-.32,0),.28),new u(new a(.32,0),.28),new u(new a(0,-.6),.28),new u(new a(.64,-.6),.28),new u(new a(-.64,-.6),.28)]],ae=[[h.centerForm(0,0,.33,.33)],[h.centerForm(0,0,.33,.33)],[h.centerForm(0,-.4,.33,.33),h.centerForm(0,.4,.33,.33)],[h.centerForm(0,-.4,.33,.33),h.centerForm(-.4,.4,.33,.33),h.centerForm(.4,.4,.33,.33)],[h.centerForm(-.4,-.4,.33,.33),h.centerForm(.4,-.4,.33,.33),h.centerForm(-.4,.4,.33,.33),h.centerForm(.4,.4,.33,.33)]];var Yt={},ve=(o,t)=>`${o}-${t}`,Ee=(o,t)=>{let e=Math.max(o,t),i=.7,r=.5,n=Math.floor(E/(e+i+r)),s=Math.floor(n*r),l=E-n*e-s,c=l+s+o*n,d=l+s+t*n,m=Math.max((d-c)/2,0),P=Math.max((c-d)/2,0),f=[[P,P+s]],I=P+s;for(let C=0;C<t;C++)f.push([I,I+n]),I+=n;f.push([I,I+l]);let Z=[[m,m+l]],V=m+l;for(let C=0;C<o;C++)Z.push([V,V+n]),V+=n;Z.push([V,V+s]);let O=[];for(let[C,R]of Z){let dt=[];for(let[y,v]of f)dt.push(new h(y,C,v,R));O.push(dt)}return O},xe=(o,t)=>{let e=ve(o,t);return e in Yt||(Yt[e]=Ee(o,t)),Yt[e]},le=(o,t)=>{let e=xe(o,t);return(i,r)=>e[i==="end"?o+1:i+1][r==="end"?t+1:r+1]};var Ie=.4,bt=class{constructor(t,e,i,r,n={}){this.id=t,this.openCloseStatus=0,this.isOpen=!1,this.rows=e,this.cols=i,this.validator=r,this.isSolved=!1,this.hasBeenSolvedEver=!1;let s=0;this.positionGetter=le(e,i),this.grid=[];for(let l=0;l<e;l++){let c=[];for(let d=0;d<i;d++){s++;let m={row:l,column:d,id:s};c.push(m)}this.grid.push(c)}if(n.combinedGroups)for(let l of n.combinedGroups){s++;let c=s;l.forEach(([d,m])=>{this.grid[d][m].id=c})}this.values={},this.cellMap={};for(let l of this.grid.flat())this.values[l.id]=null,this.cellMap[l.id]=l.id in this.cellMap?this.cellMap[l.id].concat([l]):[l];this.elements=[],this.miniElements=[];for(let l in this.cellMap){let c=this.cellMap[l];this.elements.push({row:c[0].row,col:c[0].column,shape:h.merged(c.map(({row:d,column:m})=>this.positionGetter(d,m))).inset(k),isHovered:!1}),this.miniElements.push({row:c[0].row,col:c[0].column,shape:h.merged(c.map(({row:d,column:m})=>h.widthForm(m,d,1,1))),isHovered:!1})}}open(){this.isOpen||(this.isOpen=!0,this.openCloseStatus=0)}close(){this.isOpen=!1}uiPosition(){let t=Math.pow(1-this.openCloseStatus,2),e=new a(0,N*t),i=new a((U-E)/2,(N-E)/2);return a.add(e,i)}draw(t){let e=t.uiCanvas;if(e.clear(),this.openCloseStatus===0)return;let i=this.uiPosition();e.translate(i.x,i.y),e.setColor(this.isSolved?q:gt),e.fillRect(0,0,E,E),e.setColor("#222222"),e.fillRect(E/4,E,E/2,E),e.setLineWidth(k*8),e.setLineDash([]),e.strokeRectInset(0,0,E,E,-k*4),e.setColor("#ffffff64"),e.setLineWidth(k),e.strokeRectInset(0,0,E,E,k/2);for(let r of this.elements){r.isHovered?e.setColor("white"):e.setColor("#ffffff64"),e.setLineDash([]),r.shape.stroke(e,k/2);let n=this.getElementState(r),s=r.shape.midpoint,l=Math.min(r.shape.width,r.shape.height)*Ie;n?(e.setColor("white"),e.fillEllipse(s.x,s.y,l,l)):n===!1&&(e.setColor("#ffffff64"),e.setLineDash([k*2,k*2]),e.strokeEllipse(s.x,s.y,l,l))}this.validator.draw(e,this.positionGetter),e.translate(-i.x,-i.y)}getRowColState(t,e){let i=this.grid[t][e];return this.values[i.id]}getElementState(t){return this.getRowColState(t.row,t.col)}setElementState(t,e){let i=this.grid[t.row][t.col];e!==this.values[i.id]&&(this.values[i.id]=e,this.onStateChange())}resolveClick(t,e,i){this.dragKind!==void 0&&(this.dragKind==="left"&&!e?(this.dragKind=void 0,this.dragState=void 0):this.dragKind==="right"&&!i&&(this.dragKind=void 0,this.dragState=void 0),this.dragKind==="left"?(this.dragState===void 0&&(this.getElementState(t)!==!0?this.dragState="enabling":this.dragState="emptying"),this.dragState==="enabling"?this.setElementState(t,!0):this.dragState==="emptying"&&this.setElementState(t,null)):this.dragKind==="right"&&(this.dragState===void 0&&(this.getElementState(t)!==!1?this.dragState="disabling":this.dragState="emptying"),this.dragState==="disabling"?this.setElementState(t,!1):this.dragState==="emptying"&&this.setElementState(t,null)))}findPositionElement(t){let e;for(let i of this.elements)i.isHovered=i.shape.intersectsPoint(t),i.isHovered&&(e=i);return e}update(t,e){if(this.isOpen&&this.openCloseStatus<1?this.openCloseStatus+=t/se:!this.isOpen&&this.openCloseStatus>0&&(this.openCloseStatus-=t/oe),this.openCloseStatus=w(this.openCloseStatus,0,1),e){let i=a.diff(e.mousePosition,this.uiPosition()),r=this.findPositionElement(i);r&&this.resolveClick(r,e.isLeftClicking(),e.isRightClicking())}else this.dragState=void 0}onStateChange(){this.isSolved=this.validator.isValid(this.grid,this.values),this.isSolved&&(this.hasBeenSolvedEver=!0)}onInput(t){if(t.isClick()){let e=t,i=a.diff(e.position,this.uiPosition());this.dragKind=e.isRightClick()?"right":"left",this.dragState=void 0;let r=this.findPositionElement(i);r&&this.resolveClick(r,this.dragKind==="left",this.dragKind==="right")}}};var Ct=class{constructor(t){this.validationItems=t}isValid(t,e){return this.validationItems.forEach(i=>{i.validate(t,e)}),this.validationItems.every(i=>i.isValid)}draw(t,...e){this.validationItems.forEach(i=>{i.draw(t,...e)})}},X=class{constructor(){this.isValid=!1}validate(t,e){}draw(t,...e){}};var yt=class extends X{constructor(e,i){super();this.row=e,this.column=i}},vt=class extends yt{constructor(e,i,r){super(e,i);this.mustBeOn=r,this.isValid=!r}validate(e,i){let r=e[this.row][this.column];this.isValid=!!i[r.id]==!!this.mustBeOn}draw(e,i){this.isValid?e.setColor("white"):e.setColor("red");let r=i(this.row,this.column),n=Math.min(r.width,r.height),s=new a(r.x2-n*.15,r.y1+n*.15);this.mustBeOn?e.fillEllipse(s.x,s.y,n*.1,n*.1):(e.setLineWidth(n*.05),e.strokeEllipse(s.x,s.y,n*.075,n*.075))}},Et=class extends yt{constructor(e,i,r){super(e,i);this.desiredCount=r,this.isValid=r===0,this.isCellColoured=!1}*iterateArea(e){for(let i=Math.max(this.row-1,0);i<=Math.min(this.row+1,e.length-1);i++)for(let r=Math.max(this.column-1,0);r<=Math.min(this.column+1,e[i].length-1);r++)yield[i,r]}validate(e,i){let r=0,n=new Set;for(let[s,l]of this.iterateArea(e)){let c=e[s][l];!!i[c.id]&&!n.has(c.id)&&(r++,n.add(c.id))}this.isValid=r===this.desiredCount,this.isCellColoured=!!i[e[this.row][this.column].id]}draw(e,i){this.isValid?e.setColor(this.isCellColoured?q:"white"):e.setColor("red");let r=i(this.row,this.column),n=Math.min(r.width,r.height)*.25,s=r.midpoint;for(let l of wt[this.desiredCount]){let c=a.add(s,a.scale(l.position,n));this.desiredCount===0?(e.setLineWidth(l.radius*n*.5),e.strokeEllipse(c.x,c.y,l.radius*n*.75,l.radius*n*.75)):e.fillEllipse(c.x,c.y,l.radius*n,l.radius*n)}}};var ce=o=>new a(-o.y,o.x),xt=class extends X{constructor(e,i){super();this.isRow=e,this.index=i,this.isValid=!1}getRelevantRow(e,i){let r=this.isRow?e[this.index]:e.map(s=>s[this.index]),[n]=r.reduce(([s,l],c)=>[c.id===l?s:s.concat([i[c.id]]),c.id],[[],-1]);return n}validateRow(e){throw new TypeError("Cannot validate as a generic EdgeValidationItem")}validate(e,i){let r=this.getRelevantRow(e,i);this.isValid=this.validateRow(r)}drawInCell(e,i,r,n){throw new TypeError("Cannot draw a generic EdgeValidationItem")}draw(e,i){if(this.isValid?e.setColor("white"):e.setColor("red"),this.isRow){let r=i(this.index,"end");this.drawInCell(e,r.midpoint,r.width/2,!0)}else{let r=i(-1,this.index);this.drawInCell(e,r.midpoint,r.height/2,!1)}}},Q=class extends xt{constructor(e,i,r){super(e,i);this.count=r,this.isValid=r===0}validateRow(e){return e.reduce((r,n)=>n?r+1:r,0)===this.count}drawInCell(e,i,r,n){let s=n?l=>new u(ce(l.position),l.radius):l=>l;for(let l of wt[this.count]){l=s(l);let c=a.add(i,a.scale(l.position,r));this.count===0?(e.setLineDash([]),e.setLineWidth(l.radius*r*.5),e.strokeEllipse(c.x,c.y,l.radius*r*.75,l.radius*r*.75)):e.fillEllipse(c.x,c.y,l.radius*r,l.radius*r)}}},j=class extends Q{validateRow(t){let[e]=t.reduce(([i,r],n)=>n&&!r?[i+1,!0]:[i,!!n],[0,!1]);return e===this.count}drawSquare(t,e,i){t.fillRect(e.x-i/2,e.y-i/2,i,i)}drawInCell(t,e,i,r){let n=s=>r?ce(s):s;for(let s of ae[this.count]){let l=a.add(e,a.scale(n(s.midpoint),i)),c=s.width*i;this.drawSquare(t,l,c)}}},tt=class extends j{constructor(t,e,i){super(t,e,i),this.isValid=i===1}validateRow(t){let[e]=t.reduce(([i,r],n)=>!n&&r?[i+1,!1]:[i,!!n],[0,!0]);return e===this.count}drawSquare(t,e,i){t.setLineDash([]),t.setLineWidth(i*.25),t.strokeRectInset(e.x,e.y,0,0,-i*.4)}},et=class extends xt{constructor(t,e){super(t,e),this.isValid=!0}validateRow(t){let e=0;for(let i of t)if(i?e+=1:e=0,e>=3)return!1;return!0}drawInCell(t,e,i,r){t.setLineWidth(i*.1),t.setLineDash([]),t.fillEllipse(e.x,e.y,.22*i,.22*i);let n=a.add(e,a.scale(r?new a(-.5,0):new a(0,.5),i));t.fillEllipse(n.x,n.y,.22*i,.22*i);let s=a.add(e,a.diff(e,n)),l=i*.22;t.drawLine(s.x-l,s.y-l,s.x+l,s.y+l),t.drawLine(s.x-l,s.y+l,s.x+l,s.y-l)}};var It=class{constructor(){this.validationItems=[]}addForcedCellValidator(t,e,i){return this.validationItems.push(new vt(t,e,i)),this}addCountAreaValidator(t,e,i){return this.validationItems.push(new Et(t,e,i)),this}addEdgeValidators(t,e,i=Q){t.forEach((r,n)=>{typeof r=="number"&&this.validationItems.push(new i(e,n,r))})}addColumnCounts(t){return this.addEdgeValidators(t,!1),this}addRowCounts(t){return this.addEdgeValidators(t,!0),this}addColumnGroups(t){return this.addEdgeValidators(t,!1,j),this}addRowGroups(t){return this.addEdgeValidators(t,!0,j),this}addColumnBlankGroups(t){return this.addEdgeValidators(t,!1,tt),this}addRowBlankGroups(t){return this.addEdgeValidators(t,!0,tt),this}addColumnNoTriple(t){t.forEach((e,i)=>{!e||this.validationItems.push(new et(!1,i))})}addRowNoTriple(t){t.forEach((e,i)=>{!e||this.validationItems.push(new et(!0,i))})}create(){return new Ct(this.validationItems)}};var he=(o,t)=>{let{rows:e,cols:i,config:r}=t,n=new It;return t.columnCounts&&n.addColumnCounts(t.columnCounts),t.rowCounts&&n.addRowCounts(t.rowCounts),t.columnGroups&&n.addColumnGroups(t.columnGroups),t.rowGroups&&n.addRowGroups(t.rowGroups),t.columnBlankGroups&&n.addColumnBlankGroups(t.columnBlankGroups),t.rowBlankGroups&&n.addRowBlankGroups(t.rowBlankGroups),t.columnNoTriple&&n.addColumnNoTriple(t.columnNoTriple),t.rowNoTriple&&n.addRowNoTriple(t.rowNoTriple),t.forcedCells&&t.forcedCells.forEach(s=>{n.addForcedCellValidator(s.row,s.col,s.on)}),t.countAreas&&t.countAreas.forEach(s=>{n.addCountAreaValidator(s.row,s.col,s.count)}),new bt(o,e,i,n.create(),r)};var ue={"intro-1":{rows:1,cols:1,columnCounts:[1],rowCounts:[1]},"intro-2":{rows:2,cols:1,columnCounts:[2],rowCounts:[1,1]},"intro-3":{rows:2,cols:2,columnCounts:[2,1],rowCounts:[1,2]},"intro-side":{rows:3,cols:3,columnCounts:[1,3,2],rowCounts:[1,2,3]},"intro-secret":{rows:2,cols:2,columnCounts:[1,1],rowCounts:[1,2],config:{combinedGroups:[[[0,0],[1,0]]]}},"hall-1":{rows:3,cols:3,columnCounts:[2,3,1],rowCounts:[2,3,1]},"hall-2":{rows:3,cols:3,columnCounts:[3,2,3],rowCounts:[3,2,3]},"hall-3":{rows:3,cols:4,columnCounts:[2,1,3,2],rowCounts:[3,4,1]},"hall-4":{rows:4,cols:4,columnCounts:[2,4,2,1],rowCounts:[4,1,1,3]},"hall-5":{rows:4,cols:4,columnCounts:[3,2,4,1],rowCounts:[2,4,1,3]},"hall-6":{rows:5,cols:5,columnCounts:[2,4,2,3,5],rowCounts:[1,3,5,5,2]},"obvious-secret":{rows:4,cols:5,columnCounts:[1,3,2,3,1],rowCounts:[2,0,5,3]}};function Le(o){if(o in ue)return he(o,ue[o]);throw new Error(`Cannot find puzzle with id: ${o}`)}var Jt=class{constructor(){this.puzzleMap={}}loadPuzzle(t){return Le(t)}getPuzzle(t){if(t in this.puzzleMap)return this.puzzleMap[t];let e=this.loadPuzzle(t);return this.puzzleMap[t]=e,e}},Lt=new Jt;var it=class{constructor(){}isExitEvent(){return!1}isOpenPuzzleEvent(){return!1}isClosePuzzleEvent(){return!1}},Pt=class extends it{constructor(e){super();this.exitTrigger=e}isExitEvent(){return!0}},Y=class extends it{constructor(e){super();this.puzzleId=e}isOpenPuzzleEvent(){return!0}},St=class extends it{constructor(e){super();this.puzzleId=e}isClosePuzzleEvent(){return!0}};var x=1,Rt=class extends A{constructor(e,i,r,n,s,l){super(e,i,r,n);this.puzzleId=s,this.puzzle=Lt.getPuzzle(s),this.connectionPoint=a.add(i,new a(0,1.2)),this.outputPoint=a.add(i,new a(l.isFlipped?-1:1,-1.15)),this.config=l}draw(e){super.draw(e);let i=e.dynamicWorldCanvas,r=1/10;i.setColorRGB(0,0,0),i.fillRect(this.position.x-x/2,this.position.y+x,x,1),i.setLineWidth(r),this.isAreaActive&&(i.setColorRGB(255,255,255,128),i.strokeRectInset(this.position.x,this.position.y,0,0,-x-r*1.5)),i.setColorRGB(0,0,0),i.strokeRectInset(this.position.x,this.position.y,0,0,-x-r/2);let n=this.config.isFlipped?-1:1;i.fillRect(this.position.x+n*(x-r)-2*r,this.position.y-x-4*r,4*r,4*r),this.puzzle.hasBeenSolvedEver&&(this.isEnabled=!0,i.setColor("white"),i.fillRect(this.position.x+n*(x-r)-r,this.position.y-x-3*r,r*2,r*2)),this.prereqsActive&&(i.setColor(this.puzzle.isSolved?q:gt),i.fillRect(this.position.x-x,this.position.y-x,x*2,x*2)),this.drawGrid(i)}drawGrid(e){let i=new a(this.position.x-x,this.position.y-x);e.translate(i.x,i.y),e.setColor("white");let r=this.puzzle.grid,n=x*2/(3*Math.max(r.length,r[0].length)+1),s=n*(3*r[0].length+1),l=n*(3*r.length+1),c=Math.max(0,(s-l)/2),d=Math.max(0,(l-s)/2);this.puzzle.miniElements.forEach(({row:m,col:P,shape:f})=>{this.puzzle.values[r[m][P].id]&&e.fillRect(d+n*(3*f.x1+1),c+n*(3*f.y1+1),n*(3*f.width-1),n*(3*f.height-1))}),e.translate(-i.x,-i.y)}onInteract(){return new Y(this.puzzleId)}};var _t=class extends A{constructor(t,e,i,r){super(t,e,i,r)}update(t,e,i){this.isEnabled?this.isAreaActive=!1:super.update(t,e,i)}draw(t){super.draw(t);let e=t.dynamicWorldCanvas,i=1/10;this.isAreaActive&&(e.setColorRGB(255,255,255,128),e.setLineWidth(i),e.setLineDash([]),e.strokeRectInset(this.position.x-i*3,this.position.y-i*4,i*6,i*8,-i*1.5)),e.drawImage(_,this.isEnabled?80:40,0,10*4,10*4,this.position.x-2,this.position.y-2,4,4)}onInteract(){this.isEnabled=!0}};var Pe=.3,zt=class extends A{constructor(e,i,r,n=4,s={}){super(e,i,void 0,r);this.connectionPoint=a.add(i,new a((s.isFlipped?1:-1)*(n/2-.9),.3)),this.hasLeft=n>4||!s.isFlipped,this.hasRight=n>4||!!s.isFlipped,this.hasLedge=!!s.hasLedge,this.leftHead=h.widthForm(this.position.x-n/2,this.position.y,1.2,.8),this.rightHead=h.widthForm(this.position.x+n/2-1.2,this.position.y,1.2,.8),this.leftDoor=h.widthForm(this.position.x-n/2,this.position.y,this.hasRight?n/2:n,.6),this.rightDoor=h.widthForm(this.position.x-(this.hasLeft?0:n/2),this.position.y,this.hasLeft?n/2:n,.6),this.ledge=h.widthForm(this.position.x-n/2,this.position.y,n,.2),this.fullWidth=n/2,this.doorWidth=this.hasLeft&&this.hasRight?n/2:n}onStart(e){super.onStart(e),this.hasLeft&&(e.addWithoutDuplicate({type:1,rect:this.leftHead}),e.addWithoutDuplicate({type:1,rect:this.leftDoor})),this.hasRight&&(e.addWithoutDuplicate({type:1,rect:this.rightHead}),e.addWithoutDuplicate({type:1,rect:this.rightDoor})),this.hasLedge&&e.addWithoutDuplicate({type:2,rect:this.ledge})}update(e,i,r){super.update(e,i,r);let n=i/Pe*(this.prereqsActive?-1:1);this.leftDoor.x2=w(this.leftDoor.x2+n,this.leftDoor.x1,this.leftDoor.x1+this.doorWidth),this.rightDoor.x1=w(this.rightDoor.x1-n,this.rightDoor.x2-this.doorWidth,this.rightDoor.x2)}draw(e){super.draw(e);let i=e.dynamicWorldCanvas;if(this.hasLedge)for(let r=-this.ledge.x1;r<this.ledge.x2;r++)i.drawImage($,10,0,10,10,r,this.ledge.y1,1,1);if(this.hasLeft){let r=this.leftDoor.width;r>0&&(i.setColor("black"),this.leftDoor.draw(i),i.drawImage(_,160+Math.max(40-10*r,20)-10,10,Math.min(10*r,20),10,Math.max(this.leftDoor.x1,this.leftDoor.x2-2),this.position.y,Math.min(r,2),1)),i.drawImage(_,this.prereqsActive?180:160,0,12,8,this.leftHead.x1,this.leftHead.y1,this.leftHead.width,this.leftHead.height)}if(this.hasRight){let r=this.rightDoor.width;r>0&&(i.setColor("black"),this.rightDoor.draw(i),i.drawImage(_,170,30,Math.min(10*r,20),10,this.rightDoor.x1,this.position.y,Math.min(r,2),1)),i.drawImage(_,this.prereqsActive?188:168,20,12,8,this.rightHead.x1,this.rightHead.y1,this.rightHead.width,this.rightHead.height)}}};var Se="0",At=(o,t)=>o.toString(16).padStart(t,Se),rt=(o,t,e,i=255)=>`#${At(o,2)}${At(t,2)}${At(e,2)}${At(i,2)}`,nt=(o,t,e,i=1)=>`hsla(${o},${Math.floor(t*100)}%,${Math.floor(e*100)}%,${i})`;var Re=1,Dt=class extends K{constructor(e,i,r,n,s={}){super(e);this.coverArea=i,this.extraCovers=r,this.triggerArea=n,this.coverIsTrigger=!!s.coverIsTrigger,this.canReCover=!!s.canReCover,this.isUncovered=!1,this.revealState=0}playerCollidesCover(e){return this.coverArea.intersectsPoint(e.position)||this.extraCovers.some(i=>i.intersectsPoint(e.position))}isPlayerTriggering(e){return this.triggerArea.intersectsPoint(e.position)||this.coverIsTrigger&&this.playerCollidesCover(e)}isOpen(e){return this.canReCover?this.isPlayerTriggering(e):this.isUncovered?!0:(this.isUncovered=this.isPlayerTriggering(e),this.isUncovered)}onStart(e){super.onStart(e)}update(e,i,r){super.update(e,i,r);let n=this.isOpen(e);this.revealState=w(this.revealState+(n?1:-1)*(i/Re),0,1),this.lastPlayerPos=e.position}draw(e){if(super.draw(e),this.revealState===1)return;let i=e.dynamicWorldCanvas;if(this.revealState===0)i.setColor("black");else{let r=this.coverArea.width+this.coverArea.height,n=r*.2,s=this.lastPlayerPos?a.lerp(this.lastPlayerPos,this.coverArea.midpoint,this.revealState):this.coverArea.midpoint,l=(r+n)*this.revealState,c=i.createRadialGradient(s.x,s.y,Math.max(0,l-n/2),s.x,s.y,l+n/2);c.addColorStop(0,rt(0,0,0,0)),c.addColorStop(1,rt(0,0,0,255)),i.setColor(c)}this.coverArea.draw(i),this.extraCovers.forEach(r=>r.draw(i))}};var Mt=class{constructor(t,e,i){this.collider=t,this.key=e,this.nextLevelCollider=i||t}hasEntered(t){return this.collider.intersectsPoint(t.position)}translatePlayerToNext(t){return a.diff(t.position,new a(this.nextLevelCollider.x1,this.nextLevelCollider.y1))}};var _e=Symbol("Up"),ze=Symbol("Down"),Ae=Symbol("Left"),De=Symbol("Right"),Me=Symbol("Jump"),Te=Symbol("Interact"),Ve=Symbol("Escape"),g={Down:ze,Escape:Ve,Interact:Te,Jump:Me,Left:Ae,Right:De,Up:_e};var de={" ":g.Jump,escape:g.Escape,esc:g.Escape,Escape:g.Escape,Esc:g.Escape,w:g.Up,a:g.Left,s:g.Down,d:g.Right,e:g.Interact},F=class{constructor(t,e,i=!1,r=!1){this.keyMap=t,this.mousePosition=e,this.leftClicking=i,this.rightClicking=r}getHorizontalAxis(){return+!!this.keyMap[g.Right]-+!!this.keyMap[g.Left]}getVerticalAxis(){return+!!this.keyMap[g.Down]-+!!this.keyMap[g.Up]}isPressed(t){return!!this.keyMap[t]}isLeftClicking(){return this.leftClicking}isRightClicking(){return this.rightClicking}static empty(){return new F({},new a(0,0))}},Tt=class{constructor(){}isForKey(t){return!1}isClick(){return!1}},Zt=class extends Tt{constructor(e){super();this.input=e}isForKey(e){return e===this.input}},Vt=class extends Tt{constructor(e,i){super();this.position=e,this.isRight=i}isClick(){return!0}isRightClick(){return this.isRight}},kt=class{constructor(t){this.leftClicking=!1,this.rightClicking=!1,this.isButtonDown={},this.listener=t,this.mousePosition=new a(0,0),this.canvas=document.getElementById("canvas")}init(){let t=i=>{this.listener&&this.listener(new Zt(i))};document.addEventListener("keydown",i=>{if(i.repeat)return;let r=de[i.key];!r||(this.isButtonDown[r]=!0,t(r))}),document.addEventListener("keyup",i=>{let r=de[i.key];!r||(this.isButtonDown[r]=!1)}),document.addEventListener("mousemove",i=>{this.mousePosition=this.toCanvasPosition(i)}),document.addEventListener("mousedown",i=>{var r,n;this.mousePosition=this.toCanvasPosition(i),i.button===0?((r=this.listener)==null||r.call(this,new Vt(this.mousePosition,!1)),this.leftClicking=!0):i.button===2&&((n=this.listener)==null||n.call(this,new Vt(this.mousePosition,!0)),this.rightClicking=!0)}),document.addEventListener("mouseup",i=>{i.button===0?this.leftClicking=!1:i.button===2&&(this.rightClicking=!1)}),document.addEventListener("contextmenu",i=>{i.preventDefault()});let e=(i,r)=>{let n=document.getElementById(i);!n||(n.addEventListener("touchstart",s=>{s.preventDefault(),this.isButtonDown[r]=!0,t(r)}),n.addEventListener("touchcancel",s=>{s.preventDefault(),this.isButtonDown[r]=!1}),n.addEventListener("touchend",s=>{s.preventDefault(),this.isButtonDown[r]=!1}))};e("left",g.Left),e("right",g.Right),e("jump",g.Jump),e("down",g.Down),e("escape",g.Escape),e("interact",g.Interact)}toCanvasPosition(t){return a.scale(new a(t.clientX-this.canvas.offsetLeft,t.clientY-this.canvas.offsetTop),this.canvas.width/this.canvas.clientWidth*U/B)}getInputState(){return new F(this.isButtonDown,this.mousePosition,this.leftClicking,this.rightClicking)}};var Gt=class{constructor(t,e){this.width=t,this.height=e}lerpFactor(t,e){return(t+1)/e.parallax.length}*iterateArea(t,e,i,r){let n=0;for(let s=0;s<t;s+=i){let l=0;for(let c=0;c<e;c+=r)yield[l,n,h.widthForm(s,c,i,r)],l++;n++}}prepareCanvas(t,e,i,r,n,s){let l=this.lerpFactor(e,t),c=10*4,d=new a(32*c,18*c),m=new a(this.width*c,this.height*c),P=a.lerp(d,m,l),f=t.parallax[e],I=a.lerp(r,n,l);f.setColor(nt(i,I.x,I.y)),s(f,P.x,P.y)}draw(t){let i=new a(.28,.55),r=new a(.7,.3);t.background.setColor(nt(40,i.x,i.y)),t.background.fillRect(0,0,t.background.width,t.background.height),this.prepareCanvas(t,0,40,i,r,(n,s,l)=>{for(let[c,d,m]of this.iterateArea(s,l,30,l))Math.random()>.86&&m.draw(n)}),this.prepareCanvas(t,1,40,i,r,(n,s,l)=>{for(let[c,d,m]of this.iterateArea(s,l,70,l))Math.random()>.95&&m.draw(n);for(let[c,d,m]of this.iterateArea(s,l,s,70))Math.random()>.95&&m.draw(n)}),this.prepareCanvas(t,2,40,i,r,(n,s,l)=>{let c=[Math.random()*s,Math.random()*s,Math.random()*s],d=[Math.random()*l,Math.random()*l,Math.random()*l];for(let[m,P,f]of this.iterateArea(s,l,50,50))(c.some(I=>f.xInRange(I))||d.some(I=>f.yInRange(I)))&&(n.setLineWidth(12),f.stroke(n),n.setLineWidth(6),Math.random()>.2&&n.drawLine(f.x1,f.y1,f.x2,f.y2),Math.random()>.2&&n.drawLine(f.x2,f.y1,f.x1,f.y2))}),this.prepareCanvas(t,3,40,i,r,(n,s,l)=>{for(let[c,d,m]of this.iterateArea(s,l,90,l))Math.random()>.95&&m.draw(n);for(let[c,d,m]of this.iterateArea(s,l,s,90))Math.random()>.95&&m.draw(n)})}updateCameras(t){let e=new a(0,0),i=t.camera;t.parallax.forEach((r,n)=>{t.parallaxCameras[n]=a.lerp(e,i,this.lerpFactor(n,t))})}};var Ot=1280/32,Wt=class{constructor(t,e,i,r,n,s,l,c,d){this.key=t,this.levelGrid=r,this.objects=n,this.player=s,this.exitTriggers=l,this.interactibles=c,this.entities=d,this.width=e,this.height=i,this.camera=this.getIdealCamera(),this.interactingWith=void 0,this.backgroundArtist=new Gt(e,i),this.drawnStatic=!1,this.playModeManager=void 0}start(t){this.drawnStatic=!1,this.interactingWith=void 0,this.playModeManager=t,this.interactibles.forEach(e=>e.onStart(this)),this.entities.forEach(e=>e.onStart(this))}addWithoutDuplicate(t){this.objects.find(({rect:e})=>e===t.rect)||this.objects.push(t)}emitEvent(t){this.playModeManager&&this.playModeManager.onLevelEvent(t)}feedPlayerInfo(t,e){e.key!==this.key&&console.error("Exit key mis-match");let i=e.translatePlayerToNext(t);this.player.position.x=i.x,this.player.position.y=i.y,this.player.velocity=t.velocity.copy(),this.camera=this.getIdealCamera()}update(t,e){var i;this.player.update(t,this.isPlayerActive()?e:F.empty(),this),this.interactibles.forEach(r=>{r.update(this.player,t,this)}),(i=this.interactingWith)!=null&&i.isAreaActive||this.closeCurrentPuzzle(),this.entities.forEach(r=>{r.update(this.player,t,this)}),this.updateCamera(t),this.updateExits()}isPlayerActive(){return!this.interactingWith}closeCurrentPuzzle(){this.interactingWith&&(this.emitEvent(new St(this.interactingWith.id)),this.interactingWith=void 0)}onInput(t){if(this.isPlayerActive()&&this.player.onInput(t),t.isForKey(g.Interact))if(this.interactingWith)this.closeCurrentPuzzle();else{let e=this.interactibles.find(i=>i.isAreaActive);if(e){let i=e.onInteract();i&&i instanceof Y&&(this.interactingWith=e,this.emitEvent(i))}}else t.isForKey(g.Escape)&&this.closeCurrentPuzzle()}updateExits(){let t=this.exitTriggers.find(e=>e.hasEntered(this.player));t&&this.emitEvent(new Pt(t))}clampCamera(t){let e=new a(w(t.x,this.player.position.x-32+1,this.player.position.x-1),w(t.y,this.player.position.y-18+1,this.player.position.y-1));return new a(w(e.x,0,this.width-32),w(e.y,0,this.height-18))}getNaiveCamera(t=this.player.position){return new a(t.x-32/2,t.y-18/2)}getIdealCamera(t=this.player.position){return this.clampCamera(this.getNaiveCamera(t))}updateCamera(t){this.camera=this.clampCamera(a.lerp(this.camera,this.getNaiveCamera(a.add(this.player.position,new a(this.player.velocity.x*.3,0))),t*2))}withSetupCanvas(t,e){t.saveTransform(),t.scale(Ot,Ot),e(t),t.restoreTransform()}draw(t){this.drawnStatic||(this.backgroundArtist.draw(t),this.withSetupCanvas(t.staticWorldCanvas,e=>{e.clear(),e.setColor("black");for(let i=0;i<this.height;i++)for(let r=0;r<this.width;r++){let n=this.levelGrid[i][r];n&&e.drawImage($,(n-1)*10,0,10,10,r,i,1,1)}}),this.drawnStatic=!0),this.withSetupCanvas(t.dynamicWorldCanvas,e=>{e.clear(),this.withSetupCanvas(t.behindGroundCanvas,()=>{t.behindGroundCanvas.clear(),this.interactibles.forEach(i=>{i.draw(t)}),this.player.draw(e),this.entities.forEach(i=>{i.draw(t)})})}),t.setCamera(new a(Math.floor(this.camera.x*Ot),Math.floor(this.camera.y*Ot))),this.backgroundArtist.updateCameras(t)}};var $t=class{constructor(){this.grid=[],this.shortGrid=[]}innerGet(t,e,i,r){return t in r||(r[t]=[]),e in r[t]||(r[t][e]=h.widthForm(e,t,1,i?.2:1)),r[t][e]}get(t,e,i=!1){return this.innerGet(t,e,i,i?this.shortGrid:this.grid)}},me=new $t;var ot=.8,Ht=16,Ft=Ht/.3,Qt=2*Ft,Ge=1.8*Ft,Oe=4,fe=.6,ge=4*Oe/fe,We=ge,pe=2*ge/fe,Ne=.1,Nt=Ht*.5;function He(o){return!!o}var Bt=class{constructor(t){this.position=t,this.collider=new u(t,ot),this.velocity=new a(0,0),this.isDropping=!1,this.wantsToJump=!1,this.contactingAnyLedge=!1,this.inAirFor=1,this.state=2}onInput(t){t.isForKey(g.Jump)&&(this.wantsToJump=!0)}collideWithBlock(t,e,i){let r=!this.isDropping&&t===2&&this.velocity.y>=0&&this.position.y<e.y1,n=this.collider.intersectsRectangle(e);if(n&&t===2&&(this.contactingAnyLedge=!0,this.velocity.y<0&&this.position.y>=e.y1&&(this.isDropping=!0)),H.isSolid(t)||r){if(n){let s=e.uncollideCircle(this.collider);this.velocity.add(a.scale(s,1/i)),s.x>0&&s.y===0?this.velocity.x=Math.max(0,this.velocity.x):s.x<0&&s.y===0&&(this.velocity.x=Math.min(0,this.velocity.x)),s.y>0&&s.x===0?this.velocity.y=Math.max(0,this.velocity.y):s.y<0&&s.x===0&&(this.velocity.y=Math.min(0,this.velocity.y)),this.position.add(s)}return this.collider.intersectsRectangle(e)}}update(t,e,i){let r=(y,v)=>{var W;return(W=i.levelGrid[Math.floor(v)])==null?void 0:W[Math.floor(y)]},n=(y,v)=>{let W=r(y,v);if(W)return{type:r(y,v),rect:me.get(Math.floor(v),Math.floor(y),W===2)}},s=e.getHorizontalAxis(),l=e.getVerticalAxis(),c=new a(s*Ft,0);e.isPressed(g.Down)&&this.state!==1&&(this.isDropping=!0);let d=this.position.y+this.collider.radius,m=r(this.position.x,d),P=this.isDropping?H.isSolid(m):H.isGrounding(m),f=r(this.position.x,this.position.y),Z=P&&d===Math.floor(d)||i.objects.some(({type:y,rect:v})=>(this.isDropping?H.isSolid(y):H.isGrounding(y))&&this.collider.isKissingBelow(v));f===4&&l!==0?this.state=1:Z?this.state=0:f||(this.state=2);let V=(y,v,W)=>{if(G(y)){if(G(y)!==G(v))return-Ge*G(v)}else return-Math.min(Math.abs(v/t),W)*G(v);return 0};if(this.state===0)this.inAirFor=0,c.x+=V(s,this.velocity.x,Qt),this.velocity.y=0;else if(this.state===1)this.inAirFor=0,c.y=e.getVerticalAxis()*Ft,c.x+=V(s,this.velocity.x,Qt),c.y+=V(l,this.velocity.y,Qt);else if(this.inAirFor+=t,f===3){let y=this.velocity.y>0?0:1.1;c.y-=pe*y}else c.y+=pe;this.inAirFor<Ne&&this.wantsToJump&&(this.wantsToJump=!1,this.velocity.y=-We,this.state=2),this.velocity.add(a.scale(c,t)),this.state===1?(this.velocity.x=w(this.velocity.x,-Nt,Nt),this.velocity.y=w(this.velocity.y,-Nt,Nt)):this.velocity.x=w(this.velocity.x,-Ht,Ht);let O=a.scale(this.velocity,t);O.x=w(O.x,-ot,ot),O.y=w(O.y,-ot,ot),this.position.add(O);let{x:C,y:R}=this.position,dt=[n(C,R),n(C,R+1),n(C,R-1),n(C-1,R),n(C+1,R),n(C-1,R-1),n(C+1,R-1),n(C-1,R+1),n(C+1,R+1)].filter(He);this.contactingAnyLedge=!1,dt.concat(i.objects).forEach(({type:y,rect:v})=>{this.collideWithBlock(y,v,t)}),this.isDropping=this.isDropping&&this.contactingAnyLedge}draw(t){t.setColor("yellow"),this.collider.draw(t)}};var Ut=class{constructor(t,e,i,r){this.key=t,this.iid=e,this.width=i,this.height=r,this.levelGrid=[],this.objects=[],this.playerPosition=new a(16,9),this.exitTriggers=[],this.interactibles=[],this.entities=[],this.worldPosition=new a(0,0)}addObjects(t){return this.objects=this.objects.concat(t),this}addExits(t){return this.exitTriggers=this.exitTriggers.concat(t),this}addInteractibles(t){return this.interactibles=this.interactibles.concat(t),this}addEntities(t){return this.entities=this.entities.concat(t),this}setPlayerPos(t){return this.playerPosition=t,this}setLevelGrid(t){this.levelGrid=t}makeGridSpace(){this.levelGrid=[];for(let t=0;t<this.height;t++)this.levelGrid.push([])}setWorldPosition(t){this.worldPosition=t}setCell(t,e,i){this.levelGrid[t][e]=i}create(){return new Wt(this.key,this.width,this.height,this.levelGrid,this.objects,new Bt(this.playerPosition),this.exitTriggers,this.interactibles,this.entities)}};var Fe="./data/world.json";function Be(o){return fetch(o).then(t=>t.json())}function M(o,t){return o.find(e=>e.__identifier===t)}function we(o,t){return o.find(e=>e.iid===t)}function be(o,t){return M(o.layerInstances,t)}function z(o){return Math.floor(o/10)}function Ue(o){return z(o[0])+1}function Kt(o){var e;return(((e=M(o.fieldInstances,"prerequisites"))==null?void 0:e.__value)||[]).map(i=>i.entityIid)}function Ke(o){var n,s;let t=o.iid,e=(n=M(o.fieldInstances,"key"))==null?void 0:n.__value;e||console.warn("Puzzle with no key!");let i=new a(o.__grid[0]+2,o.__grid[1]+2),r={isFlipped:(s=M(o.fieldInstances,"isFlipped"))==null?void 0:s.__value};return new Rt(t,i,h.aroundPoint(i,2,2),Kt(o),e,r)}function qe(o){let t=o.iid;t||console.warn("Switch with no key!");let e=new a(o.__grid[0]+2,o.__grid[1]+2);return new _t(t,e,h.aroundPoint(e,2,2),Kt(o))}function Xe(o){let t=o.iid;t||console.warn("Door with no key!");let e=new a(o.__grid[0]+2,o.__grid[1]+2);return new ft(t,e,Kt(o),z(o.height))}function je(o){var r,n;let t=o.iid;t||console.warn("Trapdoor with no key!");let e=new a(...o.__grid),i={isFlipped:(r=M(o.fieldInstances,"isFlipped"))==null?void 0:r.__value,hasLedge:(n=M(o.fieldInstances,"hasLedge"))==null?void 0:n.__value};return new zt(t,e,Kt(o),z(o.width),i)}var te=o=>h.widthForm(...o.__grid,z(o.width),z(o.height));function Ye(o){return!!o}function Je(o,t){var c,d,m,P,f;let e=o.iid;e||console.warn("CoverEntity with no key!");let i=(d=(c=M(o.fieldInstances,"triggerArea"))==null?void 0:c.__value)==null?void 0:d.entityIid,r=we(t,i)||o,s=(((m=M(o.fieldInstances,"extraCover"))==null?void 0:m.__value)||[]).map(I=>we(t,I.entityIid)).filter(Ye).map(te),l={coverIsTrigger:(P=M(o.fieldInstances,"coverIsTrigger"))==null?void 0:P.__value,canReCover:(f=M(o.fieldInstances,"canReCover"))==null?void 0:f.__value};return new Dt(e,te(o),s,te(r),l)}function Ze(o){let t=new Ut(o.identifier,o.iid,z(o.pxWid),z(o.pxHei));t.makeGridSpace();let e=be(o,"Solid");for(let s of e.gridTiles){let l=z(s.px[0]),c=z(s.px[1]),d=Ue(s.src);t.setCell(c,l,d)}let i=!1,n=be(o,"EntityLayer").entityInstances;return n.forEach(s=>{switch(s.__identifier){case"Util":break;case"PlayerStart":t.setPlayerPos(new a(s.__grid[0],s.__grid[1])),i=!0;break;case"PuzzleScreen":t.addInteractibles([Ke(s)]);break;case"Switch":t.addInteractibles([qe(s)]);break;case"Door":t.addInteractibles([Xe(s)]);break;case"Trapdoor":t.addInteractibles([je(s)]);break;case"CoverEntity":t.addEntities([Je(s,n)]);break;default:console.warn("Processing unknown entity type:",s.__identifier)}}),i||console.warn(`Level ${o.identifier} is missing a PlayerStart`),t.setWorldPosition(new a(z(o.worldX),z(o.worldY))),t}function $e(o,t){let e=t[o.iid];for(let i of o.__neighbours){let r=i.levelIid,n=t[r],s=a.diff(n.worldPosition,e.worldPosition),l=h.widthForm(s.x,s.y,n.width,n.height);e.addExits([new Mt(l,n.key,l)])}return e.create()}var at=class{static start(){return Be(Fe).then(t=>{at.data=t;let e={};t.levels.forEach(i=>{let r=Ze(i);e[r.iid]=r,e[r.key]=r}),t.levels.forEach(i=>{let r=$e(i,e);at.levelMap[r.key]=r})}).then(()=>{})}static getLevel(t){return at.levelMap[t]}},D=at;D.hasLoaded=!1,D.data=null,D.levelMap={};var qt=class{constructor(){let t="Level_0";this.levelMap={},this.currentLevel=D.getLevel(t),this.levelMap[t]=this.currentLevel}getInitialLevel(){return this.currentLevel}getLevel(t,e){let i=this.levelMap[t]||D.getLevel(t);return i.feedPlayerInfo(this.currentLevel.player,e),this.currentLevel=i,this.levelMap[t]=i,i}};var Xt=class{constructor(){this.levelManager=new qt,this.startLevel(this.levelManager.getInitialLevel()),this.puzzleManager=Lt,this.currentPuzzle=void 0}startLevel(t){this.currentLevel=t,t.start(this)}onLevelEvent(t){var e;if(t.isExitEvent()){let i=t.exitTrigger;this.startLevel(this.levelManager.getLevel(i.key,i))}else t.isOpenPuzzleEvent()?(this.currentPuzzle=this.puzzleManager.getPuzzle(t.puzzleId),this.currentPuzzle.open()):t.isClosePuzzleEvent()&&((e=this.currentPuzzle)==null||e.close())}update(t,e){var i,r;(i=this.currentLevel)==null||i.update(t,e),(r=this.currentPuzzle)==null||r.update(t,e)}onInput(t){var e,i;(e=this.currentLevel)==null||e.onInput(t),(i=this.currentPuzzle)==null||i.onInput(t)}draw(t){var e,i;(e=this.currentLevel)==null||e.draw(t),(i=this.currentPuzzle)==null||i.draw(t)}};var jt=class{constructor(){this.playMode=new Xt,this.currentMode=this.playMode}update(t,e){this.currentMode.update(t,e)}onInput(t){this.currentMode.onInput(t)}draw(t){this.currentMode.draw(t)}};var p=Symbol("ctx"),lt=Symbol("canvas"),ct=class{constructor(t){this[lt]=t;let e=t.getContext("2d");if(!e)throw Error("Unable to get 2d context");e.imageSmoothingEnabled=!1,this[p]=e,this[p].fillStyle="black",this[p].strokeStyle="black",this.width=this[lt].width,this.height=this[lt].height}fillRect(t,e,i,r){this[p].fillRect(t,e,i,r)}clear(){this[p].clearRect(0,0,this.width,this.height)}strokeRect(t,e,i,r){this[p].strokeRect(t,e,i,r)}strokeRectInset(t,e,i,r,n){this.strokeRect(t+n,e+n,i-n*2,r-n*2)}fillEllipse(t,e,i,r){this[p].beginPath(),this[p].ellipse(t,e,i,r,0,0,2*Math.PI),this[p].fill()}strokeEllipse(t,e,i,r){this[p].beginPath(),this[p].ellipse(t,e,i,r,0,0,2*Math.PI),this[p].stroke()}drawLine(t,e,i,r){this[p].beginPath(),this[p].moveTo(t,e),this[p].lineTo(i,r),this[p].stroke()}drawQuadratic(t,e,i,r,n,s){this[p].beginPath(),this[p].moveTo(t,e),this[p].quadraticCurveTo(n,s,i,r),this[p].stroke()}scale(t,e){this[p].scale(t,e)}translate(t,e){this[p].translate(t,e)}setLineWidth(t){this[p].lineWidth=t}get lineWidth(){return this[p].lineWidth}setLineDash(t){this[p].setLineDash(t)}setColor(t){t!==this[p].fillStyle&&(this[p].fillStyle=t,this[p].strokeStyle=t)}setColorRGB(t,e,i,r=255){this.setColor(rt(t,e,i,r))}setColorHSLA(t,e,i,r=1){this.setColor(nt(t,e,i,r))}createGradient(t,e,i,r){return this[p].createLinearGradient(t,e,i,r)}createRadialGradient(t,e,i,r,n,s){return this[p].createRadialGradient(t,e,i,r,n,s)}saveTransform(){this[p].save()}restoreTransform(){this[p].restore()}drawImage(t,e,i,r,n,s,l,c,d){let m;if(t instanceof ct)m=t[lt];else if(t instanceof Image){if(!t.complete)return;m=t}else throw Error("Drawing something unmanageable");this[p].drawImage(m,e,i,r,n,s,l,c,d)}static fromId(t){let e=document.getElementById(t);if(!e||!(e instanceof HTMLCanvasElement))throw new Error(`Could not find canvas with id: "${t}"`);return new ct(e)}static fromScratch(t,e){let i=document.createElement("canvas");return i.width=t,i.height=e,new ct(i)}},L=ct;lt,p;var ht=Symbol("real-canvas");function Qe(){let o=document.getElementById("canvas");if(!(o instanceof HTMLCanvasElement))throw new Error("Could not find canvas");return o.width=B,o.height=pt,o}var ee=class{constructor(){let t=new L(Qe());if(!(t instanceof L))throw Error("No canvas found!");this[ht]=t,this.background=L.fromScratch(1280*3,720*3),this.parallax=[L.fromScratch(1280*3,720*3),L.fromScratch(1280*3,720*3),L.fromScratch(1280*3,720*3),L.fromScratch(1280*3,720*3),L.fromScratch(1280*3,720*3)],this.parallaxCameras=this.parallax.map(()=>new a(0,0)),this.behindGroundCanvas=L.fromScratch(1280*3,720*3),this.staticWorldCanvas=L.fromScratch(1280*3,720*3),this.dynamicWorldCanvas=L.fromScratch(1280*3,720*3),this.uiCanvas=L.fromScratch(B,pt),this.camera=new a(0,0)}setParallaxCameras(t){this.parallaxCameras=t}setCamera(t){this.camera=t}drawCanvas(t,e,i=1280,r=720){this[ht].drawImage(t,e.x,e.y,i,r,0,0,this[ht].width,this[ht].height)}drawToScreen(){this.drawCanvas(this.background,this.camera),this.parallax.forEach((t,e)=>{this.drawCanvas(t,this.parallaxCameras[e])}),this.drawCanvas(this.behindGroundCanvas,this.camera),this.drawCanvas(this.staticWorldCanvas,this.camera),this.drawCanvas(this.dynamicWorldCanvas,this.camera),this.drawCanvas(this.uiCanvas,new a(0,0),U,N)}static getInstance(){return this.instance?this.instance:new ee}},ut=ee;ht,ut.instance=null;var ti=1/20,re=class{constructor(){this.screenManager=ut.getInstance(),this.gameModeManager=new jt,this.inputManager=new kt(t=>this.onInput(t)),this.lastFrameTime=performance.now()}start(){this.inputManager.init(),this.lastFrameTime=performance.now(),requestAnimationFrame(()=>this.mainLoop())}onInput(t){this.gameModeManager.onInput(t)}mainLoop(){let t=performance.now(),e=Math.min((t-this.lastFrameTime)/1e3,ti);this.gameModeManager.update(e,this.inputManager.getInputState()),this.gameModeManager.draw(this.screenManager),this.screenManager.drawToScreen(),requestAnimationFrame(()=>this.mainLoop()),this.lastFrameTime=t}};function ie(o){let t=document.getElementById(o);return t||console.warn(`Can't find element with id: ${o}`),t}var ei=()=>{var t,e,i;D.start().then(()=>{let r=new re;r.start(),window.app=r}),!mt&&!location.href.includes("localhost")&&Array.from(document.getElementsByTagName("p")).forEach(r=>r.classList.add("visible")),mt||(t=ie("mobile-controls"))==null||t.remove(),mt&&((e=ie("canvas"))==null||e.classList.add("fit-screen"),(i=ie("mobile-controls"))==null||i.classList.remove("hidden"))};window.onload=()=>{ei()};})();
//# sourceMappingURL=index.js.map
