"use strict";(()=>{var _=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),$=1280,Lt=720,Q=$,X=Lt,V=3;var b=(o,t,e)=>Math.min(e,Math.max(o,t)),O=o=>o>0?1:o===0?0:-1;var a=class{constructor(t,e){this.x=t,this.y=e}add(t){return this.x+=t.x,this.y+=t.y,this}subtract(t){this.x-=t.x,this.y-=t.y}multiply(t){return this.x*=t,this.y*=t,this}copy(){return new a(this.x,this.y)}setFrom(t){this.x=t.x,this.y=t.y}get magnitude(){return Math.hypot(this.x,this.y)}static add(t,e){return new a(t.x+e.x,t.y+e.y)}static diff(t,e){return new a(t.x-e.x,t.y-e.y)}static scale(t,e){return new a(t.x*e,t.y*e)}static sqrDist(t,e){let i=t.x-e.x,r=t.y-e.y;return i*i+r*r}static manhattanDist(t,e){return Math.max(Math.abs(t.x-e.x),Math.abs(t.y-e.y))}static dist(t,e){return Math.hypot(t.x-e.x,t.y-e.y)}static lerp(t,e,i){return new a(t.x*(1-i)+e.x*i,t.y*(1-i)+e.y*i)}};var m=class{constructor(t,e){this.position=t,this.radius=e}intersectsCircle(t){let e=this.radius+t.radius;return a.sqrDist(this.position,t.position)<e*e}intersectsVector(t){return a.sqrDist(this.position,t)<this.radius*this.radius}intersectsRectangle(t){let e=b(this.position.x,t.x1,t.x2),i=b(this.position.y,t.y1,t.y2);return this.intersectsVector(new a(e,i))}isKissingBelow(t){return this.position.y+this.radius===t.y1&&t.x1<=this.position.x&&this.position.x<=t.x2}draw(t){t.fillEllipse(this.position.x,this.position.y,this.radius,this.radius)}},u=class{constructor(t,e,i,r){this.x1=t,this.y1=e,this.x2=i,this.y2=r}intersectsPoint(t){return this.x1<=t.x&&t.x<=this.x2&&this.y1<=t.y&&t.y<=this.y2}get width(){return this.x2-this.x1}get height(){return this.y2-this.y1}get midpoint(){return new a((this.x1+this.x2)/2,(this.y1+this.y2)/2)}xInRange(t){return this.x1<=t&&t<this.x2}yInRange(t){return this.y1<=t&&t<this.y2}intersectsRectangle(t){return t.x1<=this.x2&&this.x1<=t.x2&&t.y1<=this.y2&&this.y1<=t.y2}uncollideCircle(t){let e=b(t.position.x,this.x1,this.x2),i=b(t.position.y,this.y1,this.y2),r=new a(e,i),s=a.diff(t.position,r),n=s.magnitude||1;if(n>=t.radius){let l=a.diff(t.position,this.midpoint),c=this.width/2-Math.abs(l.x),h=this.height/2-Math.abs(l.y);return c<h?new a((c+t.radius)*O(l.x),0):new a(0,(h+t.radius)*O(l.y))}return a.scale(s,(t.radius-n)/n)}draw(t,e=0){t.fillRect(this.x1-e,this.y1-e,this.width+e*2,this.height+e*2)}stroke(t,e=0){t.strokeRectInset(this.x1,this.y1,this.width,this.height,e)}inset(t){return new u(this.x1+t,this.y1+t,this.x2-t,this.y2-t)}static widthForm(t,e,i,r){return new u(t,e,t+i,e+r)}static centerForm(t,e,i,r){return new u(t-i,e-r,t+i,e+r)}static aroundPoint(t,e,i){return new u(t.x-e,t.y-i,t.x+e,t.y+i)}static merged(t){let[e,i,r,s]=t.reduce(([n,l,c,h],p)=>[Math.min(p.x1,n),Math.min(p.y1,l),Math.max(p.x2,c),Math.max(p.y2,h)],[1/0,1/0,-1/0,-1/0]);return new u(e,i,r,s)}};var ct=new Image;ct.src="./img/tileset.png";var A=new Image;A.src="./img/entity-set.png";var tt=new Image;tt.src="./img/decoration.png";var j={isSolid:o=>o===1,isGrounding:o=>o===2||j.isSolid(o)};var B=class{constructor(t){this.id=t}onStart(t){}onAwaken(){}update(t,e,i){}draw(t){}drawForMap(t){}drawAsMapIcon(t,e){}};var Ke=!1,S=class extends B{constructor(e,i,r,s=[]){super(e);this.position=i,this.triggerArea=r,this.prerequisites=s,this.prereqsActive=s.length===0,this.prereqEntities=[],this.isEnabled=!1,this.isAreaActive=!1,this.connectionPoint=this.position,this.outputPoint=this.position,this.showAsMapIcon=!1}onStart(e){this.findPrerequisites(e)}onAwaken(){}findPrerequisites(e){return this.prereqEntities.length===this.prerequisites.length?this.prereqEntities:(this.prereqEntities=e.interactibles.filter(i=>this.prerequisites.includes(i.id)),this.prereqEntities)}update(e,i,r){var s;this.prereqsActive=this.prereqEntities.every(n=>n.isEnabled),this.isAreaActive=!!(this.prereqsActive&&((s=this.triggerArea)==null?void 0:s.intersectsPoint(e.position)))}draw(e){var r;let i=e.dynamicWorldCanvas;Ke&&(i.setColorRGB(255,255,255),i.setLineWidth(.1),i.setLineDash([.2,.2]),(r=this.triggerArea)==null||r.stroke(i)),e.behindGroundCanvas.setLineWidth(.2);for(let s of this.prereqEntities){e.behindGroundCanvas.setColor(s.isEnabled?"white":"black");let n=a.manhattanDist(s.outputPoint,this.connectionPoint),l=a.lerp(s.outputPoint,this.connectionPoint,.5),c=a.add(l,new a(0,n*.3));e.behindGroundCanvas.drawQuadratic(s.outputPoint.x,s.outputPoint.y,this.connectionPoint.x,this.connectionPoint.y,c.x,c.y)}}clickedOnMap(){}onInteract(){}};var Xe=.8,Pt=class extends S{constructor(e,i,r,s=4){super(e,i,void 0,r);this.connectionPoint=a.add(i,new a(0,-1.8)),this.headCollider=u.centerForm(this.position.x,this.position.y-1.8,.6,.4),this.doorCollider=u.widthForm(this.position.x-.5,this.position.y-2,1,s),this.fullHeight=s}onStart(e){super.onStart(e),e.addWithoutDuplicate({type:1,rect:this.headCollider}),e.addWithoutDuplicate({type:1,rect:this.doorCollider})}update(e,i,r){super.update(e,i,r);let s=this.fullHeight*i/Xe*(this.prereqsActive?-1:1);this.doorCollider.y2=b(this.doorCollider.y2+s,this.doorCollider.y1,this.doorCollider.y1+this.fullHeight)}draw(e){super.draw(e);let i=e.dynamicWorldCanvas,r=this.doorCollider.height;r>0&&(i.setColor("black"),i.fillRect(this.position.x-.5,this.position.y-2,1,r),i.drawImage(A,120,Math.max(40-10*r,20)-10,40,Math.min(10*r,20),this.position.x-2,this.position.y-2+Math.max(r-2,0),4,Math.min(r,2))),i.drawImage(A,this.prereqsActive?140:128,0,12,6,this.position.x-6/10,this.position.y-2,12/10,6/10)}drawForMap(e){e.setColor("black"),this.doorCollider.draw(e)}};var Pe=.4,Me=.25,y=7/9*X,Z="#00ff62dd",ht="#0096ffdd",Mt=[[new m(new a(0,0),.33)],[new m(new a(0,0),.33)],[new m(new a(0,.4),.33),new m(new a(0,-.4),.33)],[new m(new a(-.42,.4),.33),new m(new a(.42,.4),.33),new m(new a(0,-.4),.33)],[new m(new a(.4,.4),.33),new m(new a(.4,-.4),.33),new m(new a(-.4,.4),.33),new m(new a(-.4,-.4),.33)],[new m(new a(0,.3),.28),new m(new a(.64,.3),.28),new m(new a(-.64,.3),.28),new m(new a(-.32,-.3),.28),new m(new a(.32,-.3),.28)],[new m(new a(0,.6),.28),new m(new a(.64,.6),.28),new m(new a(-.64,.6),.28),new m(new a(-.32,0),.28),new m(new a(.32,0),.28),new m(new a(0,-.6),.28)],[new m(new a(0,0),.28),new m(new a(.64,0),.28),new m(new a(-.64,0),.28),new m(new a(-.32,-.6),.28),new m(new a(.32,-.6),.28),new m(new a(-.32,.6),.28),new m(new a(.32,.6),.28)],[new m(new a(0,.6),.28),new m(new a(.64,.6),.28),new m(new a(-.64,.6),.28),new m(new a(-.32,0),.28),new m(new a(.32,0),.28),new m(new a(0,-.6),.28),new m(new a(.64,-.6),.28),new m(new a(-.64,-.6),.28)]],ze=[[u.centerForm(0,0,.33,.33)],[u.centerForm(0,0,.33,.33)],[u.centerForm(0,-.4,.33,.33),u.centerForm(0,.4,.33,.33)],[u.centerForm(0,-.4,.33,.33),u.centerForm(-.4,.4,.33,.33),u.centerForm(.4,.4,.33,.33)],[u.centerForm(-.4,-.4,.33,.33),u.centerForm(.4,-.4,.33,.33),u.centerForm(-.4,.4,.33,.33),u.centerForm(.4,.4,.33,.33)]];var pe={},je=(o,t,e)=>`${o}-${t}-${e}`,Ze=(o,t,e)=>{let s=e?1:.5,n=Math.floor(y/(t+.7+s)),l=Math.floor(y/(o+.7+.5)),c=Math.min(n,l),h=Math.floor(c*.5),p=Math.floor(c*s),f=Math.min(y-c*t-p,y-c*o-h),v=f+h+o*c,N=f+p+t*c,F=Math.max((N-v)/2,0),W=Math.max((v-N)/2,0),E=W+p,x=[[W,E]];for(let C=0;C<t;C++)x.push([E,E+c]),E+=c;x.push([E,E+f]);let P=F+f,R=[[F,P]];for(let C=0;C<o;C++)R.push([P,P+c]),P+=c;R.push([P,P+h]);let It=[];for(let[C,M]of R){let H=[];for(let[Ue,qe]of x)H.push(new u(Ue,C,qe,M));It.push(H)}return It},Ye=(o,t,e)=>{let i=je(o,t,e);return i in pe||(pe[i]=Ze(o,t,e)),pe[i]},Se=(o,t,e)=>{let i=Ye(o,t,!!e);return(r,s)=>i[r==="end"?o+1:r+1][s==="end"?t+1:s+1]};var Je=.4,$e=!1,zt=class{constructor(t,e,i,r,s={}){this.id=t,this.openCloseStatus=0,this.isOpen=!1,this.rows=e,this.cols=i,this.validator=r,this.isSolved=!1,this.hasBeenSolvedEver=!1;let n=0;this.positionGetter=Se(e,i,r.validationItems.some(l=>l.drawnOnLeft)),this.grid=[];for(let l=0;l<e;l++){let c=[];for(let h=0;h<i;h++){n++;let p={row:l,column:h,id:n};c.push(p)}this.grid.push(c)}if(s.combinedGroups)for(let l of s.combinedGroups){n++;let c=n;l.forEach(([h,p])=>{this.grid[h][p].id=c})}this.values={},this.cellMap={};for(let l of this.grid.flat())this.values[l.id]=null,this.cellMap[l.id]=l.id in this.cellMap?this.cellMap[l.id].concat([l]):[l];this.elements=[],this.miniElements=[];for(let l in this.cellMap){let c=this.cellMap[l];this.elements.push({row:c[0].row,col:c[0].column,shape:u.merged(c.map(({row:h,column:p})=>this.positionGetter(h,p))).inset(V),isHovered:!1}),this.miniElements.push({row:c[0].row,col:c[0].column,shape:u.merged(c.map(({row:h,column:p})=>u.widthForm(p,h,1,1))),isHovered:!1})}}open(){this.isOpen||(this.isOpen=!0,this.openCloseStatus=0)}close(){this.isOpen=!1}uiPosition(){let t=Math.pow(1-this.openCloseStatus,2),e=new a(0,X*t),i=new a((Q-y)/2,(X-y)/2);return a.add(e,i)}draw(t){let e=t.uiCanvas;if(e.clear(),this.openCloseStatus===0)return;let i=this.uiPosition();if(e.translate(i.x,i.y),e.setColor(this.isSolved?Z:ht),e.fillRect(0,0,y,y),e.setColor("#222222"),e.fillRect(y/4,y,y/2,y),e.setLineWidth(V*8),e.setLineDash([]),e.strokeRectInset(0,0,y,y,-V*4),e.setColor("#ffffff64"),e.setLineWidth(V),e.strokeRectInset(0,0,y,y,V/2),$e){e.setColor("red"),e.setLineDash([]);for(let r=-1;r<=this.rows;r++)for(let s=-1;s<=this.cols;s++)this.positionGetter(r,s).stroke(e)}for(let r of this.elements){r.isHovered?e.setColor("white"):e.setColor("#ffffff64"),e.setLineDash([]),r.shape.stroke(e,V/2);let s=this.getElementState(r),n=r.shape.midpoint,l=Math.min(r.shape.width,r.shape.height)*Je;s?(e.setColor("white"),e.fillEllipse(n.x,n.y,l,l)):s===!1&&(e.setColor("#ffffff64"),e.setLineDash([V*2,V*2]),e.strokeEllipse(n.x,n.y,l,l))}this.validator.draw(e,this.positionGetter),e.translate(-i.x,-i.y)}getRowColState(t,e){let i=this.grid[t][e];return this.values[i.id]}getElementState(t){return this.getRowColState(t.row,t.col)}setElementState(t,e){let i=this.grid[t.row][t.col];e!==this.values[i.id]&&(this.values[i.id]=e,this.onStateChange())}resolveClick(t,e,i){let r=this.getElementState(t);this.dragKind!==void 0&&(this.dragKind==="left"&&!e?(this.dragKind=void 0,this.dragState=void 0):this.dragKind==="right"&&!i&&(this.dragKind=void 0,this.dragState=void 0),this.dragKind==="left"?(this.dragState===void 0&&(r!==!0?this.dragState="enabling":this.dragState="emptying"),this.dragState==="enabling"?r!==!1&&this.setElementState(t,!0):this.dragState==="emptying"&&r!==!1&&this.setElementState(t,null)):this.dragKind==="right"&&(this.dragState===void 0&&(r!==!1?this.dragState="disabling":this.dragState="emptying"),this.dragState==="disabling"?r!==!0&&this.setElementState(t,!1):this.dragState==="emptying"&&r!==!0&&this.setElementState(t,null)))}findPositionElement(t){let e;for(let i of this.elements)i.isHovered=i.shape.intersectsPoint(t),i.isHovered&&(e=i);return e}update(t,e){if(this.isOpen&&this.openCloseStatus<1?this.openCloseStatus+=t/Pe:!this.isOpen&&this.openCloseStatus>0&&(this.openCloseStatus-=t/Me),this.openCloseStatus=b(this.openCloseStatus,0,1),e&&this.openCloseStatus===1){let i=a.diff(e.mousePosition,this.uiPosition()),r=this.findPositionElement(i);r&&this.resolveClick(r,e.isLeftClicking(),e.isRightClicking())}else this.dragState=void 0}onStateChange(){this.isSolved=this.validator.isValid(this.grid,this.values),this.isSolved&&(this.hasBeenSolvedEver=!0)}onInput(t){if(t.isClick()){let e=t,i=a.diff(e.position,this.uiPosition());this.dragKind=e.isRightClick()?"right":"left",this.dragState=void 0;let r=this.findPositionElement(i);r&&this.resolveClick(r,this.dragKind==="left",this.dragKind==="right")}}};var St=class{constructor(t){this.validationItems=t}isValid(t,e){return this.validationItems.forEach(i=>{i.validate(t,e)}),this.validationItems.every(i=>i.isValid)}getLeftArea(t,e,i){if(this.leftAreas)return this.leftAreas[t];let r=u.merged([i(-1,-1),i("end",-1)]),s=r.width,n=r.midpoint.y-s*(e+.1*(e-1));this.leftAreas=[];for(let l=0;l<e;l++)this.leftAreas.push(u.widthForm(r.x1,n+l*s*1.1,s,s));return this.leftAreas[t]}draw(t,e,...i){this.validationItems.forEach(s=>{s.drawnOnLeft||s.draw(t,e,...i)});let r=this.validationItems.filter(s=>s.drawnOnLeft);r.forEach((s,n)=>{s.draw(t,this.getLeftArea(n,r.length,e))})}},U=class{constructor(){this.isValid=!1,this.drawnOnLeft=!1}validate(t,e){}draw(t,...e){}};var Rt=class extends U{constructor(e,i){super();this.row=e,this.column=i}},_t=class extends Rt{constructor(e,i,r){super(e,i);this.mustBeOn=r,this.isValid=!r}validate(e,i){let r=e[this.row][this.column];this.isValid=!!i[r.id]==!!this.mustBeOn}draw(e,i){this.isValid?e.setColor("white"):e.setColor("red");let r=i(this.row,this.column),s=Math.min(r.width,r.height),n=new a(r.x2-s*.15,r.y1+s*.15);this.mustBeOn?e.fillEllipse(n.x,n.y,s*.1,s*.1):(e.setLineWidth(s*.05),e.setLineDash([]),e.strokeEllipse(n.x,n.y,s*.075,s*.075))}},At=class extends Rt{constructor(e,i,r){super(e,i);this.desiredCount=r,this.isValid=r===0,this.isCellColoured=!1}*iterateArea(e){for(let i=Math.max(this.row-1,0);i<=Math.min(this.row+1,e.length-1);i++)for(let r=Math.max(this.column-1,0);r<=Math.min(this.column+1,e[i].length-1);r++)yield[i,r]}validate(e,i){let r=0,s=new Set;for(let[n,l]of this.iterateArea(e)){let c=e[n][l];!!i[c.id]&&!s.has(c.id)&&(r++,s.add(c.id))}this.isValid=r===this.desiredCount,this.isCellColoured=!!i[e[this.row][this.column].id]}draw(e,i){this.isValid?e.setColor(this.isCellColoured?Z:"white"):e.setColor("red");let r=i(this.row,this.column),s=Math.min(r.width,r.height)*.25,n=r.midpoint;for(let l of Mt[this.desiredCount]){let c=a.add(n,a.scale(l.position,s));this.desiredCount===0?(e.setLineWidth(l.radius*s*.5),e.strokeEllipse(c.x,c.y,l.radius*s*.75,l.radius*s*.75)):e.fillEllipse(c.x,c.y,l.radius*s,l.radius*s)}}};var Re=o=>new a(-o.y,o.x),Tt=class extends U{constructor(e,i){super();this.isRow=e,this.index=i,this.isValid=!1}getRelevantRow(e,i){let r=this.isRow?e[this.index]:e.map(n=>n[this.index]),[s]=r.reduce(([n,l],c)=>[c.id===l?n:n.concat([i[c.id]]),c.id],[[],-1]);return s}validateRow(e){throw new TypeError("Cannot validate as a generic EdgeValidationItem")}validate(e,i){let r=this.getRelevantRow(e,i);this.isValid=this.validateRow(r)}drawInCell(e,i,r,s){throw new TypeError("Cannot draw a generic EdgeValidationItem")}draw(e,i){if(this.isValid?e.setColor("white"):e.setColor("red"),this.isRow){let r=i(this.index,"end");this.drawInCell(e,r.midpoint,r.width/2,!0)}else{let r=i(-1,this.index);this.drawInCell(e,r.midpoint,r.height/2,!1)}}},ut=class extends Tt{constructor(e,i,r){super(e,i);this.count=r,this.isValid=r===0}validateRow(e){return e.reduce((r,s)=>s?r+1:r,0)===this.count}drawInCell(e,i,r,s){let n=s?l=>new m(Re(l.position),l.radius):l=>l;for(let l of Mt[this.count]){l=n(l);let c=a.add(i,a.scale(l.position,r));this.count===0?(e.setLineDash([]),e.setLineWidth(l.radius*r*.5),e.strokeEllipse(c.x,c.y,l.radius*r*.75,l.radius*r*.75)):e.fillEllipse(c.x,c.y,l.radius*r,l.radius*r)}}},et=class extends ut{validateRow(t){let[e]=t.reduce(([i,r],s)=>s&&!r?[i+1,!0]:[i,!!s],[0,!1]);return e===this.count}drawSquare(t,e,i){t.fillRect(e.x-i/2,e.y-i/2,i,i)}drawInCell(t,e,i,r){let s=n=>r?Re(n):n;for(let n of ze[this.count]){let l=a.add(e,a.scale(s(n.midpoint),i)),c=n.width*i;this.drawSquare(t,l,c)}}},dt=class extends et{constructor(t,e,i){super(t,e,i),this.isValid=i===1}validateRow(t){let[e]=t.reduce(([i,r],s)=>!s&&r?[i+1,!1]:[i,!!s],[0,!0]);return e===this.count}drawSquare(t,e,i){t.setLineDash([]),t.setLineWidth(i*.25),t.strokeRectInset(e.x,e.y,0,0,-i*.4)}},mt=class extends Tt{constructor(t,e){super(t,e),this.isValid=!0}validateRow(t){let e=0;for(let i of t)if(i?e+=1:e=0,e>=3)return!1;return!0}drawInCell(t,e,i,r){t.setLineWidth(i*.1),t.setLineDash([]),t.fillEllipse(e.x,e.y,.22*i,.22*i);let s=a.add(e,a.scale(r?new a(-.5,0):new a(0,.5),i));t.fillEllipse(s.x,s.y,.22*i,.22*i);let n=a.add(e,a.diff(e,s)),l=i*.22;t.drawLine(n.x-l,n.y-l,n.x+l,n.y+l),t.drawLine(n.x-l,n.y+l,n.x+l,n.y-l)}};var Dt=class extends U{constructor(){super(),this.drawnOnLeft=!0}draw(t,e){}},kt=class extends Dt{constructor(e){super();this.desiredCount=e,this.currentCount=0}validate(e,i){this.currentCount=0;for(let r of Object.values(i))r&&this.currentCount++;this.isValid=this.currentCount===this.desiredCount}drawNumber(e,i,r){let s=i.midpoint,n=Math.min(i.height,i.width),l=Math.ceil(Math.sqrt(r)),c=n/l,h=s.x-(l-1)*c/2,p=s.y-(l-1)*c/2;r===0&&(e.setLineWidth(4),e.strokeEllipse(s.x,s.y,n*.4,n*.4));for(let f=0;f<l;f++)for(let v=0;v<l;v++)f*l+v<r&&e.fillEllipse(h+v*c,p+f*c,c*.4,c*.4)}draw(e,i){this.isValid?e.setColor("white"):e.setColor("red");let r=i.width/2,s=i.height/2,n=i.midpoint;this.drawNumber(e,u.widthForm(i.x1,i.y1,r,s),this.currentCount),e.setLineWidth(4),e.drawLine(n.x-r*.67,n.y+s*.67,n.x+r*.67,n.y-s*.67),this.drawNumber(e,u.widthForm(n.x,n.y,r,s),this.desiredCount)}},Vt=class extends Dt{constructor(){super(),this.isValid=!0}validate(t,e){let r=[];for(let n of t){let l=[];for(let c of n)l.push(!!e[c.id]);r.push(l)}let s=[];for(let n=0;n<r.length;n++)for(let l=0;l<r[n].length;l++)if(r[n][l]){s.push([n,l]),n=r.length;break}for(;s.length>0;){let[n,l]=s.pop();r[n][l]===1||!r[n][l]||(r[n][l]=1,n>0&&s.push([n-1,l]),l>0&&s.push([n,l-1]),n+1<r.length&&s.push([n+1,l]),l+1<r[n].length&&s.push([n,l+1]))}this.isValid=!0;for(let n=0;n<r.length;n++)for(let l=0;l<r[n].length;l++)if(r[n][l]&&r[n][l]!==1){this.isValid=!1,n=r.length;break}}draw(t,e){this.isValid?t.setColor("white"):t.setColor("red");let i=e.midpoint,r=Math.min(e.width,e.height)/2;t.fillEllipse(i.x,i.y,r*.8,r*.8)}};var Ot=class{constructor(){this.validationItems=[]}addForcedCellValidator(t,e,i){return this.validationItems.push(new _t(t,e,i)),this}addCountAreaValidator(t,e,i){return this.validationItems.push(new At(t,e,i)),this}addEdgeValidators(t,e,i=ut){t.forEach((r,s)=>{typeof r=="number"&&this.validationItems.push(new i(e,s,r))})}addColumnCounts(t){return this.addEdgeValidators(t,!1),this}addRowCounts(t){return this.addEdgeValidators(t,!0),this}addColumnGroups(t){return this.addEdgeValidators(t,!1,et),this}addRowGroups(t){return this.addEdgeValidators(t,!0,et),this}addColumnBlankGroups(t){return this.addEdgeValidators(t,!1,dt),this}addRowBlankGroups(t){return this.addEdgeValidators(t,!0,dt),this}addColumnNoTriple(t){return t.forEach((e,i)=>{!e||this.validationItems.push(new mt(!1,i))}),this}addRowNoTriple(t){return t.forEach((e,i)=>{!e||this.validationItems.push(new mt(!0,i))}),this}setGlobalCount(t){return this.validationItems.push(new kt(t)),this}addContinentRule(){return this.validationItems.push(new Vt),this}create(){return new St(this.validationItems)}};var fe=(o,t)=>{let{rows:e,cols:i,config:r}=t,s=new Ot;return t.columnCounts&&s.addColumnCounts(t.columnCounts),t.rowCounts&&s.addRowCounts(t.rowCounts),t.columnGroups&&s.addColumnGroups(t.columnGroups),t.rowGroups&&s.addRowGroups(t.rowGroups),t.columnBlankGroups&&s.addColumnBlankGroups(t.columnBlankGroups),t.rowBlankGroups&&s.addRowBlankGroups(t.rowBlankGroups),t.columnNoTriple&&s.addColumnNoTriple(t.columnNoTriple),t.rowNoTriple&&s.addRowNoTriple(t.rowNoTriple),t.forcedCells&&t.forcedCells.forEach(n=>{s.addForcedCellValidator(n.row,n.col,n.on)}),t.countAreas&&t.countAreas.forEach(n=>{s.addCountAreaValidator(n.row,n.col,n.count)}),t.globalCount&&s.setGlobalCount(t.globalCount),t.continent&&s.addContinentRule(),new zt(o,e,i,s.create(),r)};function Qe(o){let t=I.puzzles;return o in t?fe(o,t[o]):(console.warn(`Cannot find puzzle with id: ${o}`),fe(o,{rows:1,cols:1,rowCounts:[1],columnCounts:[1]}))}var ge=class{constructor(){this.puzzleMap={}}loadPuzzle(t){return Qe(t)}getPuzzle(t){if(t in this.puzzleMap)return this.puzzleMap[t];let e=this.loadPuzzle(t);return this.puzzleMap[t]=e,e}},rt=new ge;var q=class extends S{constructor(e,i,r){super(e,i,u.centerForm(i.x,i.y,4,4),r);this.connectionPoint=new a(i.x,i.y+3.5),this.showAsMapIcon=!1}draw(e){super.draw(e),e.dynamicWorldCanvas.drawImage(A,this.prereqsActive?80:0,40,80,80,this.position.x-4,this.position.y-4,8,8)}update(e,i,r){this.level||(this.level=r),this.prereqsActive&&(this.showAsMapIcon=!0),super.update(e,i,r)}drawAsMapIcon(e,i){let r=i.interactingWith===this?"#08f":"red";e.setColor("black"),e.fillDiamond(0,0,7.5,10.5),e.setColor(r),e.fillDiamond(0,0,6,9)}onInteract(){if(this.level)return new Gt(this,this.level)}clickedOnMap(){if(this.level)return new Wt(this,this.level)}};var Y=class{constructor(){}isExitEvent(){return!1}isOpenPuzzleEvent(){return!1}isClosePuzzleEvent(){return!1}isOpenMapEvent(){return!1}process(t){}},Ht=class extends Y{constructor(e){super();this.exitTrigger=e}isExitEvent(){return!0}},st=class extends Y{constructor(e){super();this.puzzleId=e}isOpenPuzzleEvent(){return!0}},Nt=class extends Y{constructor(e){super();this.puzzleId=e}isClosePuzzleEvent(){return!0}},Gt=class extends Y{constructor(e,i){super();this.fromPortal=e,this.fromLevel=i}isOpenMapEvent(){return!0}},Wt=class extends Y{constructor(e,i){super();this.toPortal=e,this.toLevel=i}process(e){let i=e.currentLevel.interactingWith;i&&i instanceof q&&(e.currentLevel.interactingWith=void 0),e.goToPortal(this.toLevel,this.toPortal)}};var z=1,ti=!1,Ft=class extends S{constructor(e,i,r,s,n,l){super(e,i,r,s);this.puzzleId=n,this.connectionPoint=a.add(i,new a(0,1.2)),this.outputPoint=a.add(i,new a(l.isFlipped?-1:1,-1.15)),this.config=l}onStart(e){super.onStart(e),this._puzzle=rt.getPuzzle(this.puzzleId)}get puzzle(){return this._puzzle}draw(e){super.draw(e);let i=e.dynamicWorldCanvas,r=1/10;i.setColorRGB(0,0,0),i.fillRect(this.position.x-z/2,this.position.y+z,z,1),i.setLineWidth(r),this.isAreaActive&&(i.setColorRGB(255,255,255,128),i.strokeRectInset(this.position.x,this.position.y,0,0,-z-r*1.5)),i.setColorRGB(0,0,0),i.strokeRectInset(this.position.x,this.position.y,0,0,-z-r/2);let s=this.config.isFlipped?-1:1;i.fillRect(this.position.x+s*(z-r)-2*r,this.position.y-z-4*r,4*r,4*r),this.puzzle.hasBeenSolvedEver&&(this.isEnabled=!0,i.setColor("white"),i.fillRect(this.position.x+s*(z-r)-r,this.position.y-z-3*r,r*2,r*2)),this.prereqsActive&&(i.setColor(this.puzzle.isSolved?Z:ht),i.fillRect(this.position.x-z,this.position.y-z,z*2,z*2)),this.drawGrid(i)}drawGrid(e){let i=new a(this.position.x-z,this.position.y-z);e.translate(i.x,i.y),e.setColor("white");let r=this.puzzle.grid,s=z*2/(3*Math.max(r.length,r[0].length)+1),n=s*(3*r[0].length+1),l=s*(3*r.length+1),c=Math.max(0,(n-l)/2),h=Math.max(0,(l-n)/2);this.puzzle.miniElements.forEach(({row:p,col:f,shape:v})=>{if(this.puzzle.values[r[p][f].id]){let N=h+s*(3*v.x1+1),F=c+s*(3*v.y1+1),W=s*(3*v.width-1),E=s*(3*v.height-1);ti?e.fillEllipse(N+W/2,F+E/2,W/2,E/2):e.fillRect(N,F,W,E)}}),e.translate(-i.x,-i.y)}drawForMap(e){var r;let i=!!((r=this._puzzle)!=null&&r.hasBeenSolvedEver);e.setColor(i?Z:ht),e.fillRect(this.position.x-1,this.position.y-1,2,2),e.setColor("#222222"),e.setLineWidth(.2),e.setLineDash([]),e.strokeRectInset(this.position.x,this.position.y,0,0,-1.1),e.fillRect(this.position.x-.5,this.position.y+1.1,1,.9)}onInteract(){return new st(this.puzzleId)}};var Bt=class extends S{constructor(t,e,i,r){super(t,e,i,r)}update(t,e,i){this.isEnabled?this.isAreaActive=!1:super.update(t,e,i)}draw(t){super.draw(t);let e=t.dynamicWorldCanvas,i=1/10;this.isAreaActive&&(e.setColorRGB(255,255,255,128),e.setLineWidth(i),e.setLineDash([]),e.strokeRectInset(this.position.x-i*3,this.position.y-i*4,i*6,i*8,-i*1.5)),e.drawImage(A,this.isEnabled?80:40,0,10*4,10*4,this.position.x-2,this.position.y-2,4,4)}onInteract(){this.isEnabled=!0}};var ei=.3,Ut=class extends S{constructor(e,i,r,s=4,n={}){super(e,i,void 0,r);this.connectionPoint=a.add(i,new a((n.isFlipped?1:-1)*(s/2-.9),.3));let l=!n.isSingle;this.hasLeft=l||!n.isFlipped,this.hasRight=l||!!n.isFlipped,this.hasLedge=!!n.hasLedge,this.leftHead=u.widthForm(this.position.x-s/2,this.position.y,1.2,.8),this.rightHead=u.widthForm(this.position.x+s/2-1.2,this.position.y,1.2,.8),this.leftDoor=u.widthForm(this.position.x-s/2,this.position.y,this.hasRight?s/2:s,.6),this.rightDoor=u.widthForm(this.position.x-(this.hasLeft?0:s/2),this.position.y,this.hasLeft?s/2:s,.6),this.ledge=u.widthForm(this.position.x-s/2,this.position.y,s,.2),this.fullWidth=s/2,this.doorWidth=this.hasLeft&&this.hasRight?s/2:s}onStart(e){super.onStart(e),this.hasLeft&&(e.addWithoutDuplicate({type:1,rect:this.leftHead}),e.addWithoutDuplicate({type:1,rect:this.leftDoor})),this.hasRight&&(e.addWithoutDuplicate({type:1,rect:this.rightHead}),e.addWithoutDuplicate({type:1,rect:this.rightDoor})),this.hasLedge&&e.addWithoutDuplicate({type:2,rect:this.ledge})}update(e,i,r){super.update(e,i,r);let s=i/ei*(this.prereqsActive?-1:1);this.leftDoor.x2=b(this.leftDoor.x2+s,this.leftDoor.x1,this.leftDoor.x1+this.doorWidth),this.rightDoor.x1=b(this.rightDoor.x1-s,this.rightDoor.x2-this.doorWidth,this.rightDoor.x2)}draw(e){super.draw(e);let i=e.dynamicWorldCanvas;if(this.hasLedge)for(let r=this.ledge.x1;r<this.ledge.x2;r++)i.drawImage(ct,10,0,10,10,r,this.ledge.y1,1,1);if(this.hasLeft){let r=this.leftDoor.width;r>0&&(i.setColor("black"),this.leftDoor.draw(i),i.drawImage(A,160+Math.max(40-10*r,20)-10,10,Math.min(10*r,20),10,Math.max(this.leftDoor.x1,this.leftDoor.x2-2),this.position.y,Math.min(r,2),1)),i.drawImage(A,this.prereqsActive?180:160,0,12,8,this.leftHead.x1,this.leftHead.y1,this.leftHead.width,this.leftHead.height)}if(this.hasRight){let r=this.rightDoor.width;r>0&&(i.setColor("black"),this.rightDoor.draw(i),i.drawImage(A,170,30,Math.min(10*r,20),10,this.rightDoor.x1,this.position.y,Math.min(r,2),1)),i.drawImage(A,this.prereqsActive?188:168,20,12,8,this.rightHead.x1,this.rightHead.y1,this.rightHead.width,this.rightHead.height)}}drawForMap(e){e.setColor("black"),this.hasLeft&&this.leftDoor.draw(e),this.hasRight&&this.rightDoor.draw(e)}};var ii="0",qt=(o,t)=>o.toString(16).padStart(t,ii),pt=(o,t,e,i=255)=>`#${qt(o,2)}${qt(t,2)}${qt(e,2)}${qt(i,2)}`,ot=(o,t,e,i=1)=>`hsla(${o},${Math.floor(t*100)}%,${Math.floor(e*100)}%,${i})`,ri=(o,t,e)=>{let i=0,r=Math.min(o,t,e),s=Math.max(o,t,e);return s===o&&(i=(t-e)/(s-r)),s===t&&(i=2+(e-o)/(s-r)),s===e&&(i=4+(o-t)/(s-r)),isNaN(i)&&(i=0),i=i*60,i<0&&(i=i+360),i},si=o=>[parseInt(o.slice(1,3),16),parseInt(o.slice(3,5),16),parseInt(o.slice(5,7),16)],_e=o=>{let[t,e,i]=si(o);return ri(t,e,i)};var oi=1,Kt=class extends B{constructor(e,i,r,s,n={}){super(e);this.coverArea=i,this.extraCovers=r,this.triggerArea=s,this.coverIsTrigger=!!n.coverIsTrigger,this.canReCover=!!n.canReCover,this.isUncovered=!1,this.revealState=0}playerCollidesCover(e){return this.coverArea.intersectsPoint(e.position)||this.extraCovers.some(i=>i.intersectsPoint(e.position))}isPlayerTriggering(e){return this.triggerArea.intersectsPoint(e.position)||this.coverIsTrigger&&this.playerCollidesCover(e)}isOpen(e){return this.canReCover?this.isPlayerTriggering(e):this.isUncovered?!0:(this.isUncovered=this.isPlayerTriggering(e),this.isUncovered)}onStart(e){super.onStart(e)}update(e,i,r){super.update(e,i,r);let s=this.isOpen(e);this.revealState=b(this.revealState+(s?1:-1)*(i/oi),0,1),this.lastPlayerPos=e.position}draw(e){if(super.draw(e),this.revealState===1)return;let i=e.dynamicWorldCanvas;if(this.revealState===0)i.setColor("black");else{let r=this.coverArea.width+this.coverArea.height,s=r*.2,n=this.lastPlayerPos?a.lerp(this.lastPlayerPos,this.coverArea.midpoint,this.revealState):this.coverArea.midpoint,l=(r+s)*this.revealState,c=i.createRadialGradient(n.x,n.y,Math.max(0,l-s/2),n.x,n.y,l+s/2);c.addColorStop(0,pt(0,0,0,0)),c.addColorStop(1,pt(0,0,0,255)),i.setColor(c)}this.coverArea.draw(i),this.extraCovers.forEach(r=>r.draw(i))}drawForMap(e){if(this.revealState!==1){e.setColor("black");for(let i of this.extraCovers.concat(this.coverArea))i.draw(e,.05)}}};var Xt=class{constructor(t,e,i){this.collider=t,this.key=e,this.nextLevelCollider=i||t}hasEntered(t){return this.collider.intersectsPoint(t.position)}translatePlayerToNext(t){return a.diff(t.position,new a(this.nextLevelCollider.x1,this.nextLevelCollider.y1))}};var ni=Symbol("Up"),ai=Symbol("Down"),li=Symbol("Left"),ci=Symbol("Right"),hi=Symbol("Jump"),ui=Symbol("Interact"),di=Symbol("Escape"),mi=Symbol("Map"),g={Down:ai,Escape:di,Interact:ui,Jump:hi,Left:li,Right:ci,Up:ni,Map:mi};var Ae={" ":g.Jump,escape:g.Escape,esc:g.Escape,Escape:g.Escape,Esc:g.Escape,w:g.Up,a:g.Left,s:g.Down,d:g.Right,e:g.Interact,m:g.Map};function we(o){return window.TouchEvent&&o instanceof TouchEvent}var J=class{constructor(t,e,i=!1,r=!1){this.keyMap=t,this.mousePosition=e,this.leftClicking=i,this.rightClicking=r}getHorizontalAxis(){return+!!this.keyMap[g.Right]-+!!this.keyMap[g.Left]}getVerticalAxis(){return+!!this.keyMap[g.Down]-+!!this.keyMap[g.Up]}isPressed(t){return!!this.keyMap[t]}isLeftClicking(){return this.leftClicking}isRightClicking(){return this.rightClicking}static empty(){return new J({},new a(0,0))}},gt=class{constructor(){}isForKey(t){return!1}isClick(){return!1}isScroll(){return!1}},be=class extends gt{constructor(e){super();this.input=e}isForKey(e){return e===this.input}},jt=class extends gt{constructor(e,i){super();this.position=e,this.isRight=i}isClick(){return!0}isRightClick(){return this.isRight}},ft=class extends gt{constructor(e,i){super();this.delta=e,this.discrete=!!i}isScroll(){return!0}},Zt=class{constructor(t){this.leftClicking=!1,this.rightClicking=!1,this.isButtonDown={},this.listener=t,this.mousePosition=new a(0,0),this.canvas=document.getElementById("canvas")}init(){let t=i=>{this.listener&&this.listener(new be(i))};document.addEventListener("keydown",i=>{if(i.repeat)return;let r=Ae[i.key];!r||(this.isButtonDown[r]=!0,t(r))}),document.addEventListener("keyup",i=>{let r=Ae[i.key];!r||(this.isButtonDown[r]=!1)}),this.canvas.addEventListener(_?"touchmove":"mousemove",i=>{this.mousePosition=this.toCanvasPosition(i)}),this.canvas.addEventListener(_?"touchstart":"mousedown",i=>{var n,l;_&&i.preventDefault(),this.mousePosition=this.toCanvasPosition(i);let r=we(i)||i instanceof MouseEvent&&i.button===0,s=i instanceof MouseEvent&&i.button===2;r?((n=this.listener)==null||n.call(this,new jt(this.mousePosition,!1)),this.leftClicking=!0):s&&((l=this.listener)==null||l.call(this,new jt(this.mousePosition,!0)),this.rightClicking=!0)}),this.canvas.addEventListener(_?"touchend":"mouseup",i=>{let r=we(i)||i instanceof MouseEvent&&i.button===0,s=i instanceof MouseEvent&&i.button===2;r?this.leftClicking=!1:s&&(this.rightClicking=!1)}),this.canvas.addEventListener("contextmenu",i=>{i.preventDefault()}),this.canvas.addEventListener(_?"touchend":"mouseleave",()=>{this.leftClicking=!1,this.rightClicking=!1}),this.canvas.addEventListener("wheel",i=>{var r;(r=this.listener)==null||r.call(this,new ft(i.deltaY))});let e=(i,r)=>{let s=document.getElementById(i);!s||(s.addEventListener("touchstart",n=>{var l;n.preventDefault(),typeof r=="function"?(l=this.listener)==null||l.call(this,r()):(this.isButtonDown[r]=!0,t(r))}),s.addEventListener("touchcancel",n=>{n.preventDefault(),typeof r=="function"||(this.isButtonDown[r]=!1)}),s.addEventListener("touchend",n=>{n.preventDefault(),typeof r=="function"||(this.isButtonDown[r]=!1)}))};e("left",g.Left),e("right",g.Right),e("jump",g.Jump),e("down",g.Down),e("map",g.Map),e("exit",g.Escape),e("zoom-in",()=>new ft(1,!0)),e("zoom-out",()=>new ft(-1,!0))}toCanvasPosition(t){let e=we(t)?t.touches.item(0)||{clientX:0,clientY:0}:t;return a.scale(new a(e.clientX-this.canvas.offsetLeft+window.scrollX,e.clientY-this.canvas.offsetTop+window.scrollY),this.canvas.width/this.canvas.clientWidth*Q/$)}getInputState(){return new J(this.isButtonDown,this.mousePosition,this.leftClicking,this.rightClicking)}};var Yt=class{constructor(t,e,i){this.width=t,this.height=e,this.hue=_e(i)}lerpFactor(t,e){return(t+1)/e.parallax.length}*iterateArea(t,e,i,r){let s=0;for(let n=0;n<t;n+=i){let l=0;for(let c=0;c<e;c+=r)yield[l,s,u.widthForm(n,c,i,r)],l++;s++}}prepareCanvas(t,e,i,r,s){let n=this.lerpFactor(e,t),l=10*4,c=new a(32*l,18*l),h=new a(this.width*l,this.height*l),p=a.lerp(c,h,n),f=t.parallax[e],v=a.lerp(i,r,n);f.setColor(ot(this.hue,v.x,v.y)),s(f,p.x,p.y)}getBackgroundHSL(){return[this.hue,new a(.14,.64)]}getBackgroundColor(){let[t,{x:e,y:i}]=this.getBackgroundHSL();return ot(t,e,i)}draw(t){let e=new a(.14,.64),i=new a(.3,.24);t.background.setColor(ot(this.hue,e.x,e.y)),t.background.fillRect(0,0,t.background.width,t.background.height);for(let r of t.parallax)r.clear();this.prepareCanvas(t,0,e,i,(r,s,n)=>{for(let[l,c,h]of this.iterateArea(s,n,70,n))Math.random()>.95&&h.draw(r);for(let[l,c,h]of this.iterateArea(s,n,s,70))Math.random()>.95&&h.draw(r)}),this.prepareCanvas(t,1,e,i,(r,s,n)=>{for(let[l,c,h]of this.iterateArea(s,n,120,n))if(Math.random()>.9){r.setLineWidth(20*2),r.drawLine(h.x1,h.y1,h.x1,h.y2),r.drawLine(h.x2,h.y1,h.x2,h.y2);let f=10;r.setLineWidth(f*2);let v=Math.floor(Math.random()*240);for(let[N,F,W]of this.iterateArea(1,n,1,240)){let E=W.y1+v;r.drawLine(h.x1,E,h.x2,E);let x=20;r.outerCircleCorner(h.x2-20-x,E-f-x,20,0),r.outerCircleCorner(h.x1+20+x,E-f-x,20,Math.PI/2),r.outerCircleCorner(h.x1+20+x,E+f+x,20,Math.PI),r.outerCircleCorner(h.x2-20-x,E+f+x,20,Math.PI*3/2)}}}),this.prepareCanvas(t,2,e,i,(r,s,n)=>{let l=[],c=[];for(let h=0;h<s;h+=800)l.push(Math.random()*s);for(let h=0;h<n;h+=600)c.push(Math.random()*n);for(let[h,p,f]of this.iterateArea(s,n,50,50))(l.some(v=>f.xInRange(v))||c.some(v=>f.yInRange(v)))&&(r.setLineWidth(12),f.stroke(r),r.setLineWidth(6),Math.random()>.2&&r.drawLine(f.x1,f.y1,f.x2,f.y2),Math.random()>.2&&r.drawLine(f.x2,f.y1,f.x1,f.y2))}),this.prepareCanvas(t,3,e,i,(r,s,n)=>{for(let[l,c,h]of this.iterateArea(s,n,30,n))Math.random()>.92&&h.draw(r)})}updateCameras(t){let e=new a(0,0),i=t.camera;t.parallax.forEach((r,s)=>{t.parallaxCameras[s]=a.lerp(e,i,this.lerpFactor(s,t))})}};var Jt=1280/32,pi=u.centerForm(1280/2,720/2,y/2+V*8,y/2+V*8),$t=class{constructor(t,e,i,r,s,n,l,c,h,p,f){this.key=t,this.levelGrid=s,this.objects=n,this.player=l,this.exitTriggers=c,this.interactibles=h,this.entities=p,this.width=e,this.height=i,this.camera=this.getIdealCamera(),this.interactingWith=void 0,this.backgroundArtist=new Yt(e,i,r),this.drawnStatic=!1,this.playModeManager=void 0,this.worldPosition=f,this.visited=!1}start(t){this.onAwaken(),this.interactingWith=void 0,this.playModeManager=t,this.interactibles.forEach(e=>e.onStart(this)),this.entities.forEach(e=>e.onStart(this)),this.visited=!0,this.camera=this.getIdealCamera()}onAwaken(){this.drawnStatic=!1,this.interactibles.forEach(t=>t.onAwaken()),this.entities.forEach(t=>t.onAwaken())}addWithoutDuplicate(t){this.objects.find(({rect:e})=>e===t.rect)||this.objects.push(t)}emitEvent(t){this.playModeManager&&this.playModeManager.onLevelEvent(t)}feedPlayerInfo(t,e){e.key!==this.key&&console.error("Exit key mis-match");let i=e.translatePlayerToNext(t);this.player.position.x=i.x,this.player.position.y=i.y,this.player.velocity=t.velocity.copy(),this.camera=this.getIdealCamera()}update(t,e){var i;this.player.update(t,this.isPlayerActive()?e:J.empty(),this),this.interactibles.forEach(r=>{r.update(this.player,t,this)}),(i=this.interactingWith)!=null&&i.isAreaActive||this.closeCurrentPuzzle(),this.entities.forEach(r=>{r.update(this.player,t,this)}),this.interactingWith||this.updateCamera(t),this.updateExits()}isPlayerActive(){return!this.interactingWith}closeCurrentPuzzle(){this.interactingWith&&(this.emitEvent(new Nt(this.interactingWith.id)),this.interactingWith=void 0)}screenToWorldPos(t){return a.add(a.scale(t,1/(4*10)),this.camera)}onInput(t){var r;this.isPlayerActive()&&this.player.onInput(t);let e=t.isClick()&&!t.isRightClick(),i=t.isForKey(g.Interact);if(e||i)if(this.interactingWith)(i||!pi.intersectsPoint(t.position))&&this.closeCurrentPuzzle();else{let s=this.interactibles.find(n=>n.isAreaActive);if(s&&(i||((r=s.triggerArea)==null?void 0:r.intersectsPoint(this.screenToWorldPos(t.position))))){let l=s.onInteract();l&&(l.isOpenPuzzleEvent()||l.isOpenMapEvent())&&(this.interactingWith=s,this.emitEvent(l))}}else t.isForKey(g.Escape)&&this.closeCurrentPuzzle()}updateExits(){let t=this.exitTriggers.find(e=>e.hasEntered(this.player));t&&this.emitEvent(new Ht(t))}clampCamera(t){let e=new a(b(t.x,this.player.position.x-32+1,this.player.position.x-1),b(t.y,this.player.position.y-18+1,this.player.position.y-1));return new a(b(e.x,0,this.width-32),b(e.y,0,this.height-18))}getNaiveCamera(t=this.player.position){return new a(t.x-32/2,t.y-18/2)}getIdealCamera(t=this.player.position){return this.clampCamera(this.getNaiveCamera(t))}updateCamera(t){this.camera=this.clampCamera(a.lerp(this.camera,this.getNaiveCamera(a.add(this.player.position,new a(this.player.velocity.x*.3,0))),t*2))}withSetupCanvas(t,e){t.saveTransform(),t.scale(Jt,Jt),e(t),t.restoreTransform()}drawForMap(t){t.setColor(this.backgroundArtist.getBackgroundColor()),t.fillRect(0,0,this.width,this.height);for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){let r=this.levelGrid[e][i];r===1?(t.setColor("black"),t.fillRect(i-.05,e-.05,1.1,1.1)):r===2&&(t.setColor("black"),t.fillRect(i-.05,e-.05,1.1,.2))}for(let e of this.interactibles)e.drawForMap(t);for(let e of this.entities)e.drawForMap(t)}draw(t){this.drawnStatic||(this.backgroundArtist.draw(t),this.withSetupCanvas(t.staticWorldCanvas,e=>{e.clear(),e.setColor("black");for(let i=0;i<this.height;i++)for(let r=0;r<this.width;r++){let s=this.levelGrid[i][r];s&&e.drawImage(ct,(s-1)*10,0,10,10,r,i,1,1)}}),t.uiCanvas.clear(),this.drawnStatic=!0),this.withSetupCanvas(t.dynamicWorldCanvas,e=>{e.clear(),this.withSetupCanvas(t.behindGroundCanvas,()=>{t.behindGroundCanvas.clear(),this.interactibles.forEach(i=>{i.draw(t)}),this.player.draw(e),this.entities.forEach(i=>{i.draw(t)})})}),t.setCamera(new a(Math.floor(this.camera.x*Jt),Math.floor(this.camera.y*Jt))),this.backgroundArtist.updateCameras(t)}};var ve=class{constructor(){this.grid=[],this.shortGrid=[]}innerGet(t,e,i,r){return t in r||(r[t]=[]),e in r[t]||(r[t][e]=u.widthForm(e,t,1,i?.2:1)),r[t][e]}get(t,e,i=!1){return this.innerGet(t,e,i,i?this.shortGrid:this.grid)}},Te=new ve;var bt=.8,te=16,ee=te/.3,Ce=2*ee,fi=1.8*ee,gi=4,ke=.6,Ve=4*gi/ke,wi=Ve,De=2*Ve/ke,bi=.1,Qt=te*.5;function vi(o){return!!o}var ie=class{constructor(t){this.position=t,this.collider=new m(t,bt),this.velocity=new a(0,0),this.isDropping=!1,this.wantsToJump=!1,this.contactingAnyLedge=!1,this.inAirFor=1,this.state=2}onInput(t){t.isForKey(g.Jump)&&(this.wantsToJump=!0)}collideWithBlock(t,e,i){let r=!this.isDropping&&t===2&&this.velocity.y>=0&&this.position.y<e.y1,s=this.collider.intersectsRectangle(e);if(s&&t===2&&(this.contactingAnyLedge=!0,this.velocity.y<0&&this.position.y>=e.y1&&(this.isDropping=!0)),j.isSolid(t)||r){if(s){let n=e.uncollideCircle(this.collider);this.velocity.add(a.scale(n,1/i)),n.x>0&&n.y===0?this.velocity.x=Math.max(0,this.velocity.x):n.x<0&&n.y===0&&(this.velocity.x=Math.min(0,this.velocity.x)),n.y>0&&n.x===0?this.velocity.y=Math.max(0,this.velocity.y):n.y<0&&n.x===0&&(this.velocity.y=Math.min(0,this.velocity.y)),this.position.add(n)}return this.collider.intersectsRectangle(e)}}update(t,e,i){let r=(C,M)=>{var H;return(H=i.levelGrid[Math.floor(M)])==null?void 0:H[Math.floor(C)]},s=(C,M)=>{let H=r(C,M);if(H)return{type:r(C,M),rect:Te.get(Math.floor(M),Math.floor(C),H===2)}},n=e.getHorizontalAxis(),l=e.getVerticalAxis(),c=new a(n*ee,0);e.isPressed(g.Down)&&this.state!==1&&(this.isDropping=!0);let h=this.position.y+this.collider.radius,p=r(this.position.x,h),f=this.isDropping?j.isSolid(p):j.isGrounding(p),v=r(this.position.x,this.position.y),F=f&&h===Math.floor(h)||i.objects.some(({type:C,rect:M})=>(this.isDropping?j.isSolid(C):j.isGrounding(C))&&this.collider.isKissingBelow(M)),W=this.state===1&&v!==4;v===4&&l!==0?this.state=1:F?this.state=0:(!v||W)&&(W&&l<0&&(this.wantsToJump=!0),this.state=2);let E=(C,M,H)=>{if(O(C)){if(O(C)!==O(M))return-fi*O(M)}else return-Math.min(Math.abs(M/t),H)*O(M);return 0};if(this.state===0)this.inAirFor=0,c.x+=E(n,this.velocity.x,Ce),this.velocity.y=0;else if(this.state===1)this.inAirFor=0,c.y=e.getVerticalAxis()*ee,c.x+=E(n,this.velocity.x,Ce),c.y+=E(l,this.velocity.y,Ce);else if(this.inAirFor+=t,v===3){let C=this.velocity.y>0?0:1.1;c.y-=De*C}else c.y+=De;this.inAirFor<bi&&this.wantsToJump&&(this.wantsToJump=!1,this.velocity.y=-wi,this.state=2),this.velocity.add(a.scale(c,t)),this.state===1?(this.velocity.x=b(this.velocity.x,-Qt,Qt),this.velocity.y=b(this.velocity.y,-Qt,Qt)):this.velocity.x=b(this.velocity.x,-te,te);let x=a.scale(this.velocity,t);x.x=b(x.x,-bt,bt),x.y=b(x.y,-bt,bt),this.position.add(x);let{x:P,y:R}=this.position,It=[s(P,R),s(P,R+1),s(P,R-1),s(P-1,R),s(P+1,R),s(P-1,R-1),s(P+1,R-1),s(P-1,R+1),s(P+1,R+1)].filter(vi);this.contactingAnyLedge=!1,It.concat(i.objects).forEach(({type:C,rect:M})=>{this.collideWithBlock(C,M,t)}),this.isDropping=this.isDropping&&this.contactingAnyLedge}draw(t){t.setColor("white"),this.collider.draw(t)}};var re=class{constructor(t,e,i,r,s){this.key=t,this.iid=e,this.width=i,this.height=r,this.bgColor=s,this.levelGrid=[],this.objects=[],this.playerPosition=new a(16,9),this.exitTriggers=[],this.interactibles=[],this.entities=[],this.worldPosition=new a(0,0)}addObjects(t){return this.objects=this.objects.concat(t),this}addExits(t){return this.exitTriggers=this.exitTriggers.concat(t),this}addInteractibles(t){return this.interactibles=this.interactibles.concat(t),this}addEntities(t){return this.entities=this.entities.concat(t),this}setPlayerPos(t){return this.playerPosition=t,this}setLevelGrid(t){this.levelGrid=t}makeGridSpace(){this.levelGrid=[];for(let t=0;t<this.height;t++)this.levelGrid.push([])}setWorldPosition(t){this.worldPosition=t}setCell(t,e,i){this.levelGrid[t][e]=i}create(){return new $t(this.key,this.width,this.height,this.bgColor,this.levelGrid,this.objects,new ie(this.playerPosition),this.exitTriggers,this.interactibles,this.entities,this.worldPosition)}};var se=class extends B{constructor(e,i,r,s,n,l,c,h){super(e);this.position=i,this.width=r,this.height=s,this.tilesetPosition=n,this.tilesetWidth=l,this.tilesetHeight=c,this.scaling=h.includes("Scaling"),this.hasMobileAlt=h.includes("Mobile_alt")}draw(e){let i=e.behindGroundCanvas;if(this.scaling){i.drawImage(tt,this.tilesetPosition.x,this.tilesetPosition.y,this.tilesetWidth,10,this.position.x,this.position.y,this.width,1),i.drawImage(tt,this.tilesetPosition.x,this.tilesetPosition.y+this.tilesetHeight-10,this.tilesetWidth,10,this.position.x,this.position.y+this.height-1,this.width,1);let r=this.position.y+this.height-1,s=this.tilesetHeight/10-2;for(let n=this.position.y+1;n<this.position.y+this.height-1;n+=s){let l=Math.min(r-n,s);i.drawImage(tt,this.tilesetPosition.x,this.tilesetPosition.y+10,this.tilesetWidth,l*10,this.position.x,n,this.width,l)}}else i.drawImage(tt,this.tilesetPosition.x,this.tilesetPosition.y+(this.hasMobileAlt&&_?this.tilesetHeight:0),this.tilesetWidth,this.tilesetHeight,this.position.x,this.position.y,this.width,this.height)}};var oe=class extends S{constructor(e,i,r,s){super(e,i,void 0,r);this.puzzleId=s}onStart(e){super.onStart(e),this.puzzleId&&(this.puzzle=rt.getPuzzle(this.puzzleId))}update(e,i,r){super.update(e,i,r),this.isEnabled||(this.puzzle?this.isEnabled=this.puzzle.hasBeenSolvedEver&&this.prereqsActive:this.isEnabled=this.prereqsActive)}draw(e){super.draw(e)}onInteract(){return new st(this.puzzleId)}};var Ci="./data/world.json",Ei="./data/puzzles.json";function Oe(o){return fetch(o).then(t=>t.json())}function Ge(o,t){return o.find(e=>e.__identifier===t)}function ye(o,t){return o.find(e=>e.iid===t)}function Ee(o,t){return Ge(o.layerInstances,t)}function D(o){return Math.floor(o/10)}function ne(o){return o/10}function yi(o){return D(o[0])+1}function k(o,t){var e;return(e=Ge(o.fieldInstances,t))==null?void 0:e.__value}function at(o){return(k(o,"prerequisites")||[]).map(e=>e.entityIid)}function We(o,t){var r;let e=(r=k(o,"triggerArea"))==null?void 0:r.entityIid,i=e?ye(t,e):void 0;return i?vt(i):u.aroundPoint(new a(o.__grid[0]+2,o.__grid[1]+2),2,2)}function xe(o){return a.scale(new a(...o.px),1/10)}function xi(o,t){let e=o.iid,i=k(o,"key");i||console.warn("Puzzle with no key!");let r=new a(o.__grid[0]+2,o.__grid[1]+2),s={isFlipped:k(o,"isFlipped")};return new Ft(e,r,We(o,t),at(o),i,s)}function Ii(o,t){let e=o.iid;e||console.warn("Switch with no key!");let i=new a(o.__grid[0]+2,o.__grid[1]+2);return new Bt(e,i,We(o,t),at(o))}function Li(o){let t=o.iid;t||console.warn("Door with no key!");let e=a.add(xe(o),new a(2,2));return new Pt(t,e,at(o),D(o.height))}function Pi(o){let t=o.iid;t||console.warn("Trapdoor with no key!");let e=xe(o),i={isFlipped:k(o,"isFlipped"),hasLedge:k(o,"hasLedge"),isSingle:k(o,"isSingle")};return new Ut(t,e,at(o),D(o.width),i)}var vt=o=>u.widthForm(ne(o.px[0]),ne(o.px[1]),D(o.width),D(o.height));function Mi(o){return!!o}function zi(o,t){var c;let e=o.iid;e||console.warn("CoverEntity with no key!");let i=(c=k(o,"triggerArea"))==null?void 0:c.entityIid,r=ye(t,i)||o,n=(k(o,"extraCover")||[]).map(h=>ye(t,h.entityIid)).filter(Mi).map(vt),l={coverIsTrigger:k(o,"coverIsTrigger"),canReCover:k(o,"canReCover")};return new Kt(e,vt(o),n,vt(r),l)}function Si(o){return new se(o.iid,xe(o),D(o.width),D(o.height),new a(o.__tile.x,o.__tile.y),o.__tile.w,o.__tile.h,o.__tags)}function Ri(o){let t=o.iid,e=k(o,"key"),i=at(o);return!e&&!i.length&&console.warn("Node with no key or prerequisites!"),new oe(t,vt(o).midpoint,i,e)}function _i(o){let t=o.iid;return new q(t,new a(ne(o.px[0]),ne(o.px[1])),at(o))}function Ai(o){var l;let t=new re(o.identifier,o.iid,D(o.pxWid),D(o.pxHei),o.__bgColor);t.makeGridSpace();let e=Ee(o,"Solid");for(let c of e.gridTiles){let h=D(c.px[0]),p=D(c.px[1]),f=yi(c.src);t.setCell(p,h,f)}let i=!1,s=Ee(o,"EntityLayer").entityInstances;s.forEach(c=>{switch(c.__identifier){case"Util":break;case"PlayerStart":t.setPlayerPos(new a(c.__grid[0],c.__grid[1])),i=!0;break;case"PuzzleScreen":k(c,"key")||console.warn("Puzzle with unknown id in:",o.identifier),t.addInteractibles([xi(c,s)]);break;case"Switch":t.addInteractibles([Ii(c,s)]);break;case"Door":t.addInteractibles([Li(c)]);break;case"Trapdoor":t.addInteractibles([Pi(c)]);break;case"CoverEntity":t.addEntities([zi(c,s)]);break;case"Node":t.addInteractibles([Ri(c)]);break;case"Portal":t.addInteractibles([_i(c)]);break;default:console.warn("Processing unknown entity type:",c.__identifier)}});let n=(l=Ee(o,"Decorations"))==null?void 0:l.entityInstances;return n&&t.addEntities(n.map(Si)),i||console.warn(`Level ${o.identifier} is missing a PlayerStart`),t.setWorldPosition(new a(D(o.worldX),D(o.worldY))),t}function Ti(o,t){let e=t[o.iid];for(let i of o.__neighbours){let r=i.levelIid,s=t[r],n=a.diff(s.worldPosition,e.worldPosition),l=u.widthForm(n.x,n.y,s.width,s.height);e.addExits([new Xt(l,s.key,l)])}return e.create()}var K=class{static async fetchPuzzles(){let t=await Oe(Ei),{puzzlesByLevel:e}=t,i={};for(let r of Object.values(e))for(let s of Object.values(r))Object.assign(i,s);K.puzzles=i}static async fetchWorld(){let t=await Oe(Ci);K.data=t;let e={};t.levels.forEach(i=>{let r=Ai(i);e[r.iid]=r,e[r.key]=r}),t.levels.forEach(i=>{let r=Ti(i,e);K.levelMap[r.key]=r})}static async start(){await Promise.all([K.fetchPuzzles(),K.fetchWorld()])}static getLevel(t){return K.levelMap[t]}},I=K;I.hasLoaded=!1,I.data=null,I.levelMap={},I.puzzles={};var d=Symbol("ctx"),Ct=Symbol("canvas"),Et=class{constructor(t){this[Ct]=t;let e=t.getContext("2d");if(!e)throw Error("Unable to get 2d context");e.imageSmoothingEnabled=!1,this[d]=e,this[d].fillStyle="black",this[d].strokeStyle="black",this.width=this[Ct].width,this.height=this[Ct].height}fillRect(t,e,i,r){this[d].fillRect(t,e,i,r)}clear(){this[d].clearRect(0,0,this.width,this.height)}strokeRect(t,e,i,r){this[d].strokeRect(t,e,i,r)}strokeRectInset(t,e,i,r,s){this.strokeRect(t+s,e+s,i-s*2,r-s*2)}fillEllipse(t,e,i,r){this[d].beginPath(),this[d].ellipse(t,e,i,r,0,0,2*Math.PI),this[d].fill()}fillTriangle(t,e,i,r){this[d].beginPath(),this[d].moveTo(t,e+r),this[d].lineTo(t+i,e+r),this[d].lineTo(t+i/2,e),this[d].fill()}strokeEllipse(t,e,i,r){this[d].beginPath(),this[d].ellipse(t,e,i,r,0,0,2*Math.PI),this[d].stroke()}fillDiamond(t,e,i,r){this[d].beginPath(),this[d].moveTo(t,e-r),this[d].lineTo(t+i,e),this[d].lineTo(t,e+r),this[d].lineTo(t-i,e),this[d].lineTo(t,e-r),this[d].fill()}outerCircleCorner(t,e,i,r){this[d].beginPath(),this[d].arc(t,e,i,r,r+Math.PI/2);let s=r+Math.PI/4;this[d].lineTo(t+O(Math.cos(s))*i,e+O(Math.sin(s))*i),this[d].fill()}drawLine(t,e,i,r){this[d].beginPath(),this[d].moveTo(t,e),this[d].lineTo(i,r),this[d].stroke()}drawQuadratic(t,e,i,r,s,n){this[d].beginPath(),this[d].moveTo(t,e),this[d].quadraticCurveTo(s,n,i,r),this[d].stroke()}scale(t,e){this[d].scale(t,e)}translate(t,e){this[d].translate(t,e)}setLineWidth(t){this[d].lineWidth=t}get lineWidth(){return this[d].lineWidth}setLineDash(t){this[d].setLineDash(t)}setColor(t){t!==this[d].fillStyle&&(this[d].fillStyle=t,this[d].strokeStyle=t)}setColorRGB(t,e,i,r=255){this.setColor(pt(t,e,i,r))}setColorHSLA(t,e,i,r=1){this.setColor(ot(t,e,i,r))}createGradient(t,e,i,r){return this[d].createLinearGradient(t,e,i,r)}createRadialGradient(t,e,i,r,s,n){return this[d].createRadialGradient(t,e,i,r,s,n)}saveTransform(){this[d].save()}restoreTransform(){this[d].restore()}drawImage(t,e,i,r,s,n,l,c,h){let p;if(t instanceof Et)p=t[Ct];else if(t instanceof Image){if(!t.complete)return;p=t}else throw Error("Drawing something unmanageable");this[d].drawImage(p,e,i,r,s,n,l,c,h)}static fromId(t){let e=document.getElementById(t);if(!e||!(e instanceof HTMLCanvasElement))throw new Error(`Could not find canvas with id: "${t}"`);return new Et(e)}static fromScratch(t,e){let i=document.createElement("canvas");return i.width=t,i.height=e,new Et(i)}},L=Et;Ct,d;var He=document.location.toString().includes("localhost"),lt=20,Ne=.5,Di=.01,Fe=[.5,.75,1,1.5,2,3,5,7.5,10,15,20],Be=Fe.slice();Be.reverse();var ae=15,le=class{constructor(t){this.gameModeManager=t,this.playMode=t.playMode,this.cameraPosition=new a(0,0),this.setCameraPos(),this.zoom=2,this.mousePosition=new a(0,0),this.isClicked=!1,this.canvasW=0,this.canvasH=0,this.levelCanvasMap=new Map,this.drawIcons=[]}setCameraPos(){this.cameraPosition=a.add(this.playMode.currentLevel.worldPosition,this.playMode.currentLevel.player.position)}onStart(){this.setCameraPos(),this.mousePosition=new a(0,0),this.isClicked=!1,this.predrawLevels(),this.drawIcons=this.getIconsToShow(),this.gameModeManager.enableSections(["map-c","zoom-c"])}getIconsToShow(){let t=[];for(let e of Object.values(I.levelMap))for(let i of e.interactibles)i.showAsMapIcon&&t.push({level:e,interactible:i,position:a.add(e.worldPosition,i.position),isHovered:!1});return t}predrawLevels(){for(let t of Object.values(I.levelMap)){if(!He&&!t.visited)continue;let e=this.levelCanvasMap.get(t.key)||L.fromScratch(t.width*lt,t.height*lt);e.saveTransform(),e.scale(lt,lt),t.drawForMap(e),e.restoreTransform(),this.levelCanvasMap.set(t.key,e)}}toWorldPosition(t){return a.add(a.scale(a.diff(t,new a(this.canvasW/2,this.canvasH/2)),1/this.zoom),this.cameraPosition)}update(t,e){let i=this.toWorldPosition(e.mousePosition),r;for(let s of this.drawIcons){if(r){s.isHovered=!1;continue}a.sqrDist(s.position,i)<32?(s.isHovered=!0,r=s):s.isHovered=!1}e.isLeftClicking()&&this.isClicked?this.cameraPosition.subtract(a.diff(i,this.mousePosition)):this.isClicked=!1}onInput(t){if(t.isClick()){let e=this.drawIcons.find(s=>s.isHovered),i=this.playMode.currentLevel.interactingWith instanceof q;if(e&&i){let s=e.interactible.clickedOnMap();s&&(s.process(this.playMode),this.gameModeManager.switchToMode(this.playMode))}let r=t;r.isRightClick()||(this.mousePosition=this.toWorldPosition(r.position),this.isClicked=!0)}else if(t.isScroll()){let e=t;e.discrete?e.delta>0?this.zoom=Fe.find(i=>i>this.zoom)||lt:this.zoom=Be.find(i=>i<this.zoom)||Ne:this.zoom=b(this.zoom+e.delta*-Di,Ne,lt)}}draw(t){let e=this.playMode.currentLevel,i=t.uiCanvas;this.canvasW=i.width,this.canvasH=i.height,i.setColor("#223366"),i.fillRect(0,0,i.width,i.height),i.saveTransform(),i.translate(i.width/2,i.height/2),i.scale(this.zoom,this.zoom),i.translate(-this.cameraPosition.x,-this.cameraPosition.y);let r=e.player;for(let n of Object.values(I.levelMap)){let l=this.levelCanvasMap.get(n.key);!He&&!n.visited||!l||i.drawImage(l,0,0,l.width,l.height,n.worldPosition.x,n.worldPosition.y,n.width,n.height)}if(r){let n=a.add(e.worldPosition,r.position);i.translate(n.x,n.y),i.setLineWidth(2),i.setLineDash([]),i.scale(1/this.zoom,1/this.zoom),i.setColor("white"),i.fillEllipse(0,0,ae,ae),i.setColor("black"),i.strokeEllipse(0,0,ae,ae),i.scale(this.zoom,this.zoom),i.translate(-n.x,-n.y)}let s=this.zoom/2;for(let{level:n,interactible:l,isHovered:c}of this.drawIcons){let h=a.add(n.worldPosition,l.position);i.translate(h.x,h.y);let p=c?s*.8:s;i.scale(1/p,1/p),l.drawAsMapIcon(i,n),i.scale(p,p),i.translate(-h.x,-h.y)}i.restoreTransform()}};var ce=class{constructor(){let t="First_Level";if(location.href.includes("localhost")){window.setStartLevel=i=>{localStorage.setItem("start_level",i)};let e=localStorage.getItem("start_level");e&&(t=e)}this.levelMap={},this.currentLevel=I.getLevel(t),this.levelMap[t]=this.currentLevel}getInitialLevel(){return this.currentLevel}getLevel(t,e){let i=this.levelMap[t]||I.getLevel(t);return i.feedPlayerInfo(this.currentLevel.player,e),this.currentLevel=i,this.levelMap[t]=i,i}};var he=class{constructor(t){this.gameModeManager=t,this.levelManager=new ce,this.currentLevel=this.levelManager.getInitialLevel(),this.startLevel(this.currentLevel),this.puzzleManager=rt,this.currentPuzzle=void 0}goToPortal(t,e){t.player.position.setFrom(e.position),t.player.velocity=new a(0,0),this.startLevel(t)}startLevel(t){this.currentLevel=t,t.start(this)}onStart(){this.currentLevel.onAwaken(),this.gameModeManager.enableSections(["horizontal-movement","vertical-movement","map-c"])}onLevelEvent(t){var e;if(t.isExitEvent()){let i=t.exitTrigger;this.startLevel(this.levelManager.getLevel(i.key,i))}else t.isOpenPuzzleEvent()?(this.currentPuzzle=this.puzzleManager.getPuzzle(t.puzzleId),this.gameModeManager.enableSections(["exit-c"]),this.currentPuzzle.open()):t.isClosePuzzleEvent()?((e=this.currentPuzzle)==null||e.close(),this.gameModeManager.enableSections(["horizontal-movement","vertical-movement","map-c"])):t.isOpenMapEvent()&&this.gameModeManager.switchToMode(this.gameModeManager.mapMode)}update(t,e){var i,r;(i=this.currentLevel)==null||i.update(t,e),(r=this.currentPuzzle)==null||r.update(t,e)}onInput(t){var e,i;(e=this.currentLevel)==null||e.onInput(t),(i=this.currentPuzzle)==null||i.onInput(t)}draw(t){var e,i;(e=this.currentLevel)==null||e.draw(t),(i=this.currentPuzzle)==null||i.draw(t)}};var ki=["horizontal-movement","vertical-movement","map-c","exit-c","zoom-c"],ue=class{constructor(){this.playMode=new he(this),this.mapMode=new le(this),this.currentMode=this.playMode,this.playMode.onStart()}update(t,e){this.currentMode.update(t,e)}switchToMode(t){this.currentMode=t,t.onStart()}onInput(t){let e=!1;this.currentMode===this.playMode?t.isForKey(g.Map)&&(e=!0,this.switchToMode(this.mapMode)):this.currentMode===this.mapMode&&(t.isForKey(g.Escape)||t.isForKey(g.Map))&&(e=!1,this.switchToMode(this.playMode)),e||this.currentMode.onInput(t)}draw(t){this.currentMode.draw(t)}enableSections(t){var e,i;if(!!_){for(let r of ki)(e=document.getElementById(r))==null||e.classList.add("hidden");for(let r of t)(i=document.getElementById(r))==null||i.classList.remove("hidden")}}};var yt=Symbol("real-canvas");function Vi(){let o=document.getElementById("canvas");if(!(o instanceof HTMLCanvasElement))throw new Error("Could not find canvas");return o.width=$,o.height=Lt,o}var Ie=class{constructor(){let t=new L(Vi());if(!(t instanceof L))throw Error("No canvas found!");this[yt]=t,this.background=L.fromScratch(1280*3,720*4),this.parallax=[L.fromScratch(1280*3,720*4),L.fromScratch(1280*3,720*4),L.fromScratch(1280*3,720*4),L.fromScratch(1280*3,720*4),L.fromScratch(1280*3,720*4)],this.parallaxCameras=this.parallax.map(()=>new a(0,0)),this.behindGroundCanvas=L.fromScratch(1280*3,720*4),this.staticWorldCanvas=L.fromScratch(1280*3,720*4),this.dynamicWorldCanvas=L.fromScratch(1280*3,720*4),this.uiCanvas=L.fromScratch($,Lt),this.camera=new a(0,0)}setParallaxCameras(t){this.parallaxCameras=t}setCamera(t){this.camera=t}drawCanvas(t,e,i=1280,r=720){this[yt].drawImage(t,e.x,e.y,i,r,0,0,this[yt].width,this[yt].height)}drawToScreen(){this.drawCanvas(this.background,this.camera),this.parallax.forEach((t,e)=>{this.drawCanvas(t,this.parallaxCameras[e])}),this.drawCanvas(this.behindGroundCanvas,this.camera),this.drawCanvas(this.staticWorldCanvas,this.camera),this.drawCanvas(this.dynamicWorldCanvas,this.camera),this.drawCanvas(this.uiCanvas,new a(0,0),Q,X)}static getInstance(){return this.instance?this.instance:new Ie}},xt=Ie;yt,xt.instance=null;var Oi=1/20,Le=class{constructor(){this.screenManager=xt.getInstance(),this.gameModeManager=new ue,this.inputManager=new Zt(t=>this.onInput(t)),this.lastFrameTime=performance.now()}start(){this.inputManager.init(),this.lastFrameTime=performance.now(),requestAnimationFrame(()=>this.mainLoop())}onInput(t){this.gameModeManager.onInput(t)}mainLoop(){let t=performance.now(),e=Math.min((t-this.lastFrameTime)/1e3,Oi);this.gameModeManager.update(e,this.inputManager.getInputState()),this.gameModeManager.draw(this.screenManager),this.screenManager.drawToScreen(),requestAnimationFrame(()=>this.mainLoop()),this.lastFrameTime=t}};function de(o){let t=document.getElementById(o);return t||console.warn(`Can't find element with id: ${o}`),t}function Gi(){try{return window.self!==window.top}catch(o){return!0}}var Wi=()=>{var t,e,i;if(I.start().then(()=>{let r=new Le;r.start(),window.app=r}),_||(t=de("mobile-controls"))==null||t.remove(),_){(e=de("canvas"))==null||e.classList.add("fit-screen"),(i=de("mobile-controls"))==null||i.classList.remove("hidden");let r=de("fullscreen");r&&(Gi()?r.classList.add("hidden"):r.addEventListener("click",()=>{document.fullscreenElement?(r.classList.remove("smaller"),document.exitFullscreen()):document.body.requestFullscreen({navigationUI:"hide"}).then(()=>{r.classList.add("smaller")})}))}};window.onload=()=>{Wi()};})();
//# sourceMappingURL=index.js.map
