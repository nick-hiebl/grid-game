"use strict";(()=>{var B=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),he=1280,ti=720,_=720,Le=he,Pt=ti,S=3;var y=(n,t,e)=>Math.min(e,Math.max(n,t)),W=n=>n>0?1:n===0?0:-1;var l=class{constructor(t,e){this.x=t,this.y=e}add(t){return this.x+=t.x,this.y+=t.y,this}subtract(t){this.x-=t.x,this.y-=t.y}multiply(t){return this.x*=t,this.y*=t,this}copy(){return new l(this.x,this.y)}setFrom(t){this.x=t.x,this.y=t.y}get magnitude(){return Math.hypot(this.x,this.y)}static add(t,e){return new l(t.x+e.x,t.y+e.y)}static diff(t,e){return new l(t.x-e.x,t.y-e.y)}static scale(t,e){return new l(t.x*e,t.y*e)}static sqrDist(t,e){let i=t.x-e.x,r=t.y-e.y;return i*i+r*r}static manhattanDist(t,e){return Math.max(Math.abs(t.x-e.x),Math.abs(t.y-e.y))}static dist(t,e){return Math.hypot(t.x-e.x,t.y-e.y)}static lerp(t,e,i){return new l(t.x*(1-i)+e.x*i,t.y*(1-i)+e.y*i)}};var m=class{constructor(t,e){this.position=t,this.radius=e}intersectsCircle(t){let e=this.radius+t.radius;return l.sqrDist(this.position,t.position)<e*e}intersectsVector(t){return l.sqrDist(this.position,t)<this.radius*this.radius}intersectsRectangle(t){let e=y(this.position.x,t.x1,t.x2),i=y(this.position.y,t.y1,t.y2);return this.intersectsVector(new l(e,i))}isKissingBelow(t){return this.position.y+this.radius===t.y1&&t.x1<=this.position.x&&this.position.x<=t.x2}draw(t){t.fillEllipse(this.position.x,this.position.y,this.radius,this.radius)}stroke(t){t.strokeEllipse(this.position.x,this.position.y,this.radius,this.radius)}},h=class{constructor(t,e,i,r){this.x1=t,this.y1=e,this.x2=i,this.y2=r}intersectsPoint(t){return this.x1<=t.x&&t.x<=this.x2&&this.y1<=t.y&&t.y<=this.y2}get width(){return this.x2-this.x1}get height(){return this.y2-this.y1}get midpoint(){return new l((this.x1+this.x2)/2,(this.y1+this.y2)/2)}xInRange(t){return this.x1<=t&&t<this.x2}yInRange(t){return this.y1<=t&&t<this.y2}intersectsRectangle(t){return t.x1<=this.x2&&this.x1<=t.x2&&t.y1<=this.y2&&this.y1<=t.y2}uncollideCircle(t){let e=y(t.position.x,this.x1,this.x2),i=y(t.position.y,this.y1,this.y2),r=new l(e,i),o=l.diff(t.position,r),s=o.magnitude||1;if(s>=t.radius){let a=l.diff(t.position,this.midpoint),c=this.width/2-Math.abs(a.x),u=this.height/2-Math.abs(a.y);return c<u?new l((c+t.radius)*W(a.x),0):new l(0,(u+t.radius)*W(a.y))}return l.scale(o,(t.radius-s)/s)}draw(t,e=0){t.fillRect(this.x1-e,this.y1-e,this.width+e*2,this.height+e*2)}stroke(t,e=0){t.strokeRectInset(this.x1,this.y1,this.width,this.height,e)}inset(t){return new h(this.x1+t,this.y1+t,this.x2-t,this.y2-t)}static widthForm(t,e,i,r){return new h(t,e,t+i,e+r)}static centerForm(t,e,i,r){return new h(t-i,e-r,t+i,e+r)}static aroundPoint(t,e,i){return new h(t.x-e,t.y-i,t.x+e,t.y+i)}static merged(t){let[e,i,r,o]=t.reduce(([s,a,c,u],p)=>[Math.min(p.x1,s),Math.min(p.y1,a),Math.max(p.x2,c),Math.max(p.y2,u)],[1/0,1/0,-1/0,-1/0]);return new h(e,i,r,o)}};var ct=new Image;ct.src="/img/tileset.png";var T=new Image;T.src="/img/entity-set.png";var tt=new Image;tt.src="/img/decoration.png";var Y={isSolid:n=>n===1,isGrounding:n=>n===2||Y.isSolid(n)};var X=class{constructor(t){this.id=t}onStart(t){}onAwaken(){}update(t,e,i){}draw(t){}drawForMap(t){}drawAsMapIcon(t,e){}};var ei=!1,D=class extends X{constructor(e,i,r,o=[]){super(e);this.position=i,this.triggerArea=r,this.prerequisites=o,this.prereqsActive=o.length===0,this.prereqEntities=[],this.isEnabled=!1,this.isAreaActive=!1,this.connectionPoint=this.position,this.outputPoint=this.position,this.showAsMapIcon=!1}onStart(e){this.findPrerequisites(e)}onAwaken(){}findPrerequisites(e){return this.prereqEntities.length===this.prerequisites.length?this.prereqEntities:(this.prereqEntities=e.interactibles.filter(i=>this.prerequisites.includes(i.id)),this.prereqEntities)}update(e,i,r){var o;this.prereqsActive=this.prereqEntities.every(s=>s.isEnabled),this.isAreaActive=!!(this.prereqsActive&&((o=this.triggerArea)==null?void 0:o.intersectsPoint(e.position)))}draw(e){var r;let i=e.dynamicWorldCanvas;ei&&(i.setColorRGB(255,255,255),i.setLineWidth(.1),i.setLineDash([.2,.2]),(r=this.triggerArea)==null||r.stroke(i)),e.behindGroundCanvas.setLineWidth(.2);for(let o of this.prereqEntities){e.behindGroundCanvas.setColor(o.isEnabled?"white":"black");let s=l.manhattanDist(o.outputPoint,this.connectionPoint),a=l.lerp(o.outputPoint,this.connectionPoint,.5),c=l.add(a,new l(0,s*.3));e.behindGroundCanvas.drawQuadratic(o.outputPoint.x,o.outputPoint.y,this.connectionPoint.x,this.connectionPoint.y,c.x,c.y)}}clickedOnMap(){}onInteract(){}};var ii=.8,St=class extends D{constructor(e,i,r,o=4){super(e,i,void 0,r);this.connectionPoint=l.add(i,new l(0,-1.8)),this.headCollider=h.centerForm(this.position.x,this.position.y-1.8,.6,.4),this.doorCollider=h.widthForm(this.position.x-.5,this.position.y-2,1,o),this.fullHeight=o}onStart(e){super.onStart(e),e.addWithoutDuplicate({type:1,rect:this.headCollider}),e.addWithoutDuplicate({type:1,rect:this.doorCollider})}update(e,i,r){super.update(e,i,r);let o=this.fullHeight*i/ii*(this.prereqsActive?-1:1);this.doorCollider.y2=y(this.doorCollider.y2+o,this.doorCollider.y1,this.doorCollider.y1+this.fullHeight)}draw(e){super.draw(e);let i=e.dynamicWorldCanvas,r=this.doorCollider.height;r>0&&(i.setColor("black"),i.fillRect(this.position.x-.5,this.position.y-2,1,r),i.drawImage(T,120,Math.max(40-10*r,20)-10,40,Math.min(10*r,20),this.position.x-2,this.position.y-2+Math.max(r-2,0),4,Math.min(r,2))),i.drawImage(T,this.prereqsActive?140:128,0,12,6,this.position.x-6/10,this.position.y-2,12/10,6/10)}drawForMap(e){e.setColor("black"),this.doorCollider.draw(e)}};var Me=.4,Ae=.25,C=7/9*Pt,F="#00ff62dd",K="#0096ffdd",_e="#00cc22",De="#0060dd",A=[[new m(new l(0,0),.33)],[new m(new l(0,0),.33)],[new m(new l(0,.4),.33),new m(new l(0,-.4),.33)],[new m(new l(-.42,.4),.33),new m(new l(.42,.4),.33),new m(new l(0,-.4),.33)],[new m(new l(.4,.4),.33),new m(new l(.4,-.4),.33),new m(new l(-.4,.4),.33),new m(new l(-.4,-.4),.33)],[new m(new l(0,.3),.28),new m(new l(.64,.3),.28),new m(new l(-.64,.3),.28),new m(new l(-.32,-.3),.28),new m(new l(.32,-.3),.28)],[new m(new l(0,.6),.28),new m(new l(.64,.6),.28),new m(new l(-.64,.6),.28),new m(new l(-.32,0),.28),new m(new l(.32,0),.28),new m(new l(0,-.6),.28)],[new m(new l(0,0),.28),new m(new l(.64,0),.28),new m(new l(-.64,0),.28),new m(new l(-.32,-.6),.28),new m(new l(.32,-.6),.28),new m(new l(-.32,.6),.28),new m(new l(.32,.6),.28)],[new m(new l(0,.6),.28),new m(new l(.64,.6),.28),new m(new l(-.64,.6),.28),new m(new l(-.32,0),.28),new m(new l(.32,0),.28),new m(new l(0,-.6),.28),new m(new l(.64,-.6),.28),new m(new l(-.64,-.6),.28)]],U=[[h.centerForm(0,0,.33,.33)],[h.centerForm(0,0,.33,.33)],[h.centerForm(0,-.4,.33,.33),h.centerForm(0,.4,.33,.33)],[h.centerForm(0,-.4,.33,.33),h.centerForm(-.4,.4,.33,.33),h.centerForm(.4,.4,.33,.33)],[h.centerForm(-.4,-.4,.33,.33),h.centerForm(.4,-.4,.33,.33),h.centerForm(-.4,.4,.33,.33),h.centerForm(.4,.4,.33,.33)]],et=.12,ri=(1.6-4*et)/5,de=ri/2+et/2,Re=3*de,ht=n=>({inverted:!0,shapes:n}),M=n=>({inverted:!1,shapes:n}),me={calendar:M([h.widthForm(-.8,-.55,1.6,.2),h.widthForm(-.8,-.3,1.6,.2),h.widthForm(-.8,.2,1.6,.5),h.widthForm(-.8,-.3,.2,1),h.widthForm(-.3,-.3,.15,1),h.widthForm(.15,-.3,.15,1),h.widthForm(.6,-.3,.2,1),h.centerForm(-Re,-.6,et/2,.1),h.centerForm(-de,-.6,et/2,.1),h.centerForm(de,-.6,et/2,.1),h.centerForm(Re,-.6,et/2,.1)]),plus:M([h.centerForm(0,0,.1,.8),h.centerForm(0,0,.8,.1)]),minus:M([h.centerForm(0,0,.8,.1)]),"circle-0":ht(A[0]),"circle-1":M(A[1]),"circle-2":M(A[2]),"circle-3":M(A[3]),"circle-4":M(A[4]),"circle-5":M(A[5]),"circle-6":M(A[6]),"circle-7":M(A[7]),"circle-8":M(A[8]),"square-1":M(U[1]),"square-2":M(U[2]),"square-3":M(U[3]),"square-4":M(U[4]),"blank-square-1":ht(U[1].map(n=>n.inset(.1))),"blank-square-2":ht(U[2].map(n=>n.inset(.1))),"blank-square-3":ht(U[3].map(n=>n.inset(.05))),"blank-square-4":ht(U[4].map(n=>n.inset(.1)))};var pe={},oi=(n,t,e)=>`${n}-${t}-${e}`,ni=(n,t,e)=>{let o=e?1:.5,s=Math.floor(C/(t+.7+o)),a=Math.floor(C/(n+.7+.5)),c=Math.min(s,a),u=Math.floor(c*.5),p=Math.floor(c*o),f=Math.min(C-c*t-p,C-c*n-u),g=f+u+n*c,x=f+p+t*c,V=Math.max((x-g)/2,0),R=Math.max((g-x)/2,0),E=R+p,I=[[R,E]];for(let v=0;v<t;v++)I.push([E,E+c]),E+=c;I.push([E,E+f]);let z=V+f,k=[[V,z]];for(let v=0;v<n;v++)k.push([z,z+c]),z+=c;k.push([z,z+u]);let zt=[];for(let[v,P]of k){let H=[];for(let[$e,Qe]of I)H.push(new h($e,v,Qe,P));zt.push(H)}return zt},si=(n,t,e)=>{let i=oi(n,t,e);return i in pe||(pe[i]=ni(n,t,e)),pe[i]},ke=(n,t,e)=>{let i=si(n,t,!!e);return(r,o)=>i[r==="end"?n+1:r+1][o==="end"?t+1:o+1]};var ai=.4,li=!1,Lt=class{constructor(t,e,i,r,o={}){this.canvasWidth=0;this.canvasHeight=0;this.id=t,this.openCloseStatus=0,this.isOpen=!1,this.rows=e,this.cols=i,this.validator=r,this.isSolved=!1,this.hasBeenSolvedEver=!1;let s=0;this.positionGetter=ke(e,i,r.validationItems.some(a=>a.drawnOnLeft)),this.grid=[];for(let a=0;a<e;a++){let c=[];for(let u=0;u<i;u++){s++;let p={row:a,column:u,id:s};c.push(p)}this.grid.push(c)}if(o.combinedGroups)for(let a of o.combinedGroups){s++;let c=s;a.forEach(([u,p])=>{this.grid[u][p].id=c})}this.values={},this.cellMap={};for(let a of this.grid.flat())this.values[a.id]=null,this.cellMap[a.id]=a.id in this.cellMap?this.cellMap[a.id].concat([a]):[a];this.elements=[],this.miniElements=[];for(let a in this.cellMap){let c=this.cellMap[a];this.elements.push({row:c[0].row,col:c[0].column,shape:h.merged(c.map(({row:u,column:p})=>this.positionGetter(u,p))).inset(S),isHovered:!1}),this.miniElements.push({row:c[0].row,col:c[0].column,shape:h.merged(c.map(({row:u,column:p})=>h.widthForm(p,u,1,1))),isHovered:!1})}}open(t=0){this.isOpen||(this.isOpen=!0,this.openCloseStatus=t)}close(t){this.isOpen=!1,t!==void 0&&(this.openCloseStatus=t)}uiPosition(t){let e=Math.pow(1-this.openCloseStatus,2);t&&(this.canvasWidth=t.uiCanvas.width,this.canvasHeight=t.uiCanvas.height);let i=new l(0,Pt*e),r=new l((this.canvasWidth-C)/2,(this.canvasHeight-C)/2);return l.add(i,r)}draw(t,e){let i=t.uiCanvas;if(i.clear(),this.openCloseStatus===0)return;let r=this.uiPosition(t);if(i.translate(r.x,r.y),i.setColor(this.isSolved?F:K),i.fillRect(0,0,C,C),i.setColor("#222222"),e||i.fillRect(C/4,C,C/2,C),i.setLineWidth(S*8),i.setLineDash([]),i.strokeRectInset(0,0,C,C,-S*4),i.setColor("#ffffff64"),i.setLineWidth(S),i.strokeRectInset(0,0,C,C,S/2),li){i.setColor("red"),i.setLineDash([]);for(let o=-1;o<=this.rows;o++)for(let s=-1;s<=this.cols;s++)this.positionGetter(o,s).stroke(i)}for(let o of this.elements){o.isHovered?i.setColor("white"):i.setColor("#ffffff64"),i.setLineDash([]),o.shape.stroke(i,S/2);let s=this.getElementState(o),a=o.shape.midpoint,c=Math.min(o.shape.width,o.shape.height)*ai;s?(i.setColor("white"),i.fillEllipse(a.x,a.y,c,c)):s===!1&&(i.setColor("#ffffff64"),i.setLineDash([S*2,S*2]),i.strokeEllipse(a.x,a.y,c,c))}this.validator.draw(i,this.positionGetter),i.translate(-r.x,-r.y)}getRowColState(t,e){let i=this.grid[t][e];return this.values[i.id]}getElementState(t){return this.getRowColState(t.row,t.col)}setElementState(t,e){let i=this.grid[t.row][t.col];e!==this.values[i.id]&&(this.values[i.id]=e,this.onStateChange())}resolveClick(t,e,i){let r=this.getElementState(t);this.dragKind!==void 0&&(this.dragKind==="left"&&!e?(this.dragKind=void 0,this.dragState=void 0):this.dragKind==="right"&&!i&&(this.dragKind=void 0,this.dragState=void 0),this.dragKind==="left"?(this.dragState===void 0&&(r!==!0?this.dragState="enabling":this.dragState="emptying"),this.dragState==="enabling"?r!==!1&&this.setElementState(t,!0):this.dragState==="emptying"&&r!==!1&&this.setElementState(t,null)):this.dragKind==="right"&&(this.dragState===void 0&&(r!==!1?this.dragState="disabling":this.dragState="emptying"),this.dragState==="disabling"?r!==!0&&this.setElementState(t,!1):this.dragState==="emptying"&&r!==!0&&this.setElementState(t,null)))}findPositionElement(t){let e;for(let i of this.elements)i.isHovered=i.shape.intersectsPoint(t),i.isHovered&&(e=i);return e}update(t,e){if(this.isOpen&&this.openCloseStatus<1?this.openCloseStatus+=t/Me:!this.isOpen&&this.openCloseStatus>0&&(this.openCloseStatus-=t/Ae),this.openCloseStatus=y(this.openCloseStatus,0,1),e&&this.openCloseStatus===1){let i=l.diff(e.mousePosition,this.uiPosition()),r=this.findPositionElement(i);r&&this.resolveClick(r,e.isLeftClicking(),e.isRightClicking())}else this.dragState=void 0}onStateChange(){this.isSolved=this.validator.isValid(this.grid,this.values),this.isSolved&&(this.hasBeenSolvedEver=!0)}onInput(t){if(t.isClick()){let e=t,i=l.diff(e.position,this.uiPosition());this.dragKind=e.isRightClick()?"right":"left",this.dragState=void 0;let r=this.findPositionElement(i);r&&this.resolveClick(r,this.dragKind==="left",this.dragKind==="right")}}};var Rt=class{constructor(t){this.validationItems=t}isValid(t,e){return this.validationItems.forEach(i=>{i.validate(t,e)}),this.validationItems.every(i=>i.isValid)}getLeftArea(t,e,i){if(this.leftAreas)return this.leftAreas[t];let r=h.merged([i(-1,-1),i("end",-1)]),o=r.width,s=r.midpoint.y-o*(e+.1*(e-1));this.leftAreas=[];for(let a=0;a<e;a++)this.leftAreas.push(h.widthForm(r.x1,s+a*o*1.1,o,o));return this.leftAreas[t]}draw(t,e,...i){this.validationItems.forEach(o=>{o.drawnOnLeft||o.draw(t,e,...i)});let r=this.validationItems.filter(o=>o.drawnOnLeft);r.forEach((o,s)=>{o.draw(t,this.getLeftArea(s,r.length,e))})}},j=class{constructor(){this.isValid=!1,this.drawnOnLeft=!1}validate(t,e){}draw(t,...e){}};var Mt=class extends j{constructor(e,i){super();this.row=e,this.column=i}},At=class extends Mt{constructor(e,i,r){super(e,i);this.mustBeOn=r,this.isValid=!r}validate(e,i){let r=e[this.row][this.column];this.isValid=!!i[r.id]==!!this.mustBeOn}draw(e,i){this.isValid?e.setColor("white"):e.setColor("red");let r=i(this.row,this.column),o=Math.min(r.width,r.height),s=new l(r.x2-o*.15,r.y1+o*.15);this.mustBeOn?e.fillEllipse(s.x,s.y,o*.1,o*.1):(e.setLineWidth(o*.05),e.setLineDash([]),e.strokeEllipse(s.x,s.y,o*.075,o*.075))}},_t=class extends Mt{constructor(e,i,r){super(e,i);this.desiredCount=r,this.isValid=r===0,this.isCellColoured=!1}*iterateArea(e){for(let i=Math.max(this.row-1,0);i<=Math.min(this.row+1,e.length-1);i++)for(let r=Math.max(this.column-1,0);r<=Math.min(this.column+1,e[i].length-1);r++)yield[i,r]}validate(e,i){let r=0,o=new Set;for(let[s,a]of this.iterateArea(e)){let c=e[s][a];!!i[c.id]&&!o.has(c.id)&&(r++,o.add(c.id))}this.isValid=r===this.desiredCount,this.isCellColoured=!!i[e[this.row][this.column].id]}draw(e,i){this.isValid?e.setColor(this.isCellColoured?F:"white"):e.setColor("red");let r=i(this.row,this.column),o=Math.min(r.width,r.height)*.25,s=r.midpoint;for(let a of A[this.desiredCount]){let c=l.add(s,l.scale(a.position,o));this.desiredCount===0?(e.setLineWidth(a.radius*o*.5),e.strokeEllipse(c.x,c.y,a.radius*o*.75,a.radius*o*.75)):e.fillEllipse(c.x,c.y,a.radius*o,a.radius*o)}}};var Te=n=>new l(-n.y,n.x),Dt=class extends j{constructor(e,i){super();this.isRow=e,this.index=i,this.isValid=!1}getRelevantRow(e,i){let r=this.isRow?e[this.index]:e.map(s=>s[this.index]),[o]=r.reduce(([s,a],c)=>[c.id===a?s:s.concat([i[c.id]]),c.id],[[],-1]);return o}validateRow(e){throw new TypeError("Cannot validate as a generic EdgeValidationItem")}validate(e,i){let r=this.getRelevantRow(e,i);this.isValid=this.validateRow(r)}drawInCell(e,i,r,o){throw new TypeError("Cannot draw a generic EdgeValidationItem")}draw(e,i){if(this.isValid?e.setColor("white"):e.setColor("red"),this.isRow){let r=i(this.index,"end");this.drawInCell(e,r.midpoint,r.width/2,!0)}else{let r=i(-1,this.index);this.drawInCell(e,r.midpoint,r.height/2,!1)}}},ut=class extends Dt{constructor(e,i,r){super(e,i);this.count=r,this.isValid=r===0}validateRow(e){return e.reduce((r,o)=>o?r+1:r,0)===this.count}drawInCell(e,i,r,o){let s=o?a=>new m(Te(a.position),a.radius):a=>a;for(let a of A[this.count]){a=s(a);let c=l.add(i,l.scale(a.position,r));this.count===0?(e.setLineDash([]),e.setLineWidth(a.radius*r*.5),e.strokeEllipse(c.x,c.y,a.radius*r*.75,a.radius*r*.75)):e.fillEllipse(c.x,c.y,a.radius*r,a.radius*r)}}},it=class extends ut{validateRow(t){let[e]=t.reduce(([i,r],o)=>o&&!r?[i+1,!0]:[i,!!o],[0,!1]);return e===this.count}drawSquare(t,e,i){t.fillRect(e.x-i/2,e.y-i/2,i,i)}drawInCell(t,e,i,r){let o=s=>r?Te(s):s;for(let s of U[this.count]){let a=l.add(e,l.scale(o(s.midpoint),i)),c=s.width*i;this.drawSquare(t,a,c)}}},dt=class extends it{constructor(t,e,i){super(t,e,i),this.isValid=i===1}validateRow(t){let[e]=t.reduce(([i,r],o)=>!o&&r?[i+1,!1]:[i,!!o],[0,!0]);return e===this.count}drawSquare(t,e,i){t.setLineDash([]),t.setLineWidth(i*.25),t.strokeRectInset(e.x,e.y,0,0,-i*.4)}},mt=class extends Dt{constructor(t,e){super(t,e),this.isValid=!0}validateRow(t){let e=0;for(let i of t)if(i?e+=1:e=0,e>=3)return!1;return!0}drawInCell(t,e,i,r){t.setLineWidth(i*.1),t.setLineDash([]),t.fillEllipse(e.x,e.y,.22*i,.22*i);let o=l.add(e,l.scale(r?new l(-.5,0):new l(0,.5),i));t.fillEllipse(o.x,o.y,.22*i,.22*i);let s=l.add(e,l.diff(e,o)),a=i*.22;t.drawLine(s.x-a,s.y-a,s.x+a,s.y+a),t.drawLine(s.x-a,s.y+a,s.x+a,s.y-a)}};var kt=class extends j{constructor(){super(),this.drawnOnLeft=!0}draw(t,e){}},Tt=class extends kt{constructor(e){super();this.desiredCount=e,this.currentCount=0}validate(e,i){this.currentCount=0;for(let r of Object.values(i))r&&this.currentCount++;this.isValid=this.currentCount===this.desiredCount}drawNumber(e,i,r){let o=i.midpoint,s=Math.min(i.height,i.width),a=Math.ceil(Math.sqrt(r)),c=s/a,u=o.x-(a-1)*c/2,p=o.y-(a-1)*c/2;r===0&&(e.setLineWidth(4),e.strokeEllipse(o.x,o.y,s*.4,s*.4));for(let f=0;f<a;f++)for(let g=0;g<a;g++)f*a+g<r&&e.fillEllipse(u+g*c,p+f*c,c*.4,c*.4)}draw(e,i){this.isValid?e.setColor("white"):e.setColor("red");let r=i.width/2,o=i.height/2,s=i.midpoint;this.drawNumber(e,h.widthForm(i.x1,i.y1,r,o),this.currentCount),e.setLineWidth(4),e.drawLine(s.x-r*.67,s.y+o*.67,s.x+r*.67,s.y-o*.67),this.drawNumber(e,h.widthForm(s.x,s.y,r,o),this.desiredCount)}},Ot=class extends kt{constructor(){super(),this.isValid=!0}validate(t,e){let r=[];for(let s of t){let a=[];for(let c of s)a.push(!!e[c.id]);r.push(a)}let o=[];for(let s=0;s<r.length;s++)for(let a=0;a<r[s].length;a++)if(r[s][a]){o.push([s,a]),s=r.length;break}for(;o.length>0;){let[s,a]=o.pop();r[s][a]===1||!r[s][a]||(r[s][a]=1,s>0&&o.push([s-1,a]),a>0&&o.push([s,a-1]),s+1<r.length&&o.push([s+1,a]),a+1<r[s].length&&o.push([s,a+1]))}this.isValid=!0;for(let s=0;s<r.length;s++)for(let a=0;a<r[s].length;a++)if(r[s][a]&&r[s][a]!==1){this.isValid=!1,s=r.length;break}}draw(t,e){this.isValid?t.setColor("white"):t.setColor("red");let i=e.midpoint,r=Math.min(e.width,e.height)/2;t.fillEllipse(i.x,i.y,r*.8,r*.8)}};var Gt=class{constructor(){this.validationItems=[]}addForcedCellValidator(t,e,i){return this.validationItems.push(new At(t,e,i)),this}addCountAreaValidator(t,e,i){return this.validationItems.push(new _t(t,e,i)),this}addEdgeValidators(t,e,i=ut){t.forEach((r,o)=>{typeof r=="number"&&this.validationItems.push(new i(e,o,r))})}addColumnCounts(t){return this.addEdgeValidators(t,!1),this}addRowCounts(t){return this.addEdgeValidators(t,!0),this}addColumnGroups(t){return this.addEdgeValidators(t,!1,it),this}addRowGroups(t){return this.addEdgeValidators(t,!0,it),this}addColumnBlankGroups(t){return this.addEdgeValidators(t,!1,dt),this}addRowBlankGroups(t){return this.addEdgeValidators(t,!0,dt),this}addColumnNoTriple(t){return t.forEach((e,i)=>{!e||this.validationItems.push(new mt(!1,i))}),this}addRowNoTriple(t){return t.forEach((e,i)=>{!e||this.validationItems.push(new mt(!0,i))}),this}setGlobalCount(t){return this.validationItems.push(new Tt(t)),this}addContinentRule(){return this.validationItems.push(new Ot),this}create(){return new Rt(this.validationItems)}};var pt=(n,t)=>{let{rows:e,cols:i,config:r}=t,o=new Gt;return t.columnCounts&&o.addColumnCounts(t.columnCounts),t.rowCounts&&o.addRowCounts(t.rowCounts),t.columnGroups&&o.addColumnGroups(t.columnGroups),t.rowGroups&&o.addRowGroups(t.rowGroups),t.columnBlankGroups&&o.addColumnBlankGroups(t.columnBlankGroups),t.rowBlankGroups&&o.addRowBlankGroups(t.rowBlankGroups),t.columnNoTriple&&o.addColumnNoTriple(t.columnNoTriple),t.rowNoTriple&&o.addRowNoTriple(t.rowNoTriple),t.forcedCells&&t.forcedCells.forEach(s=>{o.addForcedCellValidator(s.row,s.col,s.on)}),t.countAreas&&t.countAreas.forEach(s=>{o.addCountAreaValidator(s.row,s.col,s.count)}),t.globalCount&&o.setGlobalCount(t.globalCount),t.continent&&o.addContinentRule(),new Lt(n,e,i,o.create(),r)};function ci(n){let t=N.puzzles;return n in t?pt(n,t[n]):(console.warn(`Cannot find puzzle with id: ${n}`),pt(n,{rows:1,cols:1,rowCounts:[1],columnCounts:[1]}))}var fe=class{constructor(){this.puzzleMap={}}loadPuzzle(t){return ci(t)}getPuzzle(t){if(t in this.puzzleMap)return this.puzzleMap[t];let e=this.loadPuzzle(t);return this.puzzleMap[t]=e,e}insertPuzzle(t,e){if(t in this.puzzleMap)return this.puzzleMap[t];let i=pt(t,e);return this.puzzleMap[t]=i,i}instantiate(t){return pt("placeholder",t)}},q=new fe;var ot=class extends D{constructor(e,i,r){super(e,i,h.centerForm(i.x,i.y,4,4),r);this.connectionPoint=new l(i.x,i.y+3.5),this.showAsMapIcon=!1}draw(e){super.draw(e),e.dynamicWorldCanvas.drawImage(T,this.prereqsActive?80:0,40,80,80,this.position.x-4,this.position.y-4,8,8)}update(e,i,r){this.level||(this.level=r),this.prereqsActive&&(this.showAsMapIcon=!0),super.update(e,i,r)}drawAsMapIcon(e,i){let r=i.interactingWith===this?"#08f":"red";e.setColor("black"),e.fillDiamond(0,0,7.5,10.5),e.setColor(r),e.fillDiamond(0,0,6,9)}onInteract(){if(this.level)return new Vt(this,this.level)}clickedOnMap(){if(this.level)return new Wt(this,this.level)}};var J=class{constructor(){}isExitEvent(){return!1}isOpenPuzzleEvent(){return!1}isClosePuzzleEvent(){return!1}isOpenMapEvent(){return!1}process(t){}},Nt=class extends J{constructor(e){super();this.exitTrigger=e}isExitEvent(){return!0}},nt=class extends J{constructor(e){super();this.puzzleId=e}isOpenPuzzleEvent(){return!0}},Ft=class extends J{constructor(e){super();this.puzzleId=e}isClosePuzzleEvent(){return!0}},Vt=class extends J{constructor(e,i){super();this.fromPortal=e,this.fromLevel=i}isOpenMapEvent(){return!0}},Wt=class extends J{constructor(e,i){super();this.toPortal=e,this.toLevel=i}process(e){let i=e.currentLevel.interactingWith;i&&i instanceof ot&&(e.currentLevel.interactingWith=void 0),e.goToPortal(this.toLevel,this.toPortal)}};var L=1,hi=!1,Ht=class extends D{constructor(e,i,r,o,s,a){super(e,i,r,o);this.puzzleId=s,this.connectionPoint=l.add(i,new l(0,1.2)),this.outputPoint=l.add(i,new l(a.isFlipped?-1:1,-1.15)),this.config=a}onStart(e){super.onStart(e),this._puzzle=q.getPuzzle(this.puzzleId)}get puzzle(){return this._puzzle}draw(e){super.draw(e);let i=e.dynamicWorldCanvas,r=1/10;i.setColorRGB(0,0,0),i.fillRect(this.position.x-L/2,this.position.y+L,L,1),i.setLineWidth(r),this.isAreaActive&&(i.setColorRGB(255,255,255,128),i.strokeRectInset(this.position.x,this.position.y,0,0,-L-r*1.5)),i.setColorRGB(0,0,0),i.strokeRectInset(this.position.x,this.position.y,0,0,-L-r/2);let o=this.config.isFlipped?-1:1;i.fillRect(this.position.x+o*(L-r)-2*r,this.position.y-L-4*r,4*r,4*r),this.puzzle.hasBeenSolvedEver&&(this.isEnabled=!0,i.setColor("white"),i.fillRect(this.position.x+o*(L-r)-r,this.position.y-L-3*r,r*2,r*2)),this.prereqsActive&&(i.setColor(this.puzzle.isSolved?F:K),i.fillRect(this.position.x-L,this.position.y-L,L*2,L*2)),this.drawGrid(i)}drawGrid(e){let i=new l(this.position.x-L,this.position.y-L);e.translate(i.x,i.y),e.setColor("white");let r=this.puzzle.grid,o=L*2/(3*Math.max(r.length,r[0].length)+1),s=o*(3*r[0].length+1),a=o*(3*r.length+1),c=Math.max(0,(s-a)/2),u=Math.max(0,(a-s)/2);this.puzzle.miniElements.forEach(({row:p,col:f,shape:g})=>{if(this.puzzle.values[r[p][f].id]){let x=u+o*(3*g.x1+1),V=c+o*(3*g.y1+1),R=o*(3*g.width-1),E=o*(3*g.height-1);hi?e.fillEllipse(x+R/2,V+E/2,R/2,E/2):e.fillRect(x,V,R,E)}}),e.translate(-i.x,-i.y)}drawForMap(e){var r;let i=!!((r=this._puzzle)!=null&&r.hasBeenSolvedEver);e.setColor(i?F:K),e.fillRect(this.position.x-1,this.position.y-1,2,2),e.setColor("#222222"),e.setLineWidth(.2),e.setLineDash([]),e.strokeRectInset(this.position.x,this.position.y,0,0,-1.1),e.fillRect(this.position.x-.5,this.position.y+1.1,1,.9)}onInteract(){return new nt(this.puzzleId)}};var Bt=class extends D{constructor(t,e,i,r){super(t,e,i,r)}update(t,e,i){this.isEnabled?this.isAreaActive=!1:super.update(t,e,i)}draw(t){super.draw(t);let e=t.dynamicWorldCanvas,i=1/10;this.isAreaActive&&(e.setColorRGB(255,255,255,128),e.setLineWidth(i),e.setLineDash([]),e.strokeRectInset(this.position.x-i*3,this.position.y-i*4,i*6,i*8,-i*1.5)),e.drawImage(T,this.isEnabled?80:40,0,10*4,10*4,this.position.x-2,this.position.y-2,4,4)}onInteract(){this.isEnabled=!0}};var ui=.3,Ut=class extends D{constructor(e,i,r,o=4,s={}){super(e,i,void 0,r);this.connectionPoint=l.add(i,new l((s.isFlipped?1:-1)*(o/2-.9),.3));let a=!s.isSingle;this.hasLeft=a||!s.isFlipped,this.hasRight=a||!!s.isFlipped,this.hasLedge=!!s.hasLedge,this.leftHead=h.widthForm(this.position.x-o/2,this.position.y,1.2,.8),this.rightHead=h.widthForm(this.position.x+o/2-1.2,this.position.y,1.2,.8),this.leftDoor=h.widthForm(this.position.x-o/2,this.position.y,this.hasRight?o/2:o,.6),this.rightDoor=h.widthForm(this.position.x-(this.hasLeft?0:o/2),this.position.y,this.hasLeft?o/2:o,.6),this.ledge=h.widthForm(this.position.x-o/2,this.position.y,o,.2),this.fullWidth=o/2,this.doorWidth=this.hasLeft&&this.hasRight?o/2:o}onStart(e){super.onStart(e),this.hasLeft&&(e.addWithoutDuplicate({type:1,rect:this.leftHead}),e.addWithoutDuplicate({type:1,rect:this.leftDoor})),this.hasRight&&(e.addWithoutDuplicate({type:1,rect:this.rightHead}),e.addWithoutDuplicate({type:1,rect:this.rightDoor})),this.hasLedge&&e.addWithoutDuplicate({type:2,rect:this.ledge})}update(e,i,r){super.update(e,i,r);let o=i/ui*(this.prereqsActive?-1:1);this.leftDoor.x2=y(this.leftDoor.x2+o,this.leftDoor.x1,this.leftDoor.x1+this.doorWidth),this.rightDoor.x1=y(this.rightDoor.x1-o,this.rightDoor.x2-this.doorWidth,this.rightDoor.x2)}draw(e){super.draw(e);let i=e.dynamicWorldCanvas;if(this.hasLedge)for(let r=this.ledge.x1;r<this.ledge.x2;r++)i.drawImage(ct,10,0,10,10,r,this.ledge.y1,1,1);if(this.hasLeft){let r=this.leftDoor.width;r>0&&(i.setColor("black"),this.leftDoor.draw(i),i.drawImage(T,160+Math.max(40-10*r,20)-10,10,Math.min(10*r,20),10,Math.max(this.leftDoor.x1,this.leftDoor.x2-2),this.position.y,Math.min(r,2),1)),i.drawImage(T,this.prereqsActive?180:160,0,12,8,this.leftHead.x1,this.leftHead.y1,this.leftHead.width,this.leftHead.height)}if(this.hasRight){let r=this.rightDoor.width;r>0&&(i.setColor("black"),this.rightDoor.draw(i),i.drawImage(T,170,30,Math.min(10*r,20),10,this.rightDoor.x1,this.position.y,Math.min(r,2),1)),i.drawImage(T,this.prereqsActive?188:168,20,12,8,this.rightHead.x1,this.rightHead.y1,this.rightHead.width,this.rightHead.height)}}drawForMap(e){e.setColor("black"),this.hasLeft&&this.leftDoor.draw(e),this.hasRight&&this.rightDoor.draw(e)}};var di="0",qt=(n,t)=>n.toString(16).padStart(t,di),ft=(n,t,e,i=255)=>`#${qt(n,2)}${qt(t,2)}${qt(e,2)}${qt(i,2)}`,st=(n,t,e,i=1)=>`hsla(${n},${Math.floor(t*100)}%,${Math.floor(e*100)}%,${i})`,mi=(n,t,e)=>{let i=0,r=Math.min(n,t,e),o=Math.max(n,t,e);return o===n&&(i=(t-e)/(o-r)),o===t&&(i=2+(e-n)/(o-r)),o===e&&(i=4+(n-t)/(o-r)),isNaN(i)&&(i=0),i=i*60,i<0&&(i=i+360),i},pi=n=>[parseInt(n.slice(1,3),16),parseInt(n.slice(3,5),16),parseInt(n.slice(5,7),16)],Oe=n=>{let[t,e,i]=pi(n);return mi(t,e,i)};var fi=1,Kt=class extends X{constructor(e,i,r,o,s={}){super(e);this.coverArea=i,this.extraCovers=r,this.triggerArea=o,this.coverIsTrigger=!!s.coverIsTrigger,this.canReCover=!!s.canReCover,this.isUncovered=!1,this.revealState=0}playerCollidesCover(e){return this.coverArea.intersectsPoint(e.position)||this.extraCovers.some(i=>i.intersectsPoint(e.position))}isPlayerTriggering(e){return this.triggerArea.intersectsPoint(e.position)||this.coverIsTrigger&&this.playerCollidesCover(e)}isOpen(e){return this.canReCover?this.isPlayerTriggering(e):this.isUncovered?!0:(this.isUncovered=this.isPlayerTriggering(e),this.isUncovered)}onStart(e){super.onStart(e)}update(e,i,r){super.update(e,i,r);let o=this.isOpen(e);this.revealState=y(this.revealState+(o?1:-1)*(i/fi),0,1),this.lastPlayerPos=e.position}draw(e){if(super.draw(e),this.revealState===1)return;let i=e.dynamicWorldCanvas;if(this.revealState===0)i.setColor("black");else{let r=this.coverArea.width+this.coverArea.height,o=r*.2,s=this.lastPlayerPos?l.lerp(this.lastPlayerPos,this.coverArea.midpoint,this.revealState):this.coverArea.midpoint,a=(r+o)*this.revealState,c=i.createRadialGradient(s.x,s.y,Math.max(0,a-o/2),s.x,s.y,a+o/2);c.addColorStop(0,ft(0,0,0,0)),c.addColorStop(1,ft(0,0,0,255)),i.setColor(c)}this.coverArea.draw(i),this.extraCovers.forEach(r=>r.draw(i))}drawForMap(e){if(this.revealState!==1){e.setColor("black");for(let i of this.extraCovers.concat(this.coverArea))i.draw(e,.05)}}};var Xt=class{constructor(t,e,i){this.collider=t,this.key=e,this.nextLevelCollider=i||t}hasEntered(t){return this.collider.intersectsPoint(t.position)}translatePlayerToNext(t){return l.diff(t.position,new l(this.nextLevelCollider.x1,this.nextLevelCollider.y1))}};var gi=Symbol("Up"),wi=Symbol("Down"),bi=Symbol("Left"),Ci=Symbol("Right"),yi=Symbol("Jump"),Ei=Symbol("Interact"),vi=Symbol("Escape"),xi=Symbol("Map"),b={Down:wi,Escape:vi,Interact:Ei,Jump:yi,Left:bi,Right:Ci,Up:gi,Map:xi};var Ge={" ":b.Jump,escape:b.Escape,esc:b.Escape,Escape:b.Escape,Esc:b.Escape,w:b.Up,a:b.Left,s:b.Down,d:b.Right,e:b.Interact,m:b.Map};function ge(n){return window.TouchEvent&&n instanceof TouchEvent}var $=class{constructor(t,e,i=!1,r=!1){this.keyMap=t,this.mousePosition=e,this.leftClicking=i,this.rightClicking=r}getHorizontalAxis(){return+!!this.keyMap[b.Right]-+!!this.keyMap[b.Left]}getVerticalAxis(){return+!!this.keyMap[b.Down]-+!!this.keyMap[b.Up]}isPressed(t){return!!this.keyMap[t]}isLeftClicking(){return this.leftClicking}isRightClicking(){return this.rightClicking}static empty(){return new $({},new l(0,0))}},wt=class{constructor(){}isForKey(t){return!1}isClick(){return!1}isScroll(){return!1}},we=class extends wt{constructor(e){super();this.input=e}isForKey(e){return e===this.input}},jt=class extends wt{constructor(e,i){super();this.position=e,this.isRight=i}isClick(){return!0}isRightClick(){return this.isRight}},gt=class extends wt{constructor(e,i){super();this.delta=e,this.discrete=!!i}isScroll(){return!0}},Zt=class{constructor(t){this.leftClicking=!1,this.rightClicking=!1,this.isButtonDown={},this.listener=t,this.mousePosition=new l(0,0),this.canvas=document.getElementById("canvas")}setListener(t){this.listener=t}init(){let t=i=>{this.listener&&this.listener(new we(i))};document.addEventListener("keydown",i=>{if(i.repeat)return;let r=Ge[i.key];!r||(this.isButtonDown[r]=!0,t(r))}),document.addEventListener("keyup",i=>{let r=Ge[i.key];!r||(this.isButtonDown[r]=!1)}),this.canvas.addEventListener(B?"touchmove":"mousemove",i=>{this.mousePosition=this.toCanvasPosition(i)}),this.canvas.addEventListener(B?"touchstart":"mousedown",i=>{var s,a;B&&i.preventDefault(),this.mousePosition=this.toCanvasPosition(i);let r=ge(i)||i instanceof MouseEvent&&i.button===0,o=i instanceof MouseEvent&&i.button===2;r?((s=this.listener)==null||s.call(this,new jt(this.mousePosition,!1)),this.leftClicking=!0):o&&((a=this.listener)==null||a.call(this,new jt(this.mousePosition,!0)),this.rightClicking=!0)}),this.canvas.addEventListener(B?"touchend":"mouseup",i=>{let r=ge(i)||i instanceof MouseEvent&&i.button===0,o=i instanceof MouseEvent&&i.button===2;r?this.leftClicking=!1:o&&(this.rightClicking=!1)}),this.canvas.addEventListener("contextmenu",i=>{i.preventDefault()}),this.canvas.addEventListener(B?"touchend":"mouseleave",()=>{this.leftClicking=!1,this.rightClicking=!1}),this.canvas.addEventListener("wheel",i=>{var r;(r=this.listener)==null||r.call(this,new gt(i.deltaY))});let e=(i,r)=>{let o=document.getElementById(i);!o||(o.addEventListener("touchstart",s=>{var a;s.preventDefault(),typeof r=="function"?(a=this.listener)==null||a.call(this,r()):(this.isButtonDown[r]=!0,t(r))}),o.addEventListener("touchcancel",s=>{s.preventDefault(),typeof r=="function"||(this.isButtonDown[r]=!1)}),o.addEventListener("touchend",s=>{s.preventDefault(),typeof r=="function"||(this.isButtonDown[r]=!1)}))};e("left",b.Left),e("right",b.Right),e("jump",b.Jump),e("down",b.Down),e("map",b.Map),e("exit",b.Escape),e("zoom-in",()=>new gt(1,!0)),e("zoom-out",()=>new gt(-1,!0))}toCanvasPosition(t){let e=ge(t)?t.touches.item(0)||{clientX:0,clientY:0}:t;return l.scale(new l(e.clientX-this.canvas.offsetLeft+window.scrollX,e.clientY-this.canvas.offsetTop+window.scrollY),this.canvas.width/this.canvas.clientWidth*Le/he)}getInputState(){return new $(this.isButtonDown,this.mousePosition,this.leftClicking,this.rightClicking)}};var Yt=class{constructor(t,e,i){this.width=t,this.height=e,this.hue=Oe(i)}lerpFactor(t,e){return(t+1)/e.parallax.length}*iterateArea(t,e,i,r){let o=0;for(let s=0;s<t;s+=i){let a=0;for(let c=0;c<e;c+=r)yield[a,o,h.widthForm(s,c,i,r)],a++;o++}}prepareCanvas(t,e,i,r,o){let s=this.lerpFactor(e,t),a=10*4,c=new l(32*a,18*a),u=new l(this.width*a,this.height*a),p=l.lerp(c,u,s),f=t.parallax[e],g=l.lerp(i,r,s);f.setColor(st(this.hue,g.x,g.y)),o(f,p.x,p.y)}getBackgroundHSL(){return[this.hue,new l(.14,.64)]}getBackgroundColor(){let[t,{x:e,y:i}]=this.getBackgroundHSL();return st(t,e,i)}draw(t){let e=new l(.14,.64),i=new l(.3,.24);t.background.setColor(st(this.hue,e.x,e.y)),t.background.fillRect(0,0,t.background.width,t.background.height);for(let r of t.parallax)r.clear();this.prepareCanvas(t,0,e,i,(r,o,s)=>{for(let[a,c,u]of this.iterateArea(o,s,70,s))Math.random()>.95&&u.draw(r);for(let[a,c,u]of this.iterateArea(o,s,o,70))Math.random()>.95&&u.draw(r)}),this.prepareCanvas(t,1,e,i,(r,o,s)=>{for(let[a,c,u]of this.iterateArea(o,s,120,s))if(Math.random()>.9){r.setLineWidth(20*2),r.drawLine(u.x1,u.y1,u.x1,u.y2),r.drawLine(u.x2,u.y1,u.x2,u.y2);let f=10;r.setLineWidth(f*2);let g=Math.floor(Math.random()*240);for(let[x,V,R]of this.iterateArea(1,s,1,240)){let E=R.y1+g;r.drawLine(u.x1,E,u.x2,E);let I=20;r.outerCircleCorner(u.x2-20-I,E-f-I,20,0),r.outerCircleCorner(u.x1+20+I,E-f-I,20,Math.PI/2),r.outerCircleCorner(u.x1+20+I,E+f+I,20,Math.PI),r.outerCircleCorner(u.x2-20-I,E+f+I,20,Math.PI*3/2)}}}),this.prepareCanvas(t,2,e,i,(r,o,s)=>{let a=[],c=[];for(let u=0;u<o;u+=800)a.push(Math.random()*o);for(let u=0;u<s;u+=600)c.push(Math.random()*s);for(let[u,p,f]of this.iterateArea(o,s,50,50))(a.some(g=>f.xInRange(g))||c.some(g=>f.yInRange(g)))&&(r.setLineWidth(12),f.stroke(r),r.setLineWidth(6),Math.random()>.2&&r.drawLine(f.x1,f.y1,f.x2,f.y2),Math.random()>.2&&r.drawLine(f.x2,f.y1,f.x1,f.y2))}),this.prepareCanvas(t,3,e,i,(r,o,s)=>{for(let[a,c,u]of this.iterateArea(o,s,30,s))Math.random()>.92&&u.draw(r)})}updateCameras(t){let e=new l(0,0),i=t.camera;t.parallax.forEach((r,o)=>{t.parallaxCameras[o]=l.lerp(e,i,this.lerpFactor(o,t))})}};var Jt=1280/32,zi=h.centerForm(1280/2,720/2,C/2+S*8,C/2+S*8),$t=class{constructor(t,e,i,r,o,s,a,c,u,p,f){this.key=t,this.levelGrid=o,this.objects=s,this.player=a,this.exitTriggers=c,this.interactibles=u,this.entities=p,this.width=e,this.height=i,this.camera=this.getIdealCamera(),this.interactingWith=void 0,this.backgroundArtist=new Yt(e,i,r),this.drawnStatic=!1,this.playModeManager=void 0,this.worldPosition=f,this.visited=!1}start(t){this.onAwaken(),this.interactingWith=void 0,this.playModeManager=t,this.interactibles.forEach(e=>e.onStart(this)),this.entities.forEach(e=>e.onStart(this)),this.visited=!0,this.camera=this.getIdealCamera()}onAwaken(){this.drawnStatic=!1,this.interactibles.forEach(t=>t.onAwaken()),this.entities.forEach(t=>t.onAwaken())}addWithoutDuplicate(t){this.objects.find(({rect:e})=>e===t.rect)||this.objects.push(t)}emitEvent(t){this.playModeManager&&this.playModeManager.onLevelEvent(t)}feedPlayerInfo(t,e){e.key!==this.key&&console.error("Exit key mis-match");let i=e.translatePlayerToNext(t);this.player.position.x=i.x,this.player.position.y=i.y,this.player.velocity=t.velocity.copy(),this.camera=this.getIdealCamera()}update(t,e){var i;this.player.update(t,this.isPlayerActive()?e:$.empty(),this),this.interactibles.forEach(r=>{r.update(this.player,t,this)}),(i=this.interactingWith)!=null&&i.isAreaActive||this.closeCurrentPuzzle(),this.entities.forEach(r=>{r.update(this.player,t,this)}),this.interactingWith||this.updateCamera(t),this.updateExits()}isPlayerActive(){return!this.interactingWith}closeCurrentPuzzle(){this.interactingWith&&(this.emitEvent(new Ft(this.interactingWith.id)),this.interactingWith=void 0)}screenToWorldPos(t){return l.add(l.scale(t,1/(4*10)),this.camera)}onInput(t){var r;this.isPlayerActive()&&this.player.onInput(t);let e=t.isClick()&&!t.isRightClick(),i=t.isForKey(b.Interact);if(e||i)if(this.interactingWith)(i||!zi.intersectsPoint(t.position))&&this.closeCurrentPuzzle();else{let o=this.interactibles.find(s=>s.isAreaActive);if(o&&(i||((r=o.triggerArea)==null?void 0:r.intersectsPoint(this.screenToWorldPos(t.position))))){let a=o.onInteract();a&&(a.isOpenPuzzleEvent()||a.isOpenMapEvent())&&(this.interactingWith=o,this.emitEvent(a))}}else t.isForKey(b.Escape)&&this.closeCurrentPuzzle()}updateExits(){let t=this.exitTriggers.find(e=>e.hasEntered(this.player));t&&this.emitEvent(new Nt(t))}clampCamera(t){let e=new l(y(t.x,this.player.position.x-32+1,this.player.position.x-1),y(t.y,this.player.position.y-18+1,this.player.position.y-1));return new l(y(e.x,0,this.width-32),y(e.y,0,this.height-18))}getNaiveCamera(t=this.player.position){return new l(t.x-32/2,t.y-18/2)}getIdealCamera(t=this.player.position){return this.clampCamera(this.getNaiveCamera(t))}updateCamera(t){this.camera=this.clampCamera(l.lerp(this.camera,this.getNaiveCamera(l.add(this.player.position,new l(this.player.velocity.x*.3,0))),t*2))}withSetupCanvas(t,e){t.saveTransform(),t.scale(Jt,Jt),e(t),t.restoreTransform()}drawForMap(t){t.setColor(this.backgroundArtist.getBackgroundColor()),t.fillRect(0,0,this.width,this.height);for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){let r=this.levelGrid[e][i];r===1?(t.setColor("black"),t.fillRect(i-.05,e-.05,1.1,1.1)):r===2&&(t.setColor("black"),t.fillRect(i-.05,e-.05,1.1,.2))}for(let e of this.interactibles)e.drawForMap(t);for(let e of this.entities)e.drawForMap(t)}draw(t){this.drawnStatic||(this.backgroundArtist.draw(t),this.withSetupCanvas(t.staticWorldCanvas,e=>{e.clear(),e.setColor("black");for(let i=0;i<this.height;i++)for(let r=0;r<this.width;r++){let o=this.levelGrid[i][r];o&&e.drawImage(ct,(o-1)*10,0,10,10,r,i,1,1)}}),t.uiCanvas.clear(),this.drawnStatic=!0),this.withSetupCanvas(t.dynamicWorldCanvas,e=>{e.clear(),this.withSetupCanvas(t.behindGroundCanvas,()=>{t.behindGroundCanvas.clear(),this.interactibles.forEach(i=>{i.draw(t)}),this.player.draw(e),this.entities.forEach(i=>{i.draw(t)})})}),t.setCamera(new l(Math.floor(this.camera.x*Jt),Math.floor(this.camera.y*Jt))),this.backgroundArtist.updateCameras(t)}};var be=class{constructor(){this.grid=[],this.shortGrid=[]}innerGet(t,e,i,r){return t in r||(r[t]=[]),e in r[t]||(r[t][e]=h.widthForm(e,t,1,i?.2:1)),r[t][e]}get(t,e,i=!1){return this.innerGet(t,e,i,i?this.shortGrid:this.grid)}},We=new be;var Ct=.8,te=16,ee=te/.3,Ce=2*ee,Pi=1.8*ee,Si=4,Fe=.6,He=4*Si/Fe,Li=He,Ne=2*He/Fe,Ri=.1,Qt=te*.5;function Mi(n){return!!n}var ie=class{constructor(t){this.position=t,this.collider=new m(t,Ct),this.velocity=new l(0,0),this.isDropping=!1,this.wantsToJump=!1,this.contactingAnyLedge=!1,this.inAirFor=1,this.state=2}onInput(t){t.isForKey(b.Jump)&&(this.wantsToJump=!0)}collideWithBlock(t,e,i){let r=!this.isDropping&&t===2&&this.velocity.y>=0&&this.position.y<e.y1,o=this.collider.intersectsRectangle(e);if(o&&t===2&&(this.contactingAnyLedge=!0,this.velocity.y<0&&this.position.y>=e.y1&&(this.isDropping=!0)),Y.isSolid(t)||r){if(o){let s=e.uncollideCircle(this.collider);this.velocity.add(l.scale(s,1/i)),s.x>0&&s.y===0?this.velocity.x=Math.max(0,this.velocity.x):s.x<0&&s.y===0&&(this.velocity.x=Math.min(0,this.velocity.x)),s.y>0&&s.x===0?this.velocity.y=Math.max(0,this.velocity.y):s.y<0&&s.x===0&&(this.velocity.y=Math.min(0,this.velocity.y)),this.position.add(s)}return this.collider.intersectsRectangle(e)}}update(t,e,i){let r=(v,P)=>{var H;return(H=i.levelGrid[Math.floor(P)])==null?void 0:H[Math.floor(v)]},o=(v,P)=>{let H=r(v,P);if(H)return{type:r(v,P),rect:We.get(Math.floor(P),Math.floor(v),H===2)}},s=e.getHorizontalAxis(),a=e.getVerticalAxis(),c=new l(s*ee,0);e.isPressed(b.Down)&&this.state!==1&&(this.isDropping=!0);let u=this.position.y+this.collider.radius,p=r(this.position.x,u),f=this.isDropping?Y.isSolid(p):Y.isGrounding(p),g=r(this.position.x,this.position.y),V=f&&u===Math.floor(u)||i.objects.some(({type:v,rect:P})=>(this.isDropping?Y.isSolid(v):Y.isGrounding(v))&&this.collider.isKissingBelow(P)),R=this.state===1&&g!==4;g===4&&a!==0?this.state=1:V?this.state=0:(!g||R)&&(R&&a<0&&(this.wantsToJump=!0),this.state=2);let E=(v,P,H)=>{if(W(v)){if(W(v)!==W(P))return-Pi*W(P)}else return-Math.min(Math.abs(P/t),H)*W(P);return 0};if(this.state===0)this.inAirFor=0,c.x+=E(s,this.velocity.x,Ce),this.velocity.y=0;else if(this.state===1)this.inAirFor=0,c.y=e.getVerticalAxis()*ee,c.x+=E(s,this.velocity.x,Ce),c.y+=E(a,this.velocity.y,Ce);else if(this.inAirFor+=t,g===3){let v=this.velocity.y>0?0:1.1;c.y-=Ne*v}else c.y+=Ne;this.inAirFor<Ri&&this.wantsToJump&&(this.wantsToJump=!1,this.velocity.y=-Li,this.state=2),this.velocity.add(l.scale(c,t)),this.state===1?(this.velocity.x=y(this.velocity.x,-Qt,Qt),this.velocity.y=y(this.velocity.y,-Qt,Qt)):this.velocity.x=y(this.velocity.x,-te,te);let I=l.scale(this.velocity,t);I.x=y(I.x,-Ct,Ct),I.y=y(I.y,-Ct,Ct),this.position.add(I);let{x:z,y:k}=this.position,zt=[o(z,k),o(z,k+1),o(z,k-1),o(z-1,k),o(z+1,k),o(z-1,k-1),o(z+1,k-1),o(z-1,k+1),o(z+1,k+1)].filter(Mi);this.contactingAnyLedge=!1,zt.concat(i.objects).forEach(({type:v,rect:P})=>{this.collideWithBlock(v,P,t)}),this.isDropping=this.isDropping&&this.contactingAnyLedge}draw(t){t.setColor("white"),this.collider.draw(t)}};var re=class{constructor(t,e,i,r,o){this.key=t,this.iid=e,this.width=i,this.height=r,this.bgColor=o,this.levelGrid=[],this.objects=[],this.playerPosition=new l(16,9),this.exitTriggers=[],this.interactibles=[],this.entities=[],this.worldPosition=new l(0,0)}addObjects(t){return this.objects=this.objects.concat(t),this}addExits(t){return this.exitTriggers=this.exitTriggers.concat(t),this}addInteractibles(t){return this.interactibles=this.interactibles.concat(t),this}addEntities(t){return this.entities=this.entities.concat(t),this}setPlayerPos(t){return this.playerPosition=t,this}setLevelGrid(t){this.levelGrid=t}makeGridSpace(){this.levelGrid=[];for(let t=0;t<this.height;t++)this.levelGrid.push([])}setWorldPosition(t){this.worldPosition=t}setCell(t,e,i){this.levelGrid[t][e]=i}create(){return new $t(this.key,this.width,this.height,this.bgColor,this.levelGrid,this.objects,new ie(this.playerPosition),this.exitTriggers,this.interactibles,this.entities,this.worldPosition)}};var oe=class extends X{constructor(e,i,r,o,s,a,c,u){super(e);this.position=i,this.width=r,this.height=o,this.tilesetPosition=s,this.tilesetWidth=a,this.tilesetHeight=c,this.scaling=u.includes("Scaling"),this.hasMobileAlt=u.includes("Mobile_alt")}draw(e){let i=e.behindGroundCanvas;if(this.scaling){i.drawImage(tt,this.tilesetPosition.x,this.tilesetPosition.y,this.tilesetWidth,10,this.position.x,this.position.y,this.width,1),i.drawImage(tt,this.tilesetPosition.x,this.tilesetPosition.y+this.tilesetHeight-10,this.tilesetWidth,10,this.position.x,this.position.y+this.height-1,this.width,1);let r=this.position.y+this.height-1,o=this.tilesetHeight/10-2;for(let s=this.position.y+1;s<this.position.y+this.height-1;s+=o){let a=Math.min(r-s,o);i.drawImage(tt,this.tilesetPosition.x,this.tilesetPosition.y+10,this.tilesetWidth,a*10,this.position.x,s,this.width,a)}}else i.drawImage(tt,this.tilesetPosition.x,this.tilesetPosition.y+(this.hasMobileAlt&&B?this.tilesetHeight:0),this.tilesetWidth,this.tilesetHeight,this.position.x,this.position.y,this.width,this.height)}};var ne=class extends D{constructor(e,i,r,o){super(e,i,void 0,r);this.puzzleId=o}onStart(e){super.onStart(e),this.puzzleId&&(this.puzzle=q.getPuzzle(this.puzzleId))}update(e,i,r){super.update(e,i,r),this.isEnabled||(this.puzzle?this.isEnabled=this.puzzle.hasBeenSolvedEver&&this.prereqsActive:this.isEnabled=this.prereqsActive)}draw(e){super.draw(e)}onInteract(){return new nt(this.puzzleId)}};var Ai="/data/world.json",_i="/data/puzzles.json";function Be(n){return fetch(n).then(t=>t.json())}function Ue(n,t){return n.find(e=>e.__identifier===t)}function Ee(n,t){return n.find(e=>e.iid===t)}function ye(n,t){return Ue(n.layerInstances,t)}function O(n){return Math.floor(n/10)}function se(n){return n/10}function Di(n){return O(n[0])+1}function G(n,t){var e;return(e=Ue(n.fieldInstances,t))==null?void 0:e.__value}function lt(n){return(G(n,"prerequisites")||[]).map(e=>e.entityIid)}function qe(n,t){var r;let e=(r=G(n,"triggerArea"))==null?void 0:r.entityIid,i=e?Ee(t,e):void 0;return i?yt(i):h.aroundPoint(new l(n.__grid[0]+2,n.__grid[1]+2),2,2)}function xe(n){return l.scale(new l(...n.px),1/10)}function ki(n,t){let e=n.iid,i=G(n,"key");i||console.warn("Puzzle with no key!");let r=new l(n.__grid[0]+2,n.__grid[1]+2),o={isFlipped:G(n,"isFlipped")};return new Ht(e,r,qe(n,t),lt(n),i,o)}function Ti(n,t){let e=n.iid;e||console.warn("Switch with no key!");let i=new l(n.__grid[0]+2,n.__grid[1]+2);return new Bt(e,i,qe(n,t),lt(n))}function Oi(n){let t=n.iid;t||console.warn("Door with no key!");let e=l.add(xe(n),new l(2,2));return new St(t,e,lt(n),O(n.height))}function Gi(n){let t=n.iid;t||console.warn("Trapdoor with no key!");let e=xe(n),i={isFlipped:G(n,"isFlipped"),hasLedge:G(n,"hasLedge"),isSingle:G(n,"isSingle")};return new Ut(t,e,lt(n),O(n.width),i)}var yt=n=>h.widthForm(se(n.px[0]),se(n.px[1]),O(n.width),O(n.height));function Vi(n){return!!n}function Wi(n,t){var c;let e=n.iid;e||console.warn("CoverEntity with no key!");let i=(c=G(n,"triggerArea"))==null?void 0:c.entityIid,r=Ee(t,i)||n,s=(G(n,"extraCover")||[]).map(u=>Ee(t,u.entityIid)).filter(Vi).map(yt),a={coverIsTrigger:G(n,"coverIsTrigger"),canReCover:G(n,"canReCover")};return new Kt(e,yt(n),s,yt(r),a)}function Ni(n){return new oe(n.iid,xe(n),O(n.width),O(n.height),new l(n.__tile.x,n.__tile.y),n.__tile.w,n.__tile.h,n.__tags)}function Fi(n){let t=n.iid,e=G(n,"key"),i=lt(n);return!e&&!i.length&&console.warn("Node with no key or prerequisites!"),new ne(t,yt(n).midpoint,i,e)}function Hi(n){let t=n.iid;return new ot(t,new l(se(n.px[0]),se(n.px[1])),lt(n))}function Bi(n){var a;let t=new re(n.identifier,n.iid,O(n.pxWid),O(n.pxHei),n.__bgColor);t.makeGridSpace();let e=ye(n,"Solid");for(let c of e.gridTiles){let u=O(c.px[0]),p=O(c.px[1]),f=Di(c.src);t.setCell(p,u,f)}let i=!1,o=ye(n,"EntityLayer").entityInstances;o.forEach(c=>{switch(c.__identifier){case"Util":break;case"PlayerStart":t.setPlayerPos(new l(c.__grid[0],c.__grid[1])),i=!0;break;case"PuzzleScreen":G(c,"key")||console.warn("Puzzle with unknown id in:",n.identifier),t.addInteractibles([ki(c,o)]);break;case"Switch":t.addInteractibles([Ti(c,o)]);break;case"Door":t.addInteractibles([Oi(c)]);break;case"Trapdoor":t.addInteractibles([Gi(c)]);break;case"CoverEntity":t.addEntities([Wi(c,o)]);break;case"Node":t.addInteractibles([Fi(c)]);break;case"Portal":t.addInteractibles([Hi(c)]);break;default:console.warn("Processing unknown entity type:",c.__identifier)}});let s=(a=ye(n,"Decorations"))==null?void 0:a.entityInstances;return s&&t.addEntities(s.map(Ni)),i||console.warn(`Level ${n.identifier} is missing a PlayerStart`),t.setWorldPosition(new l(O(n.worldX),O(n.worldY))),t}function Ui(n,t){let e=t[n.iid];for(let i of n.__neighbours){let r=i.levelIid,o=t[r],s=l.diff(o.worldPosition,e.worldPosition),a=h.widthForm(s.x,s.y,o.width,o.height);e.addExits([new Xt(a,o.key,a)])}return e.create()}function ve(n){if(typeof n=="string")return{isLeaf:!0,puzzle:q.getPuzzle(n),isAllSolved:!1};if(Array.isArray(n))return{isLeaf:!1,isAllSolved:!1,children:n.map(ve)};if(typeof n=="object"){let t=typeof n.children=="string";return t?{isLeaf:t,puzzle:q.getPuzzle(n.children),isAllSolved:!1,display:n.icon}:{isLeaf:t,isAllSolved:!1,children:n.children.map(ve),display:n.icon}}throw Error(`Building grouping from invalid items: ${JSON.stringify(n)}`)}var Z=class{static async fetchPuzzles(){let t=await Be(_i),{puzzlesByLevel:e,puzzlesGrouping:i}=t,r={};for(let o of Object.values(e))for(let s of Object.values(o))Object.assign(r,s);Z.puzzles=r;for(let o of Object.keys(r))q.insertPuzzle(o,r[o]);this.keyGrouping=ve(i)}static async fetchWorld(){let t=await Be(Ai);Z.data=t;let e={};t.levels.forEach(i=>{let r=Bi(i);e[r.iid]=r,e[r.key]=r}),t.levels.forEach(i=>{let r=Ui(i,e);Z.levelMap[r.key]=r})}static async start(){await Promise.all([Z.fetchPuzzles(),Z.fetchWorld()])}static getLevel(t){return Z.levelMap[t]}},N=Z;N.hasLoaded=!1,N.data=null,N.levelMap={},N.puzzles={};var qi=1/20,ae=class{constructor(t,e,i){this.screenManager=t,this.gameModeManager=e,this.inputManager=i,this.inputManager.setListener(r=>this.onInput(r)),this.lastFrameTime=performance.now()}start(){this.inputManager.init(),this.lastFrameTime=performance.now(),requestAnimationFrame(()=>this.mainLoop())}onInput(t){this.gameModeManager.onInput(t)}mainLoop(){let t=performance.now(),e=Math.min((t-this.lastFrameTime)/1e3,qi);this.gameModeManager.update(e,this.inputManager.getInputState()),this.gameModeManager.draw(this.screenManager),this.screenManager.drawToScreen(),requestAnimationFrame(()=>this.mainLoop()),this.lastFrameTime=t}};function Ie(n,t,e=.5){let i=Math.floor(Math.sqrt(t)),r=Math.ceil(t/i),o=i,s=n.width,a=n.height;function c(x){return(1+e)*x-e}function u(x){return x*(1+e)}let p=Math.min(s/c(o),a/c(r)),f=h.centerForm(n.midpoint.x,n.midpoint.y,p*c(o)/2,p*c(r)/2),g=[];for(let x=0;x<t;x++){let V=Math.floor(x/o),R=x%o;g.push(h.widthForm(p*u(R)+f.x1,p*u(V)+f.y1,p,p))}return g}function Ke(n,t,e){let i=t.width/2,r=new l(t.midpoint.x-i,t.midpoint.y-i);n.translate(r.x,r.y),n.setColor("white");let o=e.grid,s=i*2/(3*Math.max(o.length,o[0].length)+1),a=s*(3*o[0].length+1),c=s*(3*o.length+1),u=Math.max(0,(a-c)/2),p=Math.max(0,(c-a)/2);e.miniElements.forEach(({row:f,col:g,shape:x})=>{if(e.values[o[f][g].id]){let V=p+s*(3*x.x1+1),R=u+s*(3*x.y1+1),E=s*(3*x.width-1),I=s*(3*x.height-1);n.fillRect(V,R,E,I)}}),n.translate(-r.x,-r.y)}var Xe=(n,t,e)=>{if(e in me){let{shapes:i,inverted:r}=me[e];n.setColor("white");for(let o of i)if(o instanceof m){let s=l.add(t.midpoint,l.scale(o.position,t.width/2)),a=new m(s,o.radius*t.width/2);r?(n.setLineWidth(t.width/10),a.stroke(n)):a.draw(n)}else if(o instanceof h){let s=l.add(t.midpoint,l.scale(o.midpoint,t.width/2)),a=h.centerForm(s.x,s.y,o.width*t.width/4,o.height*t.width/4);r?(n.setLineWidth(t.width/10),a.stroke(n)):a.draw(n)}return!0}return!1};function Je(n,t){return n.map((e,i)=>[e,t[i]])}function je(n){return"puzzle"in n}function Ze(n){return"action"in n&&n.action==="back"}function Ye(n){return"action"in n&&n.action==="subgroup"}var Pe=h.centerForm(_/2,_/2,C/2,C/2);function ze(n,t){var r,o,s;if(!((r=n.children)!=null&&r.length)||n.isLeaf)throw Error("Drawing leaf to the screen");let e=Ie(Pe,n.children.length),i=[];for(let[a,c]of Je(n.children,e))a.isLeaf?i.push({box:c,isHovered:!1,puzzle:a.puzzle,display:a.display}):i.push({box:c,isHovered:!1,action:"subgroup",innerGrouping:a,childRects:Ie(c.inset(c.width/10),(s=(o=a.children)==null?void 0:o.length)!=null?s:0),display:a.display});return t&&i.push({box:new h(0,0,(_-C)/2,(_-C)/2),isHovered:!1,action:"back"}),i}var le=class{constructor(t){this.viewDirty=!0;this.gameModeManager=t,this.puzzleManager=q,this.overallGrouping=N.keyGrouping,this.groupStack=[this.overallGrouping],this.shapes=ze(this.overallGrouping,!1)}onStart(){}update(t,e){if(this.currentPuzzle)this.currentPuzzle.update(t,e);else if(!B)for(let i of this.shapes){let r=i.box.intersectsPoint(e.mousePosition);r!==i.isHovered&&(this.viewDirty=!0,i.isHovered=r)}}dismissCurrentPuzzle(){var t,e;if(!!this.currentPuzzle){this.viewDirty=!0;for(let i of this.groupStack.slice().reverse()){let r=!0;for(let o of(t=i.children)!=null?t:[])o.isAllSolved||((e=o.puzzle)==null?void 0:e.isSolved)||(r=!1);if(r)i.isAllSolved=!0;else break}this.currentPuzzle=void 0}}onInput(t){if(this.currentPuzzle){if(t.isClick()){let e=t;if(!Pe.intersectsPoint(e.position)){this.dismissCurrentPuzzle();return}}this.currentPuzzle.onInput(t)}else if(t.isClick()){let e=t;for(let i of this.shapes)if(i.box.intersectsPoint(e.position)){if(Ze(i)&&this.groupStack.length>1){this.goBackOneLevel();return}else if(Ye(i)){this.groupStack.push(i.innerGrouping),this.shapes=ze(i.innerGrouping,!0),this.viewDirty=!0;return}else if(je(i)){this.currentPuzzle=i.puzzle,this.currentPuzzle.open(1);return}}if(!Pe.intersectsPoint(e.position)){this.goBackOneLevel();return}}}clickedOutside(){this.currentPuzzle?this.dismissCurrentPuzzle():this.goBackOneLevel()}goBackOneLevel(){this.groupStack.length<=1||(this.groupStack.splice(this.groupStack.length-1,1),this.shapes=ze(this.groupStack[this.groupStack.length-1],this.groupStack.length>1),this.viewDirty=!0)}drawDisplayOption(t,e,i){if(Xe(t,e,i))return!0;if(i.match(/circle\-\d+/)){let o=parseInt(i.slice(7),10);if(0<=o&&o<=8){t.setColor("white");for(let s of A[o]){let a=l.add(e.midpoint,l.scale(s.position,e.width/2)),c=new m(a,s.radius*e.width/2);o===0?(t.setLineWidth(s.radius*e.width/2),t.strokeEllipse(e.midpoint.x,e.midpoint.y,s.radius*e.width*.75,s.radius*e.width*.75)):c.draw(t)}return!0}}return!1}drawGroupShapeContents(t,e){var i;if(!(e.display&&this.drawDisplayOption(t,e.box,e.display)))for(let[r,o]of Je(e.childRects,e.innerGrouping.children))t.setColor(o.isLeaf?(i=o.puzzle)!=null&&i.isSolved?F:K:o.isAllSolved?F:K),r.draw(t)}drawPuzzleShapeContents(t,e){e.display&&this.drawDisplayOption(t,e.box,e.display)||Ke(t,e.box,e.puzzle)}draw(t){if(t.background.setColor("black"),t.background.fillRect(0,0,t.background.width,t.background.height),this.currentPuzzle)this.currentPuzzle.draw(t,!0);else{if(!this.viewDirty)return;let e=t.uiCanvas;e.clear();for(let i of this.shapes){if(je(i))e.setColor(i.puzzle.isSolved?F:K),i.box.draw(e),this.drawPuzzleShapeContents(t.uiCanvas,i);else if(Ze(i)){e.setColor("white"),i.box.draw(e),e.setColor("black"),e.setLineWidth(S*2),e.setLineDash([]);let r=i.box.inset(i.box.width/5),o=r.midpoint;e.drawLine(r.x1,o.y,r.x2,o.y),e.drawLine(r.x1,o.y,o.x,r.y1),e.drawLine(r.x1,o.y,o.x,r.y2),e.fillDiamond(r.x1,o.y,S*Math.SQRT2,S*Math.SQRT2)}else Ye(i)&&(e.setColor(i.innerGrouping.isAllSolved?_e:De),i.box.draw(e),this.drawGroupShapeContents(e,i));if(i.isHovered){e.setLineWidth(i.box.width*.05),e.setColor("white");let r=i.box;e.setLineDash([]),e.strokeRect(r.x1,r.y1,r.width,r.height)}}this.viewDirty=!1}}};var ce=class{constructor(){this.puzzleMode=new le(this),this.currentMode=this.puzzleMode,this.puzzleMode.onStart()}update(t,e){this.currentMode.update(t,e)}switchToMode(t){this.currentMode=t,t.onStart()}onInput(t){let e=!1;this.currentMode,this.puzzleMode,e||this.currentMode.onInput(t)}draw(t){this.currentMode.draw(t)}};var d=Symbol("ctx"),Et=Symbol("canvas"),vt=class{constructor(t){this[Et]=t;let e=t.getContext("2d");if(!e)throw Error("Unable to get 2d context");e.imageSmoothingEnabled=!1,this[d]=e,this[d].fillStyle="black",this[d].strokeStyle="black",this.width=this[Et].width,this.height=this[Et].height}fillRect(t,e,i,r){this[d].fillRect(t,e,i,r)}clear(){this[d].clearRect(0,0,this.width,this.height)}strokeRect(t,e,i,r){this[d].strokeRect(t,e,i,r)}strokeRectInset(t,e,i,r,o){this.strokeRect(t+o,e+o,i-o*2,r-o*2)}fillEllipse(t,e,i,r){this[d].beginPath(),this[d].ellipse(t,e,i,r,0,0,2*Math.PI),this[d].fill()}fillTriangle(t,e,i,r){this[d].beginPath(),this[d].moveTo(t,e+r),this[d].lineTo(t+i,e+r),this[d].lineTo(t+i/2,e),this[d].fill()}strokeEllipse(t,e,i,r){this[d].beginPath(),this[d].ellipse(t,e,i,r,0,0,2*Math.PI),this[d].stroke()}fillDiamond(t,e,i,r){this[d].beginPath(),this[d].moveTo(t,e-r),this[d].lineTo(t+i,e),this[d].lineTo(t,e+r),this[d].lineTo(t-i,e),this[d].lineTo(t,e-r),this[d].fill()}outerCircleCorner(t,e,i,r){this[d].beginPath(),this[d].arc(t,e,i,r,r+Math.PI/2);let o=r+Math.PI/4;this[d].lineTo(t+W(Math.cos(o))*i,e+W(Math.sin(o))*i),this[d].fill()}drawLine(t,e,i,r){this[d].beginPath(),this[d].moveTo(t,e),this[d].lineTo(i,r),this[d].stroke()}drawQuadratic(t,e,i,r,o,s){this[d].beginPath(),this[d].moveTo(t,e),this[d].quadraticCurveTo(o,s,i,r),this[d].stroke()}scale(t,e){this[d].scale(t,e)}translate(t,e){this[d].translate(t,e)}setLineWidth(t){this[d].lineWidth=t}get lineWidth(){return this[d].lineWidth}setLineDash(t){this[d].setLineDash(t)}setColor(t){t!==this[d].fillStyle&&(this[d].fillStyle=t,this[d].strokeStyle=t)}setColorRGB(t,e,i,r=255){this.setColor(ft(t,e,i,r))}setColorHSLA(t,e,i,r=1){this.setColor(st(t,e,i,r))}createGradient(t,e,i,r){return this[d].createLinearGradient(t,e,i,r)}createRadialGradient(t,e,i,r,o,s){return this[d].createRadialGradient(t,e,i,r,o,s)}saveTransform(){this[d].save()}restoreTransform(){this[d].restore()}drawImage(t,e,i,r,o,s,a,c,u){let p;if(t instanceof vt)p=t[Et];else if(t instanceof Image){if(!t.complete)return;p=t}else throw Error("Drawing something unmanageable");this[d].drawImage(p,e,i,r,o,s,a,c,u)}static fromId(t){let e=document.getElementById(t);if(!e||!(e instanceof HTMLCanvasElement))throw new Error(`Could not find canvas with id: "${t}"`);return new vt(e)}static fromScratch(t,e){let i=document.createElement("canvas");return i.width=t,i.height=e,new vt(i)}},Q=vt;Et,d;var xt=Symbol("real-canvas");function Ki(){let n=document.getElementById("canvas");if(!(n instanceof HTMLCanvasElement))throw new Error("Could not find canvas");return n.width=_,n.height=_,n}var Se=class{constructor(){let t=new Q(Ki());if(!(t instanceof Q))throw Error("No canvas found!");this[xt]=t,this.background=Q.fromScratch(_,_),this.uiCanvas=Q.fromScratch(_,_)}drawCanvas(t,e=_,i=_){this[xt].drawImage(t,0,0,e,i,0,0,this[xt].width,this[xt].height)}drawToScreen(){this.drawCanvas(this.background),this.drawCanvas(this.uiCanvas)}static getInstance(){return this.instance?this.instance:new Se}},It=Se;xt,It.instance=null;var Xi=()=>{N.start().then(()=>{let t=new ce,e=new ae(new It,t,new Zt(()=>{}));e.start(),window.app=e;let i=document.getElementById("main");i&&i.addEventListener("click",r=>{r.target===i&&t.puzzleMode.clickedOutside()})})};window.onload=()=>{Xi()};})();
//# sourceMappingURL=index-simple.js.map
